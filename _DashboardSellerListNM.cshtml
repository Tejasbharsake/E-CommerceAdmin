@model IEnumerable<GSTECommerceLibrary.Admin.Admin>

<div class="container mt-4">
   
    <!-- Use unique IDs and classes for partial view -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <div id="sellerTable_partial_filter" class="dataTables_filter"></div>
        <div class="dt-buttons-partial"></div>
    </div>
    <table id="sellerTable_partial" class="table table-striped table-bordered dataTable datatable-export-partial">
        <thead>
            <tr>
                <th><input type="checkbox" id="selectAll_partial" /></th>
                <th>Sr No</th>
                <th>Seller Name</th>
                <th>Business Name</th>
                <th>Email</th>
                <th>Mobile No</th>
                <th>Number Of Products</th>
            </tr>
        </thead>
        <tbody>
            @{ int srNo = 1; }
            @foreach (var item in Model)
            {
                <tr>
                    <td><input type="checkbox" class="rowCheckbox" /></td>
                    <td>@srNo</td>
                    <td>@item.SellerName</td>
                    <td>@item.BusinessName</td>
                    <td>@item.Email</td>
                    <td>@($"+91 {item.Mobile}")</td>
                    <td>@item.NumberOfProductsRegistered</td>
                </tr>
                srNo++;
            }
        </tbody>
    </table>
</div>

<!-- Toast Notification HTML -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
    <div id="liveToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <span id="toastMessage"></span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<style>
    /* Export buttons styling - now right aligned */
    .dt-buttons-partial {
        order: 2; /* Make buttons appear second in flex container */
        margin-right: 10px !important;
    }

        .dt-buttons-partial .btn {
            background-color: white !important;
            border: 1px solid #007bff !important;
            padding: 8px 12px !important;
            margin-left: 5px !important; /* Changed from margin-right to margin-left */
            border-radius: 4px !important;
            box-shadow: none !important;
            height: 38px;
            color: #007bff !important; /* Blue text color */
        }

        .dt-buttons-partial .btn:hover {
            background-color: #f8f9fa !important;
        }

        .dt-buttons-partial .btn img {
            height: 16px;
            width: 16px;
            margin-right: 5px;
        }

    /* Search bar styling - now left aligned */
    .dataTables_filter {
        order: 1; /* Make search appear first in flex container */
        margin-bottom: 0 !important;
        margin-left: 10px !important;
    }

    /* Table styling */
    #sellerTable_partial th, #sellerTable_partial td {
        vertical-align: middle;
        text-align: center;
    }

    #selectAll_partial, #sellerTable_partial .rowCheckbox {
        width: 18px;
        height: 18px;
    }

    .dataTables_wrapper .dataTables_length {
        float: left !important;
    }

    .dataTables_wrapper .dataTables_info {
        float: left !important;
    }

    .dataTables_wrapper .dataTables_paginate {
        float: right !important;
    }

    /* Custom container styling */
    .d-flex.justify-content-between {
        align-items: flex-start !important;
    }





    #sellerTable_partial thead th {
        background-color: #2C3E50; /* Solid Navy */
        color: #FFFFFF; /* White text */
        font-weight: 600;
        text-align: center;
        padding: 5px;
        border-bottom: 2px solid #ddd;
        font-size: 14px; /* smaller text */
        height: 8px !important; /* fixed header height */
        font-family: 'Poppins', sans-serif; /* Added font */
        vertical-align: middle;
    }






    

    /* Reduce body row height */
    #sellerTable_partial tbody td {
        padding: 2px 5px !important;
        height: 5px !important;
        line-height: 1;
        font-size: 13px;
        text-align: center;
        font-family: 'Poppins', sans-serif; /* Added font */
        vertical-align: middle;
    }


    /* Target DataTables pagination buttons */
    #sellerTable_partial_paginate .pagination .page-link {
        padding: 2px 10px; /* smaller height & width */
        font-size: 12px; /* smaller text */
        min-width: 33px; /* button width */
    }
</style>

<script>
    $(document).ready(function () {
        // Use more specific selectors to avoid conflicts
        if ($.fn.DataTable.isDataTable('#sellerTable_partial')) {
            $('#sellerTable_partial').DataTable().destroy();
            $('.dt-buttons-partial').empty(); // Clear only partial view buttons
        }

        var table = $('#sellerTable_partial').DataTable({
            responsive: true,
            searching: true,
            paging: true,
            ordering: false,
            info: true,
            lengthChange: false,
            pageLength: 10,
            destroy: true,

            autoWidth: false,
            scrollX: false,
            language: {
                search: "Search:",
                searchPlaceholder: "Type to search..."
            },
            drawCallback: function () {

                var pageInfo = this.api().page.info();
                this.api().column(1, { page: 'current' }).nodes().each(function (cell, i) {
                    cell.innerHTML = pageInfo.start + i + 1;
                });

            },
          

            buttons: [
                {
                    extend: 'copy',
                    className: 'btn btn-sm',
                    text: '<img src="/Content/Document/Image/Copy.png" alt="Copy"style="width:16px; margin-right:4px;">',
                    attr: { title: 'Copy to clipboard' },
                    title: 'Seller List',
                    messageTop: 'Export Date: ' + getCurrentDateTime(),
                    exportOptions: {
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckbox').prop('checked');
                        },
                        columns: ':not(:first-child)',
                        format: {
                            body: function (data, row, column, node) {
                                // Fix Sr No for dynamic numbering
                                if (column === 0) { // Sr No column (after removing checkbox column)
                                    // Get all selected rows and find the current row's position
                                    var selectedRows = [];
                                    table.rows({ search: 'applied' }).nodes().each(function (rowNode, index) {
                                        if ($(rowNode).find('input.rowCheckbox').prop('checked')) {
                                            selectedRows.push(rowNode);
                                        }
                                    });

                                    // Find the index of current row in selected rows
                                    var currentRowIndex = selectedRows.indexOf(node.parentNode);
                                    return currentRowIndex + 1;
                                }
                                return data;
                            }
                        }
                    },
                    action: function (e, dt, button, config) {
                        if (getSelectedCount() === 0) {
                            showErrorToast('Please select at least one row to export');
                            return false;
                        }
                        $.fn.dataTable.ext.buttons.copyHtml5.action.call(this, e, dt, button, config);
                    }
                },
                {
                    extend: 'csv',
                    className: 'btn btn-sm',
                    text: '<img src="/Content/Document/Image/CSV.png" alt="CSV"style="width:16px; margin-right:4px;">',
                    attr: { title: 'Export as CSV file' },
                    title: 'Seller List',
                    messageTop: 'Export Date: ' + getCurrentDateTime(),
                    exportOptions: {
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckbox').prop('checked');
                        },
                        columns: ':not(:first-child)',
                        format: {
                            body: function (data, row, column, node) {
                                // Fix Sr No for dynamic numbering
                                if (column === 0) { // Sr No column (after removing checkbox column)
                                    // Get all selected rows and find the current row's position
                                    var selectedRows = [];
                                    table.rows({ search: 'applied' }).nodes().each(function (rowNode, index) {
                                        if ($(rowNode).find('input.rowCheckbox').prop('checked')) {
                                            selectedRows.push(rowNode);
                                        }
                                    });

                                    // Find the index of current row in selected rows
                                    var currentRowIndex = selectedRows.indexOf(node.parentNode);
                                    return currentRowIndex + 1;
                                }
                                return data;
                            }
                        }
                    },
                    action: function (e, dt, button, config) {
                        if (getSelectedCount() === 0) {
                            showErrorToast('Please select at least one row to export');
                            return false;
                        }
                        $.fn.dataTable.ext.buttons.csvHtml5.action.call(this, e, dt, button, config);
                    }
                },
                {
                    extend: 'excel',
                    className: 'btn btn-sm',
                    text: '<img src="/Content/Document/Image/XLS.png" alt="Excel"style="width:16px; margin-right:4px;">',
                    attr: { title: 'Export as Excel file' },
                    title: 'Seller List',
                    messageTop: 'Export Date: ' + getCurrentDateTime(),
                    exportOptions: {
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckbox').prop('checked');
                        },
                        columns: ':not(:first-child)',
                        format: {
                            body: function (data, row, column, node) {
                                // Fix Sr No for dynamic numbering
                                if (column === 0) { // Sr No column (after removing checkbox column)
                                    // Get all selected rows and find the current row's position
                                    var selectedRows = [];
                                    table.rows({ search: 'applied' }).nodes().each(function (rowNode, index) {
                                        if ($(rowNode).find('input.rowCheckbox').prop('checked')) {
                                            selectedRows.push(rowNode);
                                        }
                                    });

                                    // Find the index of current row in selected rows
                                    var currentRowIndex = selectedRows.indexOf(node.parentNode);
                                    return currentRowIndex + 1;
                                }
                                return data;
                            }
                        }
                    },
                    action: function (e, dt, button, config) {
                        if (getSelectedCount() === 0) {
                            showErrorToast('Please select at least one row to export');
                            return false;
                        }
                        $.fn.dataTable.ext.buttons.excelHtml5.action.call(this, e, dt, button, config);
                    }
                },
                {
                    extend: 'pdf',
                    className: 'btn btn-sm',
                    text: '<img src="/Content/Document/Image/PDFicon.png" alt="PDF" style="width:16px; margin-right:4px;">',
                    attr: { title: 'Export as PDF file' },
                    filename: 'Seller List ' + new Date().toISOString().slice(0, 10),
                    title: 'Seller List',
                    orientation: 'landscape',
                    pageSize: 'A4',
                    action: function (e, dt, button, config) {
                        if (getSelectedCount() === 0) {
                            showErrorToast('Please select at least one row to export');
                            return false;
                        }
                        // ✅ Pass dt instance to config so customize can use it
                        config.customizeDataTable = dt;
                        $.fn.dataTable.ext.buttons.pdfHtml5.action.call(this, e, dt, button, config);
                    },
                    exportOptions: {
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckbox').prop('checked');
                        },
                        columns: ':not(:first-child)',
                        format: {
                            body: function (data, row, column, node) {
                                // Fix Sr No for dynamic numbering
                                if (column === 0) { // Sr No column (after removing checkbox column)
                                    // Get all selected rows and find the current row's position
                                    var selectedRows = [];
                                    table.rows({ search: 'applied' }).nodes().each(function (rowNode, index) {
                                        if ($(rowNode).find('input.rowCheckbox').prop('checked')) {
                                            selectedRows.push(rowNode);
                                        }
                                    });
                                    // Find the index of current row in selected rows
                                    var currentRowIndex = selectedRows.indexOf(node.parentNode);
                                    return currentRowIndex + 1;
                                }

                                const $td = $(node).closest('td');
                                if ($td.attr('data-order')) {
                                    const displayText = $td.text().trim();
                                    return displayText || data;
                                }
                                return data;
                            }
                        }
                    },
                    customize: function (doc, config) {
                        // ✅ Get dt reference back from config
                        var dt = config.customizeDataTable;

                        // Remove default title
                        doc.content.splice(0, 1);

                        // ✅ Count all selected records across ALL pages using dt reference
                        var totalRecords = dt.rows().nodes().to$()
                            .find('input.rowCheckbox:checked').length;

                        // Add custom header with company name and report details
                        doc.content.unshift({
                            margin: [0, 0, 0, 12],
                            table: {
                                widths: ['*', '*', '*'],
                                body: [
                                    [
                                        { text: '', border: [false, false, false, false] },
                                        { text: 'Rahi Shop', alignment: 'center', fontSize: 16, bold: true, border: [false, false, false, false] },
                                        { text: '', border: [false, false, false, false] }
                                    ],
                                    [
                                        { text: '', border: [false, false, false, false] },
                                        { text: 'Seller List', alignment: 'center', fontSize: 14, bold: true, border: [false, false, false, false] },
                                        { text: `Generated On: ${getCurrentDateTime()}\nTotal Records: ${totalRecords}`, alignment: 'right', fontSize: 10, italics: true, border: [false, false, false, false] }
                                    ]
                                ]
                            },
                            layout: 'noBorders'
                        });

                        // Set table column widths to be equal
                        var table = doc.content[1].table;
                        table.widths = Array(table.body[0].length).fill('*');

                        // Style table header
                        doc.styles.tableHeader.fillColor = '#007bff';
                        doc.styles.tableHeader.color = 'white';
                        doc.styles.tableHeader.alignment = 'center';
                        doc.styles.tableHeader.fontSize = 10;

                        // Set default font size for table content
                        doc.defaultStyle.fontSize = 9;

                        // Format table rows with proper alignment and serial numbering
                        var serial = 1;
                        doc.content[1].table.body.forEach(function (row, i) {
                            if (i > 0) { // Skip header row
                                row.forEach(function (cell, j) {
                                    if (j === 0) { // Serial number column
                                        cell.text = serial++;
                                        cell.alignment = 'center';
                                    } else {
                                        cell.alignment = 'center';
                                    }
                                });
                            }
                        });
                    }
                },


                {
                    extend: 'print',
                    className: 'btn btn-sm',
                    text: '<img src="/Content/Document/Image/Print.png" alt="Print"style="width:16px; margin-right:4px;">',
                    attr: { title: 'Print' },
                    title: 'Seller List',
                    messageTop: 'Export Date: ' + getCurrentDateTime(),
                    exportOptions: {
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckbox').prop('checked');
                        },
                        columns: ':not(:first-child)',
                        format: {
                            body: function (data, row, column, node) {
                                // Fix Sr No for dynamic numbering
                                if (column === 0) { // Sr No column (after removing checkbox column)
                                    // Get all selected rows and find the current row's position
                                    var selectedRows = [];
                                    table.rows({ search: 'applied' }).nodes().each(function (rowNode, index) {
                                        if ($(rowNode).find('input.rowCheckbox').prop('checked')) {
                                            selectedRows.push(rowNode);
                                        }
                                    });

                                    // Find the index of current row in selected rows
                                    var currentRowIndex = selectedRows.indexOf(node.parentNode);
                                    return currentRowIndex + 1;
                                }
                                return data;
                            }
                        }
                    },
                    action: function (e, dt, button, config) {
                        if (getSelectedCount() === 0) {
                            showErrorToast('Please select at least one row to export');
                            return false;
                        }
                        $.fn.dataTable.ext.buttons.print.action.call(this, e, dt, button, config);
                    }
                }
            ],
            language: {
                search: "Search:",
                searchPlaceholder: "Type to search...",
                paginate: {
                    next: 'Next',
                    previous: 'Previous'
                }
            },
            initComplete: function () {
                // Move buttons to the partial view's specific container
                this.api().buttons().container().appendTo($('.dt-buttons-partial'));

                // Manually set the placeholder attribute as fallback
                $('#sellerTable_partial_filter input[type="search"]').attr('placeholder', 'Type to search...');
                // Move search to the partial view's specific container
                $('#sellerTable_partial_filter').appendTo($('#sellerTable_partial_filter').parent());
            }
        });

        $('#selectAll_partial').on('click', function () {
            var rows = table.rows({ 'search': 'applied' }).nodes();
            $('input.rowCheckbox', rows).prop('checked', this.checked);
        });

        $('#sellerTable_partial tbody').on('change', 'input.rowCheckbox', function () {
            if (!this.checked) {
                $('#selectAll_partial').prop('checked', false);
            } else {
                var allChecked = $(this).closest('table').find('input.rowCheckbox:not(:checked)').length === 0;
                $('#selectAll_partial').prop('checked', allChecked);
            }
        });
    });

    function getSelectedCount() {
        return $('input.rowCheckbox:checked').length;
    }

    function showErrorToast(message) {
        $('#toastMessage').text(message);
        var toastEl = document.getElementById('liveToast');
        var toast = new bootstrap.Toast(toastEl);
        toast.show();
    }

    // Function to get current date and time in readable format
    function getCurrentDateTime() {
        var now = new Date();
        var day = String(now.getDate()).padStart(2, '0');
        var month = String(now.getMonth() + 1).padStart(2, '0');
        var year = now.getFullYear();
        var hours = String(now.getHours()).padStart(2, '0');
        var minutes = String(now.getMinutes()).padStart(2, '0');
        var seconds = String(now.getSeconds()).padStart(2, '0');

        return day + '/' + month + '/' + year + ' ' + hours + ':' + minutes + ':' + seconds;
    }
</script>