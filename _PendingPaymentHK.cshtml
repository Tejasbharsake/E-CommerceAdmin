@{
    var ds = ViewBag.OrderData as System.Data.DataSet;
    var dt = ds?.Tables.Count > 0 ? ds.Tables[0] : null;
    ViewBag.Title = "Pending Seller Payments";
}

<!-- CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
<!-- Daterangepicker CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker@3.1/daterangepicker.css" />
<link href="~/Content/Document/CSS/PendingSellerPayment.css" rel="stylesheet" />
<link href="~/Content/Document/CustomJS/all.min.css" rel="stylesheet" />

<!-- Date Range Filter Section -->
<div class="row mb-4">
    <div class="col-md-auto">
        <label class="form-label fw-semibold mb-1">Date Range Picker</label>
        <input class="form-control input-daterange-datepicker w-auto" type="text" name="daterange" autocomplete="off" placeholder="Select Date Range" />
    </div>
</div>

<style>
    .dt-button {
        display: inline-flex !important;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 5px 12px !important;
        font-size: 13px !important;
        font-weight: 500;
        border: 1px solid #0d6efd !important;
        background-color: transparent !important;
        color: #0d6efd !important;
        box-shadow: none !important;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    /* Pagination */
    .dataTables_wrapper .dataTables_paginate .paginate_button {
        padding: 2px 8px;
        margin: 0 2px;
        border-radius: 5px;
        border: 1px solid #dee2e6;
        background-color: #f8f9fa;
        color: #495057 !important;
        cursor: pointer;
    }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background-color: #0d6efd !important;
            color: white !important;
            border: 1px solid #0d6efd;
        }

    /* Export Buttons Transparent Fix */
    .dt-button,
    .dt-button:active,
    .dt-button:focus,
    .dt-button:hover {
        background: transparent !important;
        box-shadow: none !important;
    }
</style>

@if (dt != null && dt.Rows.Count > 0)
{
    <div class="table-responsive">
        <table id="table1" class="table table-bordered table-striped w-100">
            <thead>
                <tr>
                    <th style="font-size: 14px !important; text-align: center !important; background-color: #2C3E50 !important; color: #FFFFFF !important; font-weight: 600 !important; padding: 10px 8px !important; border-bottom: 2px solid #ddd !important; line-height: 1.4 !important; vertical-align: middle !important; white-space: nowrap !important;">
                        <input type="checkbox" id="selectAll" />
                    </th>
                    <th style="font-size: 14px !important; text-align: center !important; background-color: #2C3E50 !important; color: #FFFFFF !important; font-weight: 600 !important; padding: 10px 8px !important; border-bottom: 2px solid #ddd !important; line-height: 1.4 !important; vertical-align: middle !important; white-space: nowrap !important;">
                        Sr No
                    </th>
                    <th style="font-size: 14px !important; text-align: center !important; background-color: #2C3E50 !important; color: #FFFFFF !important; font-weight: 600 !important; padding: 10px 8px !important; border-bottom: 2px solid #ddd !important; line-height: 1.4 !important; vertical-align: middle !important; white-space: nowrap !important;">
                        Seller Name
                    </th>
                    <th style="font-size: 14px !important; text-align: center !important; background-color: #2C3E50 !important; color: #FFFFFF !important; font-weight: 600 !important; padding: 10px 8px !important; border-bottom: 2px solid #ddd !important; line-height: 1.4 !important; vertical-align: middle !important; white-space: nowrap !important;">
                        Total Orders
                    </th>
                    <th style="font-size: 14px !important; text-align: center !important; background-color: #2C3E50 !important; color: #FFFFFF !important; font-weight: 600 !important; padding: 10px 8px !important; border-bottom: 2px solid #ddd !important; line-height: 1.4 !important; vertical-align: middle !important; white-space: nowrap !important;">
                        Total Order Amount ₹
                    </th>
                    <th style="font-size: 14px !important; text-align: center !important; background-color: #2C3E50 !important; color: #FFFFFF !important; font-weight: 600 !important; padding: 10px 8px !important; border-bottom: 2px solid #ddd !important; line-height: 1.4 !important; vertical-align: middle !important; white-space: nowrap !important;">
                        Payment Date From
                    </th>
                    <th style="font-size: 14px !important; text-align: center !important; background-color: #2C3E50 !important; color: #FFFFFF !important; font-weight: 600 !important; padding: 10px 8px !important; border-bottom: 2px solid #ddd !important; line-height: 1.4 !important; vertical-align: middle !important; white-space: nowrap !important;">
                        Payment Date To
                    </th>
                    <th style="font-size: 14px !important; text-align: center !important; background-color: #2C3E50 !important; color: #FFFFFF !important; font-weight: 600 !important; padding: 10px 8px !important; border-bottom: 2px solid #ddd !important; line-height: 1.4 !important; vertical-align: middle !important; white-space: nowrap !important;">
                        Client Code
                    </th>
                    <th style="font-size: 14px !important; text-align: center !important; background-color: #2C3E50 !important; color: #FFFFFF !important; font-weight: 600 !important; padding: 10px 8px !important; border-bottom: 2px solid #ddd !important; line-height: 1.4 !important; vertical-align: middle !important; white-space: nowrap !important;">
                        Action
                    </th>
                </tr>
            </thead>
            <tbody>
                @{
                    int srNo = 1;
                    foreach (System.Data.DataRow row in dt.Rows)
                    {
                        var fromDate = Convert.ToDateTime(row["Payment Date From"]).ToString("yyyy-MM-dd");
                        var toDate = Convert.ToDateTime(row["Payment Date To"]).ToString("yyyy-MM-dd");
                        var amount = row["Total Order Amount"].ToString().Replace("â‚¹", "₹");
                        var clientCode = row["ClientCode"].ToString();
                        <tr data-from-date="@fromDate" data-to-date="@toDate">
                            <td style="text-align: center !important; font-size: 13px !important; padding: 8px !important; line-height: 1.4 !important; vertical-align: middle !important; white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important;">
                                <input type="checkbox" class="row-checkbox"
                                       value="@clientCode"
                                       data-from="@fromDate"
                                       data-to="@toDate" />
                            </td>
                            <td style="text-align: center !important; font-size: 13px !important; padding: 8px !important; line-height: 1.4 !important; vertical-align: middle !important; white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important;">
                                @srNo
                            </td>
                            <td style="text-align: center !important; font-size: 13px !important; padding: 8px !important; line-height: 1.4 !important; vertical-align: middle !important; white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important;">
                                @row["Seller Name"]
                            </td>
                            <td style="text-align: center !important; font-size: 13px !important; padding: 8px !important; line-height: 1.4 !important; vertical-align: middle !important; white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important;">
                                <a href="javascript:void(0);"
                                   class="viewOrders text-primary font-weight"
                                   data-clientcode="@clientCode"
                                   data-from="@fromDate"
                                   data-to="@toDate"
                                   title="View orders for this period">
                                    @row["Total Order"]
                                </a>
                            </td>
                            <td style="text-align: center !important; font-size: 13px !important; padding: 8px !important; line-height: 1.4 !important; vertical-align: middle !important; white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important;">
                                @amount
                            </td>
                            <td style="text-align: center !important; font-size: 13px !important; padding: 8px !important; line-height: 1.4 !important; vertical-align: middle !important; white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important;">
                                @Convert.ToDateTime(row["Payment Date From"]).ToString("dd-MM-yyyy")
                            </td>
                            <td style="text-align: center !important; font-size: 13px !important; padding: 8px !important; line-height: 1.4 !important; vertical-align: middle !important; white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important;">
                                @Convert.ToDateTime(row["Payment Date To"]).ToString("dd-MM-yyyy")
                            </td>
                            <td style="text-align: center !important; font-size: 13px !important; padding: 8px !important; line-height: 1.4 !important; vertical-align: middle !important; white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important;">
                                @clientCode
                            </td>
                            <td style="text-align: center !important; font-size: 13px !important; padding: 8px !important; line-height: 1.4 !important; vertical-align: middle !important; white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important;">
                                <button type="button" class="btn btn-pay btnPay btn-sm"
                                        data-clientcode="@clientCode"
                                        data-from="@fromDate"
                                        data-to="@toDate">
                                    Pay
                                </button>
                            </td>
                        </tr>
                        srNo++;
                    }
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="alert alert-warning text-center mt-4">
        No pending seller payments available.
    </div>
}

<!-- Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header text-white" style="background: #2C3E50;">
                <h5 class="modal-title" id="paymentModalLabel">Seller Payment Details</h5>
                <button type="button" class="btn-close btn-close-white" data-dismiss="modal">
                  
                </button>
            </div>
            <div class="modal-body" id="modalPaymentBody">
                <div class="text-center">Loading payment details...</div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification HTML -->
<div class="position-fixed end-0 p-3" style="z-index: 9999; top: 60px;">
    <div id="liveToast" class="toast align-items-center text-white bg-danger border-0"
         role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <span id="toastMessage"></span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<!-- Scripts (FIXED ORDER AND VERSIONS) -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/min/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
<script src="~/Content/Document/CustomJS/jszip.min.js"></script>
<script src="~/Content/Document/CustomJS/pdfmake.min.js"></script>
<script src="~/Content/Document/CustomJS/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.print.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker@3.1/daterangepicker.min.js"></script>

<script>
$(document).ready(function () {
    // Initialize Bootstrap tooltips
    $('[data-toggle="tooltip"]').tooltip({
        placement: 'top',
        trigger: 'hover'
    });

    // Calculate min and max dates from table data
    let minDate = null;
    let maxDate = null;

    function calculateDateRange() {
        let allDates = [];

        $('#table1 tbody tr').each(function() {
            var fromDateStr = $(this).data('from-date');
            var toDateStr = $(this).data('to-date');

            if (fromDateStr) {
                allDates.push(moment(fromDateStr, 'YYYY-MM-DD'));
            }
            if (toDateStr) {
                allDates.push(moment(toDateStr, 'YYYY-MM-DD'));
            }
        });

        if (allDates.length > 0) {
            minDate = moment.min(allDates);
            maxDate = moment.max(allDates);

            console.log('Calculated date range:', {
                minDate: minDate.format('DD-MM-YYYY'),
                maxDate: maxDate.format('DD-MM-YYYY')
            });

            $('#dateRangeInfo').text(`Available range: ${minDate.format('DD-MM-YYYY')} to ${maxDate.format('DD-MM-YYYY')}`);

            return { minDate: minDate, maxDate: maxDate };
        }

        return null;
    }

    // Calculate date range from table data
    var dateRange = calculateDateRange();

    $('.input-daterange-datepicker').daterangepicker({
        opens: 'right',
        locale: { format: 'MM/DD/YYYY' },
        startDate: dateRange ? dateRange.minDate : moment().subtract(30, 'days'),
        endDate: dateRange ? dateRange.maxDate : moment(),
        minDate: dateRange ? dateRange.minDate : moment().subtract(365, 'days'),
        maxDate: dateRange ? dateRange.maxDate : moment(),
        autoUpdateInput: false,
        ranges: {
            'Available Range': dateRange ? [dateRange.minDate, dateRange.maxDate] : [moment().subtract(30, 'days'), moment()],
            'Today': [moment(), moment()],
            'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
            'Last 7 Days': [moment().subtract(6, 'days'), moment()],
            'Last 30 Days': [moment().subtract(29, 'days'), moment()],
            'This Month': [moment().startOf('month'), moment().endOf('month')],
            'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
        }
    });

    $('.input-daterange-datepicker').on('apply.daterangepicker', function (ev, picker) {
        $(this).val(picker.startDate.format('MM/DD/YYYY') + ' - ' + picker.endDate.format('MM/DD/YYYY'));
        if (dateRange) {
            var selectedStart = picker.startDate;
            var selectedEnd = picker.endDate;

            if (selectedStart.isBefore(dateRange.minDate) || selectedEnd.isAfter(dateRange.maxDate)) {
                showErrorToast(`Please select dates within available range: ${dateRange.minDate.format('DD-MM-YYYY')} to ${dateRange.maxDate.format('DD-MM-YYYY')}`);
                picker.setStartDate(dateRange.minDate);
                picker.setEndDate(dateRange.maxDate);
                $(this).val(dateRange.minDate.format('MM/DD/YYYY') + ' - ' + dateRange.maxDate.format('MM/DD/YYYY'));
                return false;
            }

            if (selectedStart.isAfter(selectedEnd)) {
                showErrorToast('Start date cannot be after end date');
                picker.setStartDate(dateRange.minDate);
                picker.setEndDate(dateRange.maxDate);
                $(this).val(dateRange.minDate.format('MM/DD/YYYY') + ' - ' + dateRange.maxDate.format('MM/DD/YYYY'));
                return false;
            }
        }
        applyFilterLogic(picker);
    });

    $('.input-daterange-datepicker').on('cancel.daterangepicker', function (ev, picker) {
        $(this).val('');
        clearFilterLogic(picker);
    });

    function showErrorToast(message) {
        $('#toastMessage').text(message);
        $('#liveToast').removeClass('bg-success').addClass('bg-danger');
        try {
            var toastEl = document.getElementById('liveToast');
            var toast = new bootstrap.Toast(toastEl);
            toast.show();
        } catch (e) {
            console.warn('Toast error', e);
        }
    }

    function showSuccessToast(message) {
        $('#toastMessage').text(message);
        $('#liveToast').removeClass('bg-danger').addClass('bg-success');
        try {
            var toastEl = document.getElementById('liveToast');
            var toast = new bootstrap.Toast(toastEl);
            toast.show();
        } catch (e) {
            console.warn('Toast error', e);
        }
    }

    function applyFilterLogic(picker) {
        var startDate = picker.startDate.startOf('day');
        var endDate = picker.endDate.endOf('day');

        $.fn.dataTable.ext.search = [];

        $.fn.dataTable.ext.search.push(function (settings, data) {
            var paymentFrom = moment(data[5], 'DD-MM-YYYY');
            var paymentTo = moment(data[6], 'DD-MM-YYYY');

            if (!paymentFrom.isValid() || !paymentTo.isValid()) {
                return false;
            }

            return (paymentFrom.isBetween(startDate, endDate, null, '[]')) ||
                (paymentTo.isBetween(startDate, endDate, null, '[]')) ||
                (paymentFrom.isBefore(startDate) && paymentTo.isAfter(endDate));
        });

        table.draw();

        showSuccessToast(
            `Date filter applied! Showing data from ${startDate.format('DD-MM-YYYY')} to ${endDate.format('DD-MM-YYYY')}`
        );
    }

    function clearFilterLogic(picker) {
        $.fn.dataTable.ext.search = [];
        table.draw();

        if (dateRange) {
            picker.setStartDate(dateRange.minDate);
            picker.setEndDate(dateRange.maxDate);
        } else {
            picker.setStartDate(moment().subtract(30, 'days'));
            picker.setEndDate(moment());
        }

        showSuccessToast('Filter cleared successfully!');
    }

    function validateDateRange(startDate, endDate) {
        if (dateRange) {
            if (startDate.isBefore(dateRange.minDate) || endDate.isAfter(dateRange.maxDate)) {
                showErrorToast(`Selected dates are outside available range: ${dateRange.minDate.format('DD-MM-YYYY')} to ${dateRange.maxDate.format('DD-MM-YYYY')}`);
                return false;
            }
        }

        if (startDate.isAfter(endDate)) {
            showErrorToast('Start date cannot be after end date');
            return false;
        }

        if (startDate.isAfter(moment()) || endDate.isAfter(moment())) {
            showErrorToast('Cannot select future dates');
            return false;
        }

        return true;
    }

    (function removePathRef(){
        try {
            $('body').contents().filter(function(){
                return this.nodeType === 3 && this.nodeValue && this.nodeValue.trim() === '~/Views/Admin/PaymentManagmentHK.cshtml';
            }).remove();
            $('*').filter(function(){
                return $(this).children().length === 0 && $(this).text().trim() === '~/Views/Admin/PaymentManagmentHK.cshtml';
            }).remove();
        } catch (e) {
            console.warn('removePathRef error', e);
        }
    })();

    let selectedRows = new Set();
    let srNoCounter = 0;

    let table = $('#table1').DataTable({
        responsive: true,
        searching: true,
        scrollX: false,
        autoWidth: false,
        ordering: false,
        paging: true,
        lengthChange: false,
        pageLength: 10,
        lengthMenu: [5, 10, 25, 50, 100],
        ordering: false,
        info: true,
        dom: '<"top"<"float-left"l><"float-right"<"dtb-wrap"B><"dtf-wrap"f>>>rt<"bottom"ip><"clear">',
        buttons: [
            exportBtnConfig('copy', 'Copy.png', 'btn-info', 'Seller_Payments_', 'Copy to clipboard'),
            exportBtnConfig('csv', 'CSV.png', 'btn-success', 'Seller_Payments_', 'Export as CSV file'),
            exportBtnConfig('excel', 'XLS.png', 'btn-primary', 'Seller_Payments_', 'Export as Excel file'),
            exportBtnConfig('pdf', 'PDFicon.png', 'btn-danger', 'Seller_Payments_', 'Export as PDF file', true),
            exportBtnConfig('print', 'Print.png', 'btn-warning', '', 'Print')
        ],
        columnDefs: [
            { targets: [0,8], orderable: false, searchable: false }
        ]
    });

    // Add placeholder to search box
    $('#table1_filter input').attr('placeholder', 'Type to search...');

    function exportBtnConfig(type, iconFile, btnClass, filePrefix = '', tooltipText = '', isPdf = false) {
        return {
            extend: type,
            text: `<img src="/Content/Document/Image/${iconFile}" class="btn-icon" />`,
            className: `btn ${btnClass} ${type === 'print' ? 'text-dark' : 'text-white'}`,
            title: '',
            filename: filePrefix + new Date().toISOString().slice(0, 10),
            attr: {
                'data-toggle': 'tooltip',
                'title': tooltipText
            },
            orientation: isPdf ? 'landscape' : undefined,
            pageSize: isPdf ? 'A4' : undefined,
            exportOptions: {
                columns: [1, 2, 3, 4, 5, 6, 7],
                rows: function (idx, data, node) {
                    return $(node).find('.row-checkbox').is(':checked');
                },
                format: {
                    body: function (data, row, column, node) {
                        if (column === 0) {
                            srNoCounter++;
                            return srNoCounter;
                        }
                        return $(node).text().trim();
                    }
                }
            },
            action: function (e, dt, button, config) {
                var selectedRows = $('.table .row-checkbox:checked').length;
                var selectAllChecked = $('#selectAll').is(':checked');

                if (selectAllChecked) {
                    selectedRows = dt.rows().count();
                }

                if (selectedRows === 0) {
                    showErrorToast(`Please select at least one row to ${type}.`);
                    return;
                }
                srNoCounter = 0;
                const btnAction = $.fn.dataTable.ext.buttons[`${type}Html5`] || $.fn.dataTable.ext.buttons[type];
                btnAction.action.call(this, e, dt, button, config);
            },
            customize: isPdf ? function (doc) {
                var now = moment().format('DD-MM-YYYY HH:mm:ss');
                var downloadedEntries = $('.table .row-checkbox:checked').length;
                var selectAllChecked = $('#selectAll').is(':checked');
                if (selectAllChecked) {
                    downloadedEntries = table.rows().count();
                }

                var tableContent = null;
                for (var i = 0; i < doc.content.length; i++) {
                    if (doc.content[i].table) {
                        tableContent = doc.content[i];
                        break;
                    }
                }

                doc.content = [
                    {
                        text: 'Rahishop',
                        fontSize: 18,
                        bold: true,
                        alignment: 'center',
                        margin: [0, 10, 0, 5]
                    },
                    {
                        text: 'Pending Seller Payments',
                        fontSize: 14,
                        bold: true,
                        alignment: 'center',
                        margin: [0, 0, 0, 10]
                    },
                    {
                        columns: [
                            { text: '', width: '*' },
                            {
                                stack: [
                                    { text: 'Generated On: ' + now, fontSize: 10, alignment: 'right', margin: [0, 0, 0, 2] },
                                    { text: 'Total Entries: ' + downloadedEntries, fontSize: 10, alignment: 'right', bold: true }
                                ],
                                width: 'auto'
                            }
                        ],
                        margin: [0, 0, 0, 15]
                    }
                ];

                if (tableContent) {
                    doc.content.push(tableContent);
                }

                var objLayout = {
                    hLineWidth: function () { return 0; },
                    vLineWidth: function () { return 0; },
                    hLineColor: function () { return '#aaa'; },
                    vLineColor: function () { return '#aaa'; },
                    paddingLeft: function () { return 5; },
                    paddingRight: function () { return 5; }
                };

                doc.content.forEach(function (contentItem) {
                    if (contentItem.table) {
                        contentItem.layout = objLayout;
                        contentItem.table.widths = ['5%', '15%', '15%', '15%', '15%', '15%', '20%'];

                        if (contentItem.table.body && contentItem.table.body.length > 0) {
                            contentItem.table.body[0].forEach(function (cell) {
                                cell.fillColor = '#2E86C1';
                                cell.color = 'white';
                                cell.bold = true;
                                cell.fontSize = 11;
                            });
                        }
                    }
                });

                doc.defaultStyle = {
                    fontSize: 9
                };

                doc.styles = {
                    tableHeader: {
                        fontSize: 11,
                        fillColor: '#2E86C1',
                        color: 'white',
                        bold: true
                    }
                };

                doc.content.forEach(function (contentItem) {
                    if (contentItem.table) {
                        var body = contentItem.table.body;
                        for (var i = 1; i < body.length; i++) {
                            if (i % 2 === 0) {
                                body[i].forEach(function (cell) {
                                    cell.fillColor = '#F2F3F4';
                                });
                            }
                        }
                    }
                });

                doc.pageMargins = [30, 40, 30, 30];
            } : undefined
        };
    }

    $('#filterByDate').on('click', function() {
        var dateRangeValue = $('.input-daterange-datepicker').val();

        if (!dateRangeValue) {
            showErrorToast('Please select a date range to filter.');
            return;
        }

        var dates = dateRangeValue.split(' - ');
        if (dates.length !== 2) {
            showErrorToast('Invalid date range format.');
            return;
        }

        var startDate = moment(dates[0], 'MM/DD/YYYY');
        var endDate = moment(dates[1], 'MM/DD/YYYY');

        if (!validateDateRange(startDate, endDate)) {
            return;
        }

        var hasMatchingData = false;
        $('#table1 tbody tr').each(function() {
            var rowFromDate = moment($(this).data('from-date'), 'YYYY-MM-DD');
            var rowToDate = moment($(this).data('to-date'), 'YYYY-MM-DD');

            if ((rowFromDate >= startDate && rowFromDate <= endDate) ||
                (rowToDate >= startDate && rowToDate <= endDate) ||
                (rowFromDate <= startDate && rowToDate >= endDate)) {
                hasMatchingData = true;
                return false;
            }
        });

        if (!hasMatchingData) {
            showErrorToast('No data available for the selected date range. Please select a different range.');
            return;
        }

        if ($.fn.dataTable.ext.search.length > 0) {
            $.fn.dataTable.ext.search.pop();
        }

        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                var paymentDateFrom = moment(data[5], 'DD-MM-YYYY');
                var paymentDateTo = moment(data[6], 'DD-MM-YYYY');

                return (paymentDateFrom >= startDate && paymentDateFrom <= endDate) ||
                       (paymentDateTo >= startDate && paymentDateTo <= endDate) ||
                       (paymentDateFrom <= startDate && paymentDateTo >= endDate);
            }
        );

        table.draw();

        selectedRows.clear();
        $('#selectAll').prop('checked', false).prop('indeterminate', false);
        $('.row-checkbox').prop('checked', false);

        showSuccessToast(`Date filter applied successfully! Showing data from ${startDate.format('DD-MM-YYYY')} to ${endDate.format('DD-MM-YYYY')}`);
    });

    $('#clearFilter').on('click', function() {
        if ($.fn.dataTable.ext.search.length > 0) {
            $.fn.dataTable.ext.search.pop();
        }
        table.draw();

        if (dateRange) {
            $('.input-daterange-datepicker').data('daterangepicker').setStartDate(dateRange.minDate);
            $('.input-daterange-datepicker').data('daterangepicker').setEndDate(dateRange.maxDate);
        } else {
            $('.input-daterange-datepicker').data('daterangepicker').setStartDate(moment().subtract(30, 'days'));
            $('.input-daterange-datepicker').data('daterangepicker').setEndDate(moment());
        }

        selectedRows.clear();
        $('#selectAll').prop('checked', false).prop('indeterminate', false);
        $('.row-checkbox').prop('checked', false);

        showSuccessToast('Filter cleared successfully!');
    });

    $('#selectAll').on('change', function () {
        const isChecked = $(this).is(':checked');
        table.rows({ filter: 'applied' }).every(function () {
            const rowNode = this.node();
            $(rowNode).find('.row-checkbox').prop('checked', isChecked);
            if (isChecked) selectedRows.add(rowNode); else selectedRows.delete(rowNode);
        });
        updateRowStyles();
    });

    $(document).on('change', '.row-checkbox', function () {
        const $row = $(this).closest('tr');
        if ($(this).is(':checked')) selectedRows.add($row[0]);
        else {
            selectedRows.delete($row[0]);
            $('#selectAll').prop('checked', false).prop('indeterminate', false);
        }
        updateRowStyles();
        updateSelectAllCheckbox();
    });

    function updateRowStyles() { }

    function updateSelectAllCheckbox() {
        const visibleRows = table.rows({ filter: 'applied' }).count();
        const selectedVisibleCount = table.rows({ filter: 'applied' }).nodes().toArray().filter(row =>
            $(row).find('.row-checkbox').is(':checked')
        ).length;

        if (selectedVisibleCount === 0) $('#selectAll').prop('indeterminate', false).prop('checked', false);
        else if (selectedVisibleCount === visibleRows) $('#selectAll').prop('indeterminate', false).prop('checked', true);
        else $('#selectAll').prop('indeterminate', true);
    }

    table.on('draw', function() {
        updateSelectAllCheckbox();
    });

    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        modal.style.display = 'block';
        modal.classList.add('show');
        document.body.classList.add('modal-open');

        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        backdrop.id = 'modal-backdrop';
        document.body.appendChild(backdrop);
    }

    function hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        modal.style.display = 'none';
        modal.classList.remove('show');
        document.body.classList.remove('modal-open');

        const backdrop = document.getElementById('modal-backdrop');
        if (backdrop) {
            backdrop.remove();
        }

        $('#modalPaymentBody').html('<div class="text-center">Loading payment details...</div>');
    }

    $(document).on('click', '[data-dismiss="modal"]', function(e) {
        e.preventDefault();
        hideModal('paymentModal');
    });

    $(document).on('click', '.modal-backdrop', function() {
        hideModal('paymentModal');
    });

    $(document).on('keydown', function(e) {
        if (e.key === 'Escape') {
            hideModal('paymentModal');
        }
    });

    $(document).off('click', '.btnPay').on('click', '.btnPay', function (e) {
        e.preventDefault();
        e.stopPropagation();

        var clientCode = $(this).data('clientcode');
        var fromDate = $(this).data('from');
        var toDate = $(this).data('to');

        console.log('Pay button clicked:', { clientCode, fromDate, toDate });

        hideModal('paymentModal');

        setTimeout(function() {
            $('#modalPaymentBody').html(`
                <div class="text-center py-5">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-2">Loading payment details...</p>
                </div>
            `);

            showModal('paymentModal');

            $.ajax({
                url: '@Url.Action("OrderDetailsPartialHK", "Admin")',
                type: 'GET',
                data: {
                    clientCode: clientCode,
                    startDate: fromDate,
                    endDate: toDate
                },
                success: function(response) {
                    $('#modalPaymentBody').html(response);
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', { xhr, status, error });
                    $('#modalPaymentBody').html(`
                        <div class="alert alert-danger">
                            Error loading payment details. Please try again.
                        </div>
                    `);
                }
            });
        }, 200);
    });

    $(document).off('click', '.viewOrders').on('click', '.viewOrders', function (e) {
        e.preventDefault();

        var clientCode = $(this).data('clientcode');
        var fromDate = $(this).data('from');
        var toDate = $(this).data('to');

        console.log('Total Orders clicked:', { clientCode, fromDate, toDate });

        hideModal('paymentModal');

        setTimeout(function () {
            $('#modalPaymentBody').html(`
                <div class="text-center py-5">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-2">Loading order list...</p>
                </div>
            `);

            showModal('paymentModal');

            $.ajax({
                url: '@Url.Action("ClientOrderListPartialHK", "Admin")',
                type: 'GET',
                data: {
                    clientCode: clientCode,
                    startDate: fromDate,
                    endDate: toDate
                },
                success: function (response) {
                    $('#modalPaymentBody').html(response);
                },
                error: function (xhr, status, error) {
                    console.error('AJAX Error:', { xhr, status, error });
                    $('#modalPaymentBody').html(`
                        <div class="alert alert-danger">
                            Error loading order list. Please try again.
                        </div>
                    `);
                }
            });
        }, 200);
    });
});
</script>