@model IEnumerable<GSTECommerceLibrary.Admin.Admin>
@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Online Refund Orders</title>

    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet" />

    <!-- DataTables Buttons CSS -->
    <link href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.bootstrap5.min.css" rel="stylesheet" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

    <!-- Daterangepicker CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker@3.1/daterangepicker.css" />


    <link href="~/Content/Document/CSS/PendingRefundOrdersOnlineSG.css" rel="stylesheet" />

    <style>
        .modal-backdrop {
            background-color: transparent !important;
        }
        #refundTable_info {
            font-size: 14px !important; /* desired size */
            font-weight: normal !important; /* regular weight */
        }
        div.dataTables_wrapper div#refundTable_info {
            font-size: 16px !important;
            font-weight: normal !important; /* regular weight */
        }

    </style>

</head>
<body>
   






    <div class="controls-container d-flex align-items-center gap-3 flex-wrap">
        <div class="d-flex align-items-center gap-2">
            <label class="form-label fw-semibold mb-0">Date Range Picker:</label>
            <input class="form-control input-daterange-datepicker" type="text" name="daterange" placeholder="Select Date Range" autocomplete="off" style="width: 250px;" />
        </div>
        <div>
            <span id="selectedCount" class="selected-count"></span>
        </div>

        <div id="exportButtons" style="margin-bottom: 8px;"></div>
    </div>



    <div class="table-responsive">
        <table class="table table-bordered table-striped" id="refundTable">
            <thead>
                <tr>
                    <th>
                        <input type="checkbox" class="select-checkbox" id="selectAllCheckbox">
                    </th>
                    <th>Sr No</th>
                    <th>Order Code</th>
                    <th>Customer</th>
                    <th>Product</th>
                    <th>Amount (₹)</th>
                    <th>TransactionDate</th>
                    <th>TransactionID</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Any())
                {
                    int serialNumber = 1;
                    foreach (var item in Model)
                    {
                        <tr data-order="@item.OrderCode">
                            <td>
                                <input type="checkbox" class="select-checkbox row-checkbox">
                            </td>
                            <td>@serialNumber</td>
                            <td>@item.OrderCode</td>
                            <td>@item.CustomerName</td>
                            <td>@item.ProductName</td>
                            <td>@item.ProductAmount.ToString("0.00")</td>
                            <td data-order="@(item.TransactionDate?.ToString("yyyy-MM-dd") ?? "1900-01-01")">
                                @(item.TransactionDate?.ToString("dd/MM/yyyy") ?? "N/A")
                            </td>
                            <td>@item.TransactionId</td>
                            <td>
                                @if (string.IsNullOrEmpty(item.RefundStatus) || item.RefundStatus != "Completed")
                                {
                                    <button class="btn btn-sm btn-primary show-refund"
                                            data-transaction="@item.TransactionId"
                                            data-amount="@item.TransactionAmount"
                                            data-ordercode="@item.OrderCode">
                                        Refund
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-success btn-refunded" disabled>
                                        <i class="fas fa-check-circle"></i> Refunded
                                    </button>
                                }
                            </td>
                        </tr>
                        serialNumber++;
                    }
                }
                else
                {
                    <tr>
                        <td colspan="9" class="text-center">No refund orders found.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Refund Modal -->
    <div class="modal fade" id="razorpayRefundModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header text-white" style="background: #2C3E50">
                    <h5 class="modal-title">Online Refund </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>

                </div>
                <div class="modal-body">
                    <div id="refundForm">
                        <input type="hidden" id="razorpayTransactionId" />
                        <input type="hidden" id="razorpayAmount" />
                        <input type="hidden" id="razorpayOrderCode" />

                        <div class="mb-3">
                            <label class="form-label">Transaction ID</label>
                            <p class="form-control-plaintext fw-bold" id="displayTransactionId"></p>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Amount to Refund</label>
                            <p class="form-control-plaintext fw-bold" id="displayAmount"></p>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Order Code</label>
                            <p class="form-control-plaintext fw-bold" id="displayOrderCode"></p>
                        </div>
                    </div>

                    <div class="processing-animation" style="display:none;">
                        <div class="loader-dots">
                            <div class="dot"></div>
                            <div class="dot"></div>
                            <div class="dot"></div>
                        </div>
                        <p>Processing Razorpay refund (Test Mode)</p>
                        <i class="fas fa-check-circle success-check"></i>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="confirmRefund">
                        <i class="fas fa-check-circle"></i> Process Refund
                    </button>
                    @*<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times-circle"></i> Close
                        </button>*@
                </div>
            </div>
        </div>
    </div>


    <div class="position-fixed end-0 p-3" style="z-index: 11; top: 60px;">
        <div id="liveToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <span id="toastMessage"></span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>



    <!-- jQuery & Moment.js -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/min/moment.min.js"></script>

    <!-- Daterangepicker JS -->
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker@3.1/daterangepicker.min.js"></script>


    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

    <!-- DataTables Buttons JS -->
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.bootstrap5.min.js"></script>

    <!-- Downloaded CDN -->
    <script src="~/Content/Document/CustomJS/buttons.print.min.js"></script>
    <script src="~/Content/Document/CustomJS/buttons.html5.min.js"></script>
    <script src="~/Content/Document/CustomJS/jszip.min.js"></script>
    <script src="~/Content/Document/CustomJS/pdfmake.min.js"></script>
    <script src="~/Content/Document/CustomJS/vfs_fonts.js"></script>


    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>


        function showErrorToast(message) {
            var toastMessage = parent.document.getElementById('toastMessage');
            toastMessage.innerText = message;

            var toastEl = parent.document.getElementById('liveToast');
            toastEl.classList.remove('bg-success');
            toastEl.classList.add('bg-danger');

            var toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        function showSuccessToast(message) {
            var toastMessage = parent.document.getElementById('toastMessage');
            toastMessage.innerText = message;

            var toastEl = parent.document.getElementById('liveToast');
            toastEl.classList.remove('bg-danger');
            toastEl.classList.add('bg-success');

            var toast = new bootstrap.Toast(toastEl);
            toast.show();
        }



        let table;
        let selectedRows = new Set();

        $(document).ready(function () {

            $('.input-daterange-datepicker').daterangepicker({
                opens: 'right',
                autoUpdateInput: false,
                locale: {
                    format: 'MM/DD/YYYY',
                    cancelLabel: 'Clear',
                    applyLabel: 'Apply'
                },
                startDate: moment().subtract(30, 'days'),
                endDate: moment()
            });


            $('.input-daterange-datepicker').on('apply.daterangepicker', function (ev, picker) {
                $(this).val(picker.startDate.format('MM/DD/YYYY') + ' - ' + picker.endDate.format('MM/DD/YYYY'));
                filterByDate(picker.startDate, picker.endDate);
            });


            $('.input-daterange-datepicker').on('cancel.daterangepicker', function (ev, picker) {
                $(this).val('');
                clearDateFilter();
            });


            function filterByDate(startDate, endDate) {

                $.fn.dataTable.ext.search = [];


                $.fn.dataTable.ext.search.push(
                    function (settings, data, dataIndex) {
                        if (settings.nTable.id !== 'refundTable') return true;


                        var cell = table.row(dataIndex).nodes().to$().find('td:eq(6)');

                        var dateStr = cell.attr('data-order');

                        if (!dateStr || dateStr === '1900-01-01') return false;


                        var rowDate = moment(dateStr, 'YYYY-MM-DD');
                        return rowDate.isBetween(startDate, endDate, 'day', '[]');
                    }
                );
                table.draw();
            }


            function clearDateFilter() {
                $.fn.dataTable.ext.search.pop();
                table.draw();
            }


            let table = $('#refundTable').DataTable({
              
                responsive: true,
                searching: true,
                paging: true,
                ordering: false,
                info: true,
                lengthChange: false,
                pageLength: 10,
                destroy: true,
                autoWidth: false,
                scrollX: false,
                lengthMenu: [5, 10, 25, 50, 100],
                drawCallback: function () {

                    var pageInfo = this.api().page.info();
                    this.api().column(1, { page: 'current' }).nodes().each(function (cell, i) {
                        cell.innerHTML = pageInfo.start + i + 1;
                    });

                },
                order: [[6, 'desc']],
                language: {
                    search: "Search:",
                    searchPlaceholder: "Type to search"
                },
                dom: '<"row"<"col-sm-12 col-md-12"l><"col-sm-12 col-md-12"B>><"row"<"col-sm-12"f>><"row"<"col-sm-12"tr>><"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
              

                buttons: [
                    {
                        extend: 'copy',
                        text: '<img src="/Content/Document/Image/Copy.png" style="width:16px; height:16px;">',
                        attr: { title: 'Copy to Clipboard' }, 
                        /* className: 'btn btn-primary btn-sm',*/
                        action: function (e, dt, button, config) {
                            if ($('.row-checkbox:checked').length === 0) {
                                showErrorToast('Please select at least one row to export.');
                                return;
                            }
                            $.fn.dataTable.ext.buttons.copyHtml5.action.call(this, e, dt, button, config);
                        },
                        exportOptions: {
                            columns: ':not(:first-child):not(:last-child)',
                            rows: function (idx, data, node) {
                                return $(node).find('.row-checkbox').is(':checked');
                            },
                            format: {
                                body: function (data, row, column, node) {
                                    // Handle date column (TransactionDate - column 5 after removing first column)
                                    if (column === 5) {
                                        const $td = $(node).closest('td');
                                        if ($td.attr('data-order')) {
                                            return $td.text().trim() || data;
                                        }
                                    }
                                    return data;
                                }
                            }
                        },
                        customize: function (data, config) {
                            // Fix serial numbers for copy
                            var lines = data.split('\n');
                            var serialNumber = 1;

                            for (var i = 1; i < lines.length; i++) {
                                if (lines[i].trim() !== '') {
                                    var columns = lines[i].split('\t');
                                    if (columns.length > 0) {
                                        columns[0] = serialNumber++;
                                        lines[i] = columns.join('\t');
                                    }
                                }
                            }
                            return lines.join('\n');
                        }
                    },
                    {
                        extend: 'csv',
                        text: '<img src="/Content/Document/Image/CSV.png" style="width:16px; height:16px;">',
                        attr: { title: 'Export as CSV file' }, 
                        /* className: 'btn btn-info btn-sm',*/
                        action: function (e, dt, button, config) {
                            if ($('.row-checkbox:checked').length === 0) {
                                showErrorToast('Please select at least one row to export.');
                                return;
                            }
                            $.fn.dataTable.ext.buttons.csvHtml5.action.call(this, e, dt, button, config);
                        },
                        filename: 'Pending_Refund_Orders_Online_' + new Date().toISOString().slice(0, 10),
                        exportOptions: {
                            columns: ':not(:first-child):not(:last-child)',
                            rows: function (idx, data, node) {
                                return $(node).find('.row-checkbox').is(':checked');
                            },
                            format: {
                                body: function (data, row, column, node) {
                                    // Handle date column (TransactionDate - column 5 after removing first column)
                                    if (column === 5) {
                                        const $td = $(node).closest('td');
                                        if ($td.attr('data-order')) {
                                            return $td.text().trim() || data;
                                        }
                                    }
                                    return data;
                                }
                            }
                        },
                        customize: function (csv, config) {
                            // Fix serial numbers in CSV
                            var lines = csv.split('\n');
                            var serialNumber = 1;

                            for (var i = 1; i < lines.length; i++) {
                                if (lines[i].trim() !== '') {
                                    var columns = lines[i].split(',');
                                    if (columns.length > 0) {
                                        columns[0] = serialNumber++;
                                        lines[i] = columns.join(',');
                                    }
                                }
                            }
                            return lines.join('\n');
                        }
                    },
                    {
                        extend: 'excel',
                        text: '<img src="/Content/Document/Image/XLS.png" style="width:16px; height:16px;">',
                        attr: { title: 'Export as Excel file' }, 
                        /*className: 'btn btn-success btn-sm',*/
                        action: function (e, dt, button, config) {
                            if ($('.row-checkbox:checked').length === 0) {
                                showErrorToast('Please select at least one row to export.');
                                return;
                            }
                            $.fn.dataTable.ext.buttons.excelHtml5.action.call(this, e, dt, button, config);
                        },
                        filename: 'Pending_Refund_Orders_Online_' + new Date().toISOString().slice(0, 10),
                        title: 'Pending_Refund_Orders_Online',
                        exportOptions: {
                            columns: ':not(:first-child):not(:last-child)',
                            rows: function (idx, data, node) {
                                return $(node).find('.row-checkbox').is(':checked');
                            },
                            format: {
                                body: function (data, row, column, node) {
                                    // Handle date column (TransactionDate)
                                    if (column === 5) {
                                        const $td = $(node).closest('td');
                                        if ($td.attr('data-order')) {
                                            const displayText = $td.text().trim();
                                            return displayText || data;
                                        }
                                    }
                                    return data;
                                }
                            }
                        },
                        customize: function (xlsx) {
                            var sheet = xlsx.xl.worksheets['sheet1.xml'];
                            $('row c[r^="A"]', sheet).each(function (i) {
                                if (i === 1) $(this).find('v').text(1);
                                else if (i > 1) $(this).find('v').text(i - 1);
                            });
                        }
                    },
                    {
                        extend: 'pdf',
                        text: '<img src="/Content/Document/Image/PDFicon.png" style="width:16px; height:16px;">',
                        attr: { title: 'Export as PDF' }, 
                        /* className: 'btn btn-danger btn-sm',*/
                        action: function (e, dt, button, config) {
                            if ($('.row-checkbox:checked').length === 0) {
                                showErrorToast('Please select at least one row to export.');
                                return;
                            }


                            config.customizeDataTable = dt;

                            $.fn.dataTable.ext.buttons.pdfHtml5.action.call(this, e, dt, button, config);
                        },
                        filename: 'Pending_Refund_Orders_Online_' + new Date().toISOString().slice(0, 10),
                        title: 'Pending_Refund_Orders_Online',
                        orientation: 'landscape',
                        pageSize: 'A4',
                        exportOptions: {
                            columns: ':not(:first-child):not(:last-child)',
                            rows: function (idx, data, node) {
                                return $(node).find('.row-checkbox').is(':checked');
                            },
                            format: {
                                body: function (data, row, column, node) {
                                    
                                    if (column === 0) {
                                        return $('#refundTable tbody tr').index(node.parentNode) + 1;
                                    }
                                   
                                    if (column === 5) {
                                        const $td = $(node).closest('td');
                                        if ($td.attr('data-order')) {
                                            const displayText = $td.text().trim();
                                            return displayText || data;
                                        }
                                    }
                                    return data;
                                }
                            }
                        },
                        customize: function (doc, config) {
                           
                            var dt = config.customizeDataTable;

                            doc.content.splice(0, 1); 

                            
                            var totalRecords = dt.rows().nodes().to$()
                                .find('.row-checkbox:checked').length;

                         
                            doc.content.unshift({
                                margin: [0, 0, 0, 12],
                                table: {
                                    widths: ['*', '*', '*'],
                                    body: [
                                        [
                                            { text: '', border: [false, false, false, false] },
                                            { text: 'RahiShop', alignment: 'center', fontSize: 18, bold: true, border: [false, false, false, false] },
                                            { text: '', border: [false, false, false, false] }
                                        ],
                                        [
                                            { text: '', border: [false, false, false, false] },
                                            { text: 'Online Refund List', alignment: 'center', fontSize: 14, bold: true, border: [false, false, false, false] },
                                            { text: `Generated On: ${new Date().toLocaleString()} \nTotal Records: ${totalRecords}`, alignment: 'right', fontSize: 10, italics: true, border: [false, false, false, false] }
                                        ]
                                    ]
                                },
                                layout: 'noBorders'
                            });

                            
                            var table = doc.content[1].table;
                            table.widths = Array(table.body[0].length).fill('*');

                           
                            doc.styles.tableHeader.fillColor = '#007bff';
                            doc.styles.tableHeader.color = 'white';
                            doc.styles.tableHeader.alignment = 'center';
                            doc.styles.tableHeader.fontSize = 10;

                          
                            doc.defaultStyle.fontSize = 9;

                            
                            var serial = 1;
                            doc.content[1].table.body.forEach(function (row, i) {
                                if (i > 0) { 
                                    row.forEach(function (cell, j) {
                                        if (j === 0) { 
                                            cell.text = serial++;
                                            cell.alignment = 'center';
                                        } else {
                                            cell.alignment = 'center';
                                        }
                                    });
                                }
                            });
                        }
                    },

                    {
                        extend: 'print',
                        text: '<img src="/Content/Document/Image/Print.png" style="width:16px; height:16px;">',
                        attr: { title: 'Print' }, 
                        /*className: 'btn btn-secondary btn-sm',*/
                        action: function (e, dt, button, config) {
                            if ($('.row-checkbox:checked').length === 0) {
                                showErrorToast('Please select at least one row to export.');
                                return;
                            }
                            $.fn.dataTable.ext.buttons.print.action.call(this, e, dt, button, config);
                        },
                        title: 'Pending_Refund_Orders_Online',
                        exportOptions: {
                            columns: ':not(:first-child):not(:last-child)',
                            rows: function (idx, data, node) {
                                return $(node).find('.row-checkbox').is(':checked');
                            },
                            format: {
                                body: function (data, row, column, node) {
                                   
                                    if (column === 5) {
                                        const $td = $(node).closest('td');
                                        if ($td.is('[data-order]')) {
                                            return $td.text().trim();
                                        }
                                    }
                                    return data;
                                }
                            }
                        },
                        customize: function (win) {
                            $(win.document.body)
                                .css('font-size', '10pt')
                                .prepend(
                                    '<div style="text-align:center; margin-bottom: 20px;"><h2>Pending Refund Orders Online</h2><p>Generated on: ' + new Date().toLocaleDateString() + '</p></div>'
                                );

                            var $table = $(win.document.body).find('table');
                            $table.addClass('compact').css('font-size', '9pt');

                            
                            var serialNumber = 1;
                            $table.find('tbody tr').each(function () {
                                $(this).find('td:first').text(serialNumber++);
                            });
                        }
                    }
                ]
            });

            table.buttons().container().appendTo('#exportButtons');
            function forceTransparentButtons() {
                $('.dt-buttons button, .dt-buttons a').each(function () {

                    $(this).removeClass('btn-secondary btn-primary btn-success btn-info btn-warning btn-danger');


                    this.style.setProperty('background', 'transparent', 'important');
                    this.style.setProperty('background-color', 'transparent', 'important');
                    this.style.setProperty('background-image', 'none', 'important');
                    this.style.setProperty('border', '1px solid #0d6efd', 'important');
                    this.style.setProperty('border-radius', '4px', 'important');
                    this.style.setProperty('color', '#0d6efd', 'important');
                });
            }
            forceTransparentButtons();
            setTimeout(forceTransparentButtons, 100);
            setTimeout(forceTransparentButtons, 500);
            setTimeout(forceTransparentButtons, 1000);

            $('#selectAllCheckbox').on('change', function () {
                const isChecked = $(this).is(':checked');

                table.rows({ search: 'applied' }).every(function () {
                    const rowData = this.data();
                    const orderCode = rowData[2]; 
                    if (isChecked) {
                        selectedRows.add(orderCode);
                    } else {
                        selectedRows.delete(orderCode);
                    }
                    $(this.node()).find('.row-checkbox').prop('checked', isChecked);
                });

                updateRowStyles();
                updateSelectedCount();
            });




            $(document).on('change', '.row-checkbox', function () {
                const $row = $(this).closest('tr');
                const orderCode = $row.data('order');

                if ($(this).is(':checked')) {
                    selectedRows.add(orderCode);
                } else {
                    selectedRows.delete(orderCode);
                }

                updateRowStyles();
                updateSelectAllCheckbox();
                updateSelectedCount();
            });





            function updateSelectAllCheckbox() {
                const visibleRows = table.rows({ page: 'current' }).count();
                const selectedOnPage = table.rows({ page: 'current' }).nodes().to$()
                    .find('.row-checkbox:checked').length;

                if (selectedOnPage === 0) {
                    $('#selectAllCheckbox').prop('indeterminate', false).prop('checked', false);
                } else if (selectedOnPage === visibleRows) {
                    $('#selectAllCheckbox').prop('indeterminate', false).prop('checked', true);
                } else {
                    $('#selectAllCheckbox').prop('indeterminate', true).prop('checked', false);
                }
            }




            table.on('draw', function () {
                table.rows({ page: 'current' }).every(function () {
                    const rowData = this.data();
                    const orderCode = rowData[2];
                    const $checkbox = $(this.node()).find('.row-checkbox');

                    $checkbox.prop('checked', selectedRows.has(orderCode));
                    $(this.node()).toggleClass('selected', selectedRows.has(orderCode));
                });

                updateSelectAllCheckbox();
            });

            $(document).ready(function () {
                $('.input-daterange-datepicker').daterangepicker({
                    opens: 'right',
                    autoUpdateInput: false,
                    locale: {
                        format: 'MM/DD/YYYY',
                        cancelLabel: 'Clear',
                        applyLabel: 'Apply'
                    },
                    startDate: moment().subtract(30, 'days'),
                    endDate: moment()
                });


                $('.input-daterange-datepicker').on('apply.daterangepicker', function (ev, picker) {
                    $(this).val(picker.startDate.format('MM/DD/YYYY') + ' - ' + picker.endDate.format('MM/DD/YYYY'));
                    filterByDate(picker.startDate, picker.endDate);
                });


                $('.input-daterange-datepicker').on('cancel.daterangepicker', function (ev, picker) {
                    $(this).val('');
                    clearDateFilter();
                });
            });

            $('#clearDateFilter').on('click', function () {
                $.fn.dataTable.ext.search.pop();
                table.draw();
            });


            updateSelectedCount();
        });


        $(document).ready(function () {
            $(document).on('click', '.show-refund', function () {
                const $button = $(this);
                const transactionId = $button.data('transaction');
                const amount = $button.data('amount');
                const orderCode = $button.data('ordercode');

                $('#razorpayTransactionId').val(transactionId);
                $('#razorpayAmount').val(amount);
                $('#razorpayOrderCode').val(orderCode);

                $('#displayTransactionId').text(transactionId);
                $('#displayAmount').text('₹' + parseFloat(amount).toFixed(2));
                $('#displayOrderCode').text(orderCode);

                $('#refundForm').show();
                $('.processing-animation').hide();
                $('.success-check').hide();
                $('#confirmRefund').prop('disabled', false);

                var modal = new bootstrap.Modal(document.getElementById('razorpayRefundModal'));
                modal.show();
            });

            $('#confirmRefund').click(function () {
                const transactionId = $('#razorpayTransactionId').val();
                const amount = $('#razorpayAmount').val();
                const orderCode = $('#razorpayOrderCode').val();
                const $button = $('button[data-ordercode="' + orderCode + '"]');

                if (!transactionId || parseFloat(amount) <= 0 || !orderCode) {
                    alert("Invalid refund data.");
                    return;
                }

                $('#refundForm').hide();
                $('.processing-animation').show();
                $('#confirmRefund').prop('disabled', true);

                $.post('/Admin/ProcessRazorpayOnlineRefundSG', {
                    transactionId: transactionId,
                    amount: amount,
                    orderCode: orderCode
                }).done(function (response) {
                    $('.loader-dots').hide();
                    $('.processing-animation p').text('Refund Successful');
                    $('.success-check').show();

                    if (response.success) {
                        $button.removeClass('btn-warning show-refund')
                            .addClass('btn-success btn-refunded')
                            .html('<i class="fas fa-check-circle"></i> Refunded')
                            .prop('disabled', true)
                            .removeAttr('data-transaction data-amount data-ordercode');

                        setTimeout(function () {
                            var modalEl = document.getElementById('razorpayRefundModal');
                            var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                            modal.hide();
                        }, 1500);
                    }
                }).fail(function () {
                    $('.processing-animation').hide();
                    alert('Refund failed. Please try again.');
                    $('#confirmRefund').prop('disabled', false);
                });
            });


            $('#razorpayRefundModal').on('hidden.bs.modal', function () {
                $('#refundForm').show();
                $('.processing-animation').hide();
                $('#confirmRefund').prop('disabled', false)
                    .html('<i class="fas fa-check-circle"></i> Process Refund')
                    .removeClass('btn-primary')
                    .addClass('btn-success');
            });


        });
    </script>
</body>
</html>