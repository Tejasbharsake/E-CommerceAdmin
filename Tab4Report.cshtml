@model System.Data.DataTable
@using System.Data
@using Newtonsoft.Json

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Seller Report</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">

    <style>
        #sellerReportTable thead th {
            background-color: #2C3E50; /* Solid Navy */
            color: #FFFFFF; /* White text */
            font-weight: 600;
            text-align: center;
            padding: 5px;
            border-bottom: 2px solid #ddd;
            font-size: 14px; /* smaller text */
            height: 8px !important; /* fixed header height */
            font-family: 'Poppins', sans-serif; /* Added font */
            vertical-align: middle;
        }

        /* Reduce body row height */
        #sellerReportTable tbody td {
            padding: 2px 5px !important;
            height: 5px !important;
            line-height: 1;
            font-size: 13px;
            text-align: center;
            font-family: 'Poppins', sans-serif; /* Added font */
        }

        /* Target DataTables pagination buttons */
        #sellerReportTable .pagination .page-link {
            padding: 2px 10px; /* smaller height & width */
            font-size: 12px; /* smaller text */
            min-width: 33px; /* button width */
        }

        /* For second table */
        #clientProductTable thead th {
            background-color: #2C3E50; /* Solid Navy */
            color: #FFFFFF; /* White text */
            font-weight: 600;
            text-align: center;
            padding: 10px;
            border-bottom: 2px solid #ddd;
        }

        /* Reduce header height */
        #clientProductTable thead th {
            padding: 4px 8px !important; /* top/bottom, left/right */
            height: 14px !important; /* fixed header height */
            line-height: 1.3;
            font-size: 10px; /* smaller text */
        }

        /* Reduce body row height */
        #clientProductTable tbody td {
            padding: 2px 5px !important;
            height: 5px !important;
            line-height: 1;
            font-size: 13px;
            text-align: center;
            font-family: 'Poppins', sans-serif; /* Added font */
            vertical-align: middle;
        }

        /* Target DataTables pagination buttons */
        #clientProductTable .pagination .page-link {
            padding: 2px 10px; /* smaller height & width */
            font-size: 12px; /* smaller text */
            min-width: 33px; /* button width */
        }

        .btn-outline-primary, .btn-outline-info, .btn-outline-success, .btn-outline-danger, .btn-outline-dark {
            border-color: #007bff !important; /* Bootstrap primary blue */
        }

            .btn-outline-primary:hover, .btn-outline-info:hover, .btn-outline-success:hover,
            .btn-outline-danger:hover, .btn-outline-dark:hover {
                border-color: #0056b3 !important; /* Darker blue on hover */
            }

        .selected-row {
            background-color: #e3f2fd !important;
        }

        .row-checkbox {
            cursor: pointer;
        }

        #selectAllSeller, #selectAllClient {
            cursor: pointer;
        }

        .card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

            .card:hover {
                transform: translateY(-5px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
            }

        /* Modal header styling */
        #SellerDetailModal .modal-header {
            background: #2C3E50;
        }

        #SellerDetailModal .modal-title {
            color: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">

        <!-- Summary Cards Section -->
        <div class="row mb-4">
            <!-- 🔹 Total Sellers Card -->
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100" style="cursor:pointer;" id="openTotalSellers">
                    <div class="card-body text-center">
                        <div class="d-flex justify-content-center align-items-center mb-3">
                            <div class="rounded-circle bg-primary bg-opacity-10 p-3">
                                <i class="fas fa-users text-primary" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                        <h2 class="fw-bold text-primary mb-1" id="totalSellersCount">@ViewBag.TotalSellers</h2>
                        <h6 class="text-muted mb-0">Total Sellers</h6>
                    </div>
                </div>
            </div>

            <!-- Active Sellers Card -->
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100" style="cursor:pointer;" id="openActiveSellers">
                    <div class="card-body text-center">
                        <div class="d-flex justify-content-center align-items-center mb-3">
                            <div class="rounded-circle bg-success bg-opacity-10 p-3">
                                <i class="fas fa-user-check text-success" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                        <h2 class="fw-bold text-success mb-1" id="activeSellersCount">@ViewBag.TotalActiveSeller</h2>
                        <h6 class="text-muted mb-0">Active Sellers</h6>
                    </div>
                </div>
            </div>

            <!-- Inactive Sellers Card -->
            <div class="col-md-4">
                <div class="card border-0 shadow-sm h-100" style="cursor:pointer;" id="openInactiveSellers">
                    <div class="card-body text-center">
                        <div class="d-flex justify-content-center align-items-center mb-3">
                            <div class="rounded-circle bg-danger bg-opacity-10 p-3">
                                <i class="fas fa-user-times text-danger" style="font-size: 2rem;"></i>
                            </div>
                        </div>
                        <h2 class="fw-bold text-danger mb-1" id="inactiveSellersCount">@ViewBag.TotalInActiveSeller</h2>
                        <h6 class="text-muted mb-0">Inactive Sellers</h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- 🔹 UPDATED: Seller Detail Modal with DYNAMIC TITLE -->
        <!-- Seller Detail Modal (Updated to match Order Detail Modal design) -->
        <div class="modal fade" id="SellerDetailModal" tabindex="-1" aria-labelledby="sellerDetailModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header" style="background: #2C3E50; margin: 0; padding: 1rem 1.5rem;">
                        <h4 class="modal-title text-white" id="sellerDetailModalLabel">Seller Details</h4>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="Seller-detail-content">
                        <!-- Content will be loaded via AJAX -->
                    </div>
                </div>
            </div>
        </div>



        <!-- Export Buttons Row for Seller Report Table -->
        <div class="row mb-3 align-items-end">
            <div class="col-md-5">
                <!-- You can add filters here if needed -->
            </div>
            <div class="col-md-7 text-end mt-3 mt-md-0 d-flex gap-2 justify-content-md-end justify-content-start">
                <button class="btn btn-outline-primary btn-sm" id="copyBtnSeller" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy to clipboard">
                    <img src="~/Content/Document/Image/Copy.png" alt="Copy" width="16" height="16" />
                </button>
                <button class="btn btn-outline-info btn-sm" id="csvBtnSeller" data-bs-toggle="tooltip" data-bs-placement="top" title="Export as CSV file">
                    <img src="~/Content/Document/Image/CSV.png" alt="CSV" width="16" height="16" />
                </button>
                <button class="btn btn-outline-success btn-sm" id="excelBtnSeller" data-bs-toggle="tooltip" data-bs-placement="top" title="Export as Excel file">
                    <img src="~/Content/Document/Image/XLS.png" alt="Excel" width="16" height="16" />
                </button>
                <button class="btn btn-outline-danger btn-sm" id="pdfBtnSeller" data-bs-toggle="tooltip" data-bs-placement="top" title="Export as PDF file">
                    <img src="~/Content/Document/Image/PDFicon.png" alt="PDF" width="16" height="16" />
                </button>
                <button class="btn btn-outline-dark btn-sm" id="printBtnSeller" data-bs-toggle="tooltip" data-bs-placement="top" title="Print">
                    <img src="~/Content/Document/Image/Print.png" alt="Print" width="16" height="16" />
                </button>
            </div>
        </div>

        <!-- Seller Report DataTable -->
        <div class="card">
            <div class="card-header">
                <h4 class="card-title">Seller Report</h4>
            </div>
            <div class="card-body">
                @if (ViewBag.Error != null)
                {
                    <div class="alert alert-danger">@ViewBag.Error</div>
                }
                else if (Model != null && Model.Rows.Count > 0)
                {
                    <div class="table-responsive">
                        <table id="sellerReportTable" class="table table-striped table-bordered">
                            <thead>
                                <tr style="background: #2C3E50; color: white;">
                                    <th><input type="checkbox" id="selectAllSeller" /></th>
                                    <th>Sr No</th>
                                    @foreach (System.Data.DataColumn column in Model.Columns)
                                    {
                                        <th>@column.ColumnName</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    var srNo = 1;
                                }
                                @foreach (System.Data.DataRow row in Model.Rows)
                                {
                                    <tr>
                                        <td><input type="checkbox" class="row-checkbox" value="@srNo" /></td>
                                        <td>@srNo</td>
                                        @for (int i = 0; i < row.ItemArray.Length; i++)
                                        {
                                            var item = row.ItemArray[i];
                                            var columnName = Model.Columns[i].ColumnName.ToLower();

                                            <td>
                                                @if (columnName.Contains("status"))
                                                {
                                                    if (item.ToString().ToLower() == "active")
                                                    {
                                                        <span class="badge bg-success">@item</span>
                                                    }
                                                    else if (item.ToString().ToLower() == "inactive")
                                                    {
                                                        <span class="badge bg-danger">@item</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary">@item</span>
                                                    }
                                                }
                                                else
                                                {
                                                    @item
                                                }
                                            </td>
                                        }
                                    </tr>
                                    srNo++;
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="alert alert-info">No data found.</div>
                }
            </div>
        </div>

        <!-- Export Buttons Row for Client Product Table -->
        <div class="row mb-3 align-items-end">
            <div class="col-md-5">
                <!-- You can add filters here if needed -->
            </div>
            <div class="col-md-7 text-end mt-3 mt-md-0 d-flex gap-2 justify-content-md-end justify-content-start">
                <button class="btn btn-outline-primary btn-sm" id="copyBtnClient" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy to clipboard">
                    <img src="~/Content/Document/Image/Copy.png" alt="Copy" width="16" height="16" />
                </button>
                <button class="btn btn-outline-info btn-sm" id="csvBtnClient" data-bs-toggle="tooltip" data-bs-placement="top" title="Export as CSV file">
                    <img src="~/Content/Document/Image/CSV.png" alt="CSV" width="16" height="16" />
                </button>
                <button class="btn btn-outline-success btn-sm" id="excelBtnClient" data-bs-toggle="tooltip" data-bs-placement="top" title="Export as Excel file">
                    <img src="~/Content/Document/Image/XLS.png" alt="Excel" width="16" height="16" />
                </button>
                <button class="btn btn-outline-danger btn-sm" id="pdfBtnClient" data-bs-toggle="tooltip" data-bs-placement="top" title="Export as PDF file">
                    <img src="~/Content/Document/Image/PDFicon.png" alt="PDF" width="16" height="16" />
                </button>
                <button class="btn btn-outline-dark btn-sm" id="printBtnClient" data-bs-toggle="tooltip" data-bs-placement="top" title="Print">
                    <img src="~/Content/Document/Image/Print.png" alt="Print" width="16" height="16" />
                </button>
            </div>
        </div>

        <!-- Client Products Sold Chart & Table -->
        <div class="card">
            <div class="card-header">
                <h4 class="card-title">Client Product Sales Analysis</h4>
            </div>
            <div class="card-body">
                <div id="clientProductSoldChart" style="height:400px;"></div>
                <hr />
                <div class="table-responsive">
                    <table id="clientProductTable" class="table table-bordered table-striped">
                        <thead class="thead-dark">
                            <tr style="background: #2C3E50; color: white;">
                                <th><input type="checkbox" id="selectAllClient" /></th>
                                <th>Sr No</th>
                                <th>Client Name</th>
                                <th>Total Products Sold</th>
                            </tr>
                        </thead>
                        <tbody id="clientProductTableBody">
                            <tr><td colspan="4" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification HTML -->
    <div class="position-fixed end-0 p-3" style="z-index: 11; top: 60px;">
        <div id="liveToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <span id="toastMessage"></span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

    <!-- Highcharts -->
    <script src="https://code.highcharts.com/highcharts.js"></script>

    <!-- jsPDF CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script>
        (function () {
            // ===== GLOBAL VARIABLES =====
            var sellerDataTable;
            var clientProductTable;
            var allSellerTableData = [];
            var allClientTableData = [];
            var selectedSellerRowIds = new Set();
            var selectedClientRowIds = new Set();
            var sellerTableHeaders = [];
            var clientTableHeaders = [];
            var isClientTableInitialized = false;

            // ===== TOAST FUNCTIONS =====
            function showErrorToast(message) {
                console.log('Error Toast:', message);
                $('#toastMessage').text(message);
                $('#liveToast').removeClass('bg-success').addClass('bg-danger');
                var toastEl = document.getElementById('liveToast');
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }

            function showSuccessToast(message) {
                console.log('Success Toast:', message);
                $('#toastMessage').text(message);
                $('#liveToast').removeClass('bg-danger').addClass('bg-success');
                var toastEl = document.getElementById('liveToast');
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }

            // ===== MODAL CLICK HANDLERS =====
            $("#openTotalSellers").click(function () {
                console.log('Total sellers card clicked');
                openSellerModalWithTitle("Total Sellers", '@Url.Action("CardTotalSellerListANB", "Admin")');
            });

            $("#openActiveSellers").click(function () {
                console.log('Active sellers card clicked');
                openSellerModalWithTitle("Active Sellers", '@Url.Action("CardActiveSellerListANB", "Admin")');
            });

            $("#openInactiveSellers").click(function () {
                console.log('Inactive sellers card clicked');
                openSellerModalWithTitle("Inactive Sellers", '@Url.Action("CardInActiveSellerListANB", "Admin")');
            });

            function openSellerModalWithTitle(title, ajaxUrl) {
                $("#sellerDetailModalLabel").text(title);

                $.ajax({
                    url: ajaxUrl,
                    type: 'GET',
                    dataType: 'html',
                    cache: false,
                    beforeSend: function() {
                        $("#Seller-detail-content").html('<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i> Loading...</div>');
                    },
                    success: function (result) {
                        $("#Seller-detail-content").html(result);
                        var modal = new bootstrap.Modal(document.getElementById("SellerDetailModal"));
                        modal.show();
                    },
                    error: function (xhr, status, error) {
                        console.error("AJAX Error:", status, error, xhr.responseText);
                        $("#sellerDetailModalLabel").text("Error Loading " + title);
                        var serverMessage = xhr && xhr.responseText ? xhr.responseText : "Failed to load seller list.";
                        $("#Seller-detail-content").html("<div class='alert alert-danger'>" + serverMessage + "</div>");
                        var modal = new bootstrap.Modal(document.getElementById("SellerDetailModal"));
                        modal.show();
                    }
                });
            }

            // ===== UTILITY FUNCTIONS =====
            function storeTableData(tableId, allTableData, tableHeaders) {
                console.log(`Starting to store table data for ${tableId}...`);

                tableHeaders.length = 0;
                $(`#${tableId} thead tr th`).each(function (index) {
                    if (index > 0) {
                        tableHeaders.push($(this).text().trim());
                    }
                });
                console.log(`Headers stored for ${tableId}:`, tableHeaders);

                allTableData.length = 0;
                $(`#${tableId} tbody tr`).each(function () {
                    var rowData = [];
                    var rowId = $(this).find('.row-checkbox').val();

                    $(this).find('td').each(function (index) {
                        if (index > 0) {
                            var cellText = $(this).text().trim();
                            cellText = cellText.replace(/\s+/g, ' ');
                            rowData.push(cellText);
                        }
                    });

                    if (rowData.length > 0) {
                        allTableData.push({
                            id: rowId,
                            data: rowData
                        });
                    }
                });
                console.log(`Table data stored for ${tableId}:`, allTableData.length, 'rows');
            }

            function getSelectedRowsData(allTableData, selectedRowIds, tableHeaders) {
                console.log('Getting selected rows data...');
                var selectedData = [];

                allTableData.forEach(function(row) {
                    if (selectedRowIds.has(row.id)) {
                        selectedData.push(row.data);
                    }
                });

                console.log('Selected data found:', selectedData.length, 'rows');
                return { headers: tableHeaders, data: selectedData };
            }

            // ===== FIXED CHECKBOX FUNCTIONS (SAME AS WORKING VERSION) =====
            function initializeCheckboxes(tableId, selectAllId, allTableData, selectedRowIds) {
                console.log(`Initializing checkboxes for ${tableId}...`);

                // Remove any existing handlers first
                $(document).off('click', `#${selectAllId}`);
                $(document).off('change', `#${tableId} .row-checkbox`);

                // Select All functionality with event delegation
                $(document).on('click', `#${selectAllId}`, function (e) {
                    e.stopPropagation();
                    console.log(`Select All clicked for ${tableId}`);

                    var isChecked = $(this).is(':checked');

                    if (isChecked) {
                        allTableData.forEach(function(row) {
                            selectedRowIds.add(row.id);
                        });

                        $(`#${tableId} .row-checkbox`).each(function () {
                            $(this).prop('checked', true);
                            $(this).closest('tr').addClass('selected-row');
                        });

                        console.log(`All rows selected for ${tableId}:`, selectedRowIds.size);
                        showSuccessToast(`All ${allTableData.length} rows selected across all pages for ${tableId}`);
                    } else {
                        selectedRowIds.clear();

                        $(`#${tableId} .row-checkbox`).each(function () {
                            $(this).prop('checked', false);
                            $(this).closest('tr').removeClass('selected-row');
                        });

                        console.log(`All selections cleared for ${tableId}`);
                        showSuccessToast('All selections cleared');
                    }

                    updateSelectAllCheckbox(tableId, selectAllId, allTableData, selectedRowIds);
                });

                // Individual checkbox selection with event delegation
                $(document).on('change', `#${tableId} .row-checkbox`, function (e) {
                    e.stopPropagation();

                    var row = $(this).closest('tr');
                    var rowId = $(this).val();
                    var isChecked = $(this).is(':checked');

                    console.log(`Row checkbox changed for ${tableId}:`, rowId, 'checked:', isChecked);

                    if (isChecked) {
                        selectedRowIds.add(rowId);
                        row.addClass('selected-row');
                    } else {
                        selectedRowIds.delete(rowId);
                        row.removeClass('selected-row');
                    }

                    updateSelectAllCheckbox(tableId, selectAllId, allTableData, selectedRowIds);
                });

                // Maintain selections when changing pages
                $(`#${tableId} .row-checkbox`).each(function() {
                    var rowId = $(this).val();
                    if (selectedRowIds.has(rowId)) {
                        $(this).prop('checked', true);
                        $(this).closest('tr').addClass('selected-row');
                    } else {
                        $(this).prop('checked', false);
                        $(this).closest('tr').removeClass('selected-row');
                    }
                });

                updateSelectAllCheckbox(tableId, selectAllId, allTableData, selectedRowIds);
                console.log(`Checkbox initialization complete for ${tableId}`);
            }

            function updateSelectAllCheckbox(tableId, selectAllId, allTableData, selectedRowIds) {
                var totalRows = allTableData.length;
                var selectedCount = selectedRowIds.size;

                console.log(`Updating select all checkbox for ${tableId}. Total:`, totalRows, 'Selected:', selectedCount);

                var selectAllCheckbox = $(`#${selectAllId}`);

                if (selectedCount === 0) {
                    selectAllCheckbox.prop('checked', false).prop('indeterminate', false);
                } else if (selectedCount === totalRows) {
                    selectAllCheckbox.prop('checked', true).prop('indeterminate', false);
                } else {
                    selectAllCheckbox.prop('checked', false).prop('indeterminate', true);
                }
            }

            // ===== EXPORT FUNCTION (UNCHANGED) =====
            function exportTable(buttonId, exportType, allTableData, selectedRowIds, tableHeaders, filePrefix) {
                console.log(`${exportType} button clicked for ${buttonId}`);

                if (filePrefix === 'client' && !isClientTableInitialized) {
                    showErrorToast('Client product table is still loading. Please wait a moment and try again.');
                    return;
                }

                var result = getSelectedRowsData(allTableData, selectedRowIds, tableHeaders);
                if (result.data.length === 0) {
                    showErrorToast('Please select at least one row to export.');
                    return;
                }

                var exportHeaders = ['Sr No'];
                result.headers.forEach(function(header) {
                    if (header.toLowerCase() !== 'sr no' && header.toLowerCase() !== 'sr.no') {
                        exportHeaders.push(header);
                    }
                });

                if (exportType === 'copy') {
                    var copyText = exportHeaders.join('\t') + '\n';
                    result.data.forEach(function (row, index) {
                        var copyRow = [index + 1];
                        row.forEach(function(cell, cellIndex) {
                            var headerName = result.headers[cellIndex];
                            if (headerName && headerName.toLowerCase() !== 'sr no' && headerName.toLowerCase() !== 'sr.no') {
                                copyRow.push(cell);
                            }
                        });
                        copyText += copyRow.join('\t') + '\n';
                    });

                    navigator.clipboard.writeText(copyText).then(function () {
                        showSuccessToast('Data copied to clipboard! (' + result.data.length + ' rows)');
                    }).catch(function (err) {
                        console.error('Copy failed:', err);
                        showErrorToast('Copy failed. Please try again.');
                    });
                } else if (exportType === 'csv') {
                    var csvContent = exportHeaders.join(',') + '\n';
                    result.data.forEach(function (row, index) {
                        var csvRow = [index + 1];
                        row.forEach(function(cell, cellIndex) {
                            var headerName = result.headers[cellIndex];
                            if (headerName && headerName.toLowerCase() !== 'sr no' && headerName.toLowerCase() !== 'sr.no') {
                                csvRow.push('"' + cell.replace(/"/g, '""') + '"');
                            }
                        });
                        csvContent += csvRow.join(',') + '\n';
                    });

                    var blob = new Blob([csvContent], { type: 'text/csv' });
                    var url = window.URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = `${filePrefix}_report_${new Date().getTime()}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    showSuccessToast('CSV file downloaded! (' + result.data.length + ' rows)');
                } else if (exportType === 'excel') {
                    var excelContent = '<table border="1"><thead><tr>';
                    exportHeaders.forEach(function (header) {
                        excelContent += '<th>' + header + '</th>';
                    });
                    excelContent += '</tr></thead><tbody>';

                    result.data.forEach(function (row, index) {
                        excelContent += '<tr>';
                        excelContent += '<td>' + (index + 1) + '</td>';
                        row.forEach(function(cell, cellIndex) {
                            var headerName = result.headers[cellIndex];
                            if (headerName && headerName.toLowerCase() !== 'sr no' && headerName.toLowerCase() !== 'sr.no') {
                                excelContent += '<td>' + cell + '</td>';
                            }
                        });
                        excelContent += '</tr>';
                    });
                    excelContent += '</tbody></table>';

                    var blob = new Blob([excelContent], { type: 'application/vnd.ms-excel' });
                    var url = window.URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = `${filePrefix}_report_${new Date().getTime()}.xls`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    showSuccessToast('Excel file downloaded! (' + result.data.length + ' rows)');
                } else if (exportType === 'pdf') {
                    if (typeof window.jspdf === 'undefined') {
                        showErrorToast('jsPDF library is not loaded.');
                        return;
                    }

                    try {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF();

                        doc.setFont("helvetica", "bold");
                        doc.setFontSize(24);
                        doc.setTextColor(0, 0, 0);
                        const pageWidth = doc.internal.pageSize.getWidth();
                        doc.text("RahiShop", pageWidth / 2, 25, { align: 'center' });

                        doc.setFont("helvetica", "normal");
                        doc.setFontSize(16);
                        doc.setTextColor(80, 80, 80);
                        doc.text(filePrefix === 'seller' ? "Seller Management" : "Client Product Sales", pageWidth / 2, 35, { align: 'center' });

                        doc.setFontSize(10);
                        doc.setTextColor(100, 100, 100);

                        const currentDateTime = new Date().toLocaleString('en-GB', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                        }).replace(',', '');

                        doc.text("Generated On: " + currentDateTime, pageWidth - 15, 35, { align: 'right' });
                        doc.text("Total Records: " + result.data.length, pageWidth - 15, 42, { align: 'right' });

                        if (typeof doc.autoTable === 'function') {
                            var pdfData = [];
                            var pdfHeaders = ['Sr No'];
                            result.headers.forEach(function(header) {
                                if (header.toLowerCase() !== 'sr no' && header.toLowerCase() !== 'sr.no') {
                                    pdfHeaders.push(header);
                                }
                            });

                            result.data.forEach(function(row, index) {
                                var pdfRow = [index + 1];
                                row.forEach(function(cell, cellIndex) {
                                    var headerName = result.headers[cellIndex];
                                    if (headerName && headerName.toLowerCase() !== 'sr no' && headerName.toLowerCase() !== 'sr.no') {
                                        pdfRow.push(cell);
                                    }
                                });
                                pdfData.push(pdfRow);
                            });

                            doc.autoTable({
                                head: [pdfHeaders],
                                body: pdfData,
                                startY: 55,
                                styles: {
                                    fontSize: 8,
                                    cellPadding: 3,
                                    lineColor: [255, 255, 255],
                                    lineWidth: 0,
                                    textColor: [0, 0, 0],
                                    fontStyle: 'normal',
                                    valign: 'middle',
                                    overflow: 'linebreak',
                                    cellWidth: 'auto'
                                },
                                headStyles: {
                                    fillColor: [33, 150, 243],
                                    textColor: [255, 255, 255],
                                    fontStyle: 'bold',
                                    halign: 'center',
                                    valign: 'middle',
                                    fontSize: 9,
                                    cellPadding: 4,
                                    lineColor: [255, 255, 255],
                                    lineWidth: 0,
                                    minCellHeight: 8,
                                    maxCellHeight: 10
                                },
                                bodyStyles: {
                                    halign: 'center',
                                    valign: 'middle',
                                    fontSize: 8,
                                    lineColor: [255, 255, 255],
                                    lineWidth: 0,
                                    cellPadding: 2,
                                    minCellHeight: 6
                                },
                                alternateRowStyles: {
                                    fillColor: [248, 249, 250],
                                    lineColor: [255, 255, 255],
                                    lineWidth: 0
                                },
                                margin: {
                                    top: 10,
                                    right: 15,
                                    bottom: 15,
                                    left: 15
                                },
                                columnStyles: {
                                    0: {
                                        halign: 'center',
                                        valign: 'middle',
                                        cellWidth: 15,
                                        fontStyle: 'bold',
                                        lineColor: [255, 255, 255],
                                        lineWidth: 0
                                    }
                                },
                                theme: 'plain',
                                tableLineColor: [255, 255, 255],
                                tableLineWidth: 0
                            });
                        }

                        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '').replace('T', '_');
                        const filename = `RahiShop_${filePrefix}_Report_${timestamp}.pdf`;

                        doc.save(filename);
                        showSuccessToast('PDF generated successfully! (' + result.data.length + ' records)');

                    } catch (error) {
                        console.error('PDF Generation Error:', error);
                        showErrorToast('Error generating PDF: ' + error.message);
                    }
                } else if (exportType === 'print') {
                    var printContent = '<html><head><title>' + (filePrefix === 'seller' ? 'Seller Report' : 'Client Product Report') + '</title>';
                    printContent += '<style>body{font-family:Arial,sans-serif;margin:20px;}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #ddd;padding:8px;}th{background-color:#f2f2f2;text-align:center;}</style>';
                    printContent += '</head><body><h2>' + (filePrefix === 'seller' ? 'Seller Report' : 'Client Product Report') + '</h2>';
                    printContent += '<p>Generated: ' + new Date().toLocaleDateString() + ' | Records: ' + result.data.length + '</p>';
                    printContent += '<table><thead><tr>';

                    exportHeaders.forEach(function (header) {
                        printContent += '<th>' + header + '</th>';
                    });
                    printContent += '</tr></thead><tbody>';

                    result.data.forEach(function (row, index) {
                        printContent += '<tr><td>' + (index + 1) + '</td>';
                        row.forEach(function(cell, cellIndex) {
                            var headerName = result.headers[cellIndex];
                            if (headerName && headerName.toLowerCase() !== 'sr no' && headerName.toLowerCase() !== 'sr.no') {
                                printContent += '<td>' + cell + '</td>';
                            }
                        });
                        printContent += '</tr>';
                    });
                    printContent += '</tbody></table></body></html>';

                    var printWindow = window.open('', '_blank');
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    printWindow.print();
                    printWindow.close();

                    showSuccessToast('Print dialog opened! (' + result.data.length + ' rows)');
                }
            }

            // ===== DOCUMENT READY =====
            $(document).ready(function () {
                console.log('Document ready started...');

                // Initialize Seller Report Table
                if ($('#sellerReportTable').length > 0) {
                    storeTableData('sellerReportTable', allSellerTableData, sellerTableHeaders);

                    sellerDataTable = $('#sellerReportTable').DataTable({
                        paging: true,
                        pageLength: 10,
                        lengthChange: true,
                        lengthMenu: [10, 25, 50, 100],
                        searching: true,
                        ordering: false,
                        info: true,
                        autoWidth: false,
                        responsive: true,
                        language: {
                            search: "Search:",
                            searchPlaceholder: "Type to search"
                        },
                        columnDefs: [{ orderable: false, targets: 0, width: "50px" }],
                        drawCallback: function(settings) {
                            setTimeout(function() {
                                initializeCheckboxes('sellerReportTable', 'selectAllSeller', allSellerTableData, selectedSellerRowIds);
                            }, 100);
                        },
                        initComplete: function(settings, json) {
                            setTimeout(function() {
                                initializeCheckboxes('sellerReportTable', 'selectAllSeller', allSellerTableData, selectedSellerRowIds);
                            }, 200);
                        }
                    });
                }

                loadClientProductSoldData();

                // FIXED EXPORT BUTTON EVENTS WITH EVENT DELEGATION
                $(document).on('click', '#copyBtnSeller', function(e) {
                    e.preventDefault();
                    exportTable('copyBtnSeller', 'copy', allSellerTableData, selectedSellerRowIds, sellerTableHeaders, 'seller');
                });

                $(document).on('click', '#csvBtnSeller', function(e) {
                    e.preventDefault();
                    exportTable('csvBtnSeller', 'csv', allSellerTableData, selectedSellerRowIds, sellerTableHeaders, 'seller');
                });

                $(document).on('click', '#excelBtnSeller', function(e) {
                    e.preventDefault();
                    exportTable('excelBtnSeller', 'excel', allSellerTableData, selectedSellerRowIds, sellerTableHeaders, 'seller');
                });

                $(document).on('click', '#pdfBtnSeller', function(e) {
                    e.preventDefault();
                    exportTable('pdfBtnSeller', 'pdf', allSellerTableData, selectedSellerRowIds, sellerTableHeaders, 'seller');
                });

                $(document).on('click', '#printBtnSeller', function(e) {
                    e.preventDefault();
                    exportTable('printBtnSeller', 'print', allSellerTableData, selectedSellerRowIds, sellerTableHeaders, 'seller');
                });

                $(document).on('click', '#copyBtnClient', function(e) {
                    e.preventDefault();
                    exportTable('copyBtnClient', 'copy', allClientTableData, selectedClientRowIds, clientTableHeaders, 'client');
                });

                $(document).on('click', '#csvBtnClient', function(e) {
                    e.preventDefault();
                    exportTable('csvBtnClient', 'csv', allClientTableData, selectedClientRowIds, clientTableHeaders, 'client');
                });

                $(document).on('click', '#excelBtnClient', function(e) {
                    e.preventDefault();
                    exportTable('excelBtnClient', 'excel', allClientTableData, selectedClientRowIds, clientTableHeaders, 'client');
                });

                $(document).on('click', '#pdfBtnClient', function(e) {
                    e.preventDefault();
                    exportTable('pdfBtnClient', 'pdf', allClientTableData, selectedClientRowIds, clientTableHeaders, 'client');
                });

                $(document).on('click', '#printBtnClient', function(e) {
                    e.preventDefault();
                    exportTable('printBtnClient', 'print', allClientTableData, selectedClientRowIds, clientTableHeaders, 'client');
                });

                console.log('All initialization complete');
            });

            function loadClientProductSoldData() {
                $.ajax({
                    url: '@Url.Action("GetClientProductSoldChartData", "Admin")',
                    type: 'GET',
                    success: function (data) {
                        if (data && data.length > 0) {
                            var categories = [];
                            var seriesData = [];
                            var tableRows = '';
                            var srNo = 1;

                            $.each(data, function (i, item) {
                                categories.push(item.ClientName);
                                seriesData.push(parseInt(item.TotalProductSold));
                                tableRows += `<tr>
                                    <td><input type="checkbox" class="row-checkbox" value="${srNo}" /></td>
                                    <td>${srNo}</td>
                                    <td>${item.ClientName}</td>
                                    <td class="text-center">${item.TotalProductSold}</td>
                                </tr>`;
                                srNo++;
                            });

                            $('#clientProductTableBody').html(tableRows);

                            storeTableData('clientProductTable', allClientTableData, clientTableHeaders);

                            if ($.fn.DataTable.isDataTable('#clientProductTable')) {
                                $('#clientProductTable').DataTable().destroy();
                            }

                            clientProductTable = $('#clientProductTable').DataTable({
                                paging: true,
                                pageLength: 5,
                                lengthChange: true,
                                lengthMenu: [5, 10, 25, 50],
                                searching: true,
                                ordering: true,
                                info: true,
                                autoWidth: false,
                                responsive: true,
                                order: [[3, 'desc']],
                                columnDefs: [{ orderable: false, targets: 0, width: "50px" }],
                                language: {
                                    search: "Search clients:",
                                    searchPlaceholder: "Type to search"
                                },
                                drawCallback: function(settings) {
                                    setTimeout(function() {
                                        initializeCheckboxes('clientProductTable', 'selectAllClient', allClientTableData, selectedClientRowIds);
                                    }, 100);
                                },
                                initComplete: function(settings, json) {
                                    isClientTableInitialized = true;
                                    setTimeout(function() {
                                        initializeCheckboxes('clientProductTable', 'selectAllClient', allClientTableData, selectedClientRowIds);
                                    }, 200);
                                }
                            });

                            Highcharts.chart('clientProductSoldChart', {
                                chart: { type: 'column', backgroundColor: 'transparent' },
                                title: { text: 'Client Product Sales Report' },
                                xAxis: { categories: categories },
                                yAxis: { min: 0, title: { text: 'Total Products Sold' } },
                                plotOptions: {
                                    column: {
                                        colorByPoint: true,
                                        colors: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'],
                                        cursor: 'pointer'
                                    }
                                },
                                series: [{
                                    name: 'Products Sold',
                                    data: seriesData,
                                    cursor: 'pointer'
                                }]
                            });
                        } else {
                            $('#clientProductTableBody').html('<tr><td colspan="4" class="text-center">No data available</td></tr>');
                            isClientTableInitialized = true;
                        }
                    },
                    error: function () {
                        $('#clientProductTableBody').html('<tr><td colspan="4" class="text-center text-danger">Error loading data</td></tr>');
                        isClientTableInitialized = true;
                    }
                });
            }
        })();
    </script>
</body>
</html>