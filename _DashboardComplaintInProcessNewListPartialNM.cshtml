@model IEnumerable<GSTECommerceLibrary.Admin.Admin>

<div class="container mt-4">


    <!-- Custom container for search and buttons -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <div id="complaintTable_filter" class="dataTables_filter"></div>
        <div class="dt-buttons-Partial"></div>
    </div>

    <div class="table-responsive">
        <table id="complaintTable_Partial" class="table table-striped table-bordered dataTable datatable-export">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAllComplaints_Partial" /></th>
                    <th>Sr No</th>
                    <th>Support Ticket Id</th>
                    <th>Customer Code</th>
                    <th>Order Code</th>
                    <th>Issue Category</th>
                    <th>Subject</th>
                    <th>Registered Date</th>

                </tr>
            </thead>
            <tbody>
                @{ int srNo = 1; }
                @foreach (var item in Model)
                {
                    <tr>
                        <td><input type="checkbox" class="rowCheckboxComplaint" /></td>
                        <td>@srNo</td>
                        <td>@item.SupportTicketId</td>
                        <td>@item.CustomerCode</td>
                        <td>@item.OrderCode</td>
                        <td>@item.IssueCategory</td>
                        <td>@item.Subject</td>
                        <td>@item.RegisteredDate.ToString("dd-MM-yyyy")</td>
                    </tr>
                    srNo++;
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Toast Notification HTML -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
    <div id="liveToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <span id="toastMessage"></span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<style>
    /* Export buttons styling - right aligned */
    .dt-buttons-Partial {
        order: 2;
        margin-right: 10px !important;
    }

        .dt-buttons-Partial .btn {
            background-color: white !important;
            border: 1px solid #007bff !important;
            padding: 8px 12px !important;
            margin-left: 5px !important;
            border-radius: 4px !important;
            box-shadow: none !important;
            height: 38px;
        }

            .dt-buttons-Partial .btn:hover {
                background-color: #f8f9fa !important;
            }

            .dt-buttons-Partial .btn img {
                height: 16px;
                width: 16px;
                margin-right: 5px;
            }

    /* Search bar styling */
    .dataTables_filter {
        order: 1;
        margin-bottom: 0 !important;
        margin-left: 10px !important;
    }

    /* Table styling */
    #complaintTable_Partial th, #complaintTable_Partial td {
        vertical-align: middle;
        text-align: center;
    }

    /* Checkbox styling */
    #selectAllComplaints_Partial, .rowCheckboxComplaint {
        width: 18px;
        height: 18px;
    }

    /* Responsive table container */
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    #complaintTable_Partial thead th {
        background-color: #2C3E50; /* Solid Navy */
        color: #FFFFFF; /* White text */
        font-weight: 600;
        text-align: center;
        padding: 5px;
        border-bottom: 2px solid #ddd;
        font-size: 14px; /* smaller text */
        height: 8px !important; /* fixed header height */
        font-family: 'Poppins', sans-serif; /* Added font */
        vertical-align: middle;
    }


    /* Reduce body row height */
    #complaintTable_Partial tbody td {
        padding: 2px 5px !important;
        height: 5px !important;
        line-height: 1;
        font-size: 13px;
        text-align: center;
        font-family: 'Poppins', sans-serif; /* Added font */
        vertical-align: middle;
    }


    /* Target DataTables pagination buttons */
    #complaintTable_Partial_paginate .pagination .page-link {
        padding: 2px 10px; /* smaller height & width */
        font-size: 12px; /* smaller text */
        min-width: 33px; /* button width */
    }


</style>

<script>
    $(document).ready(function () {

        if ($.fn.DataTable.isDataTable('#complaintTable_Partial')) {
            $('#complaintTable_Partial').DataTable().destroy();
            $('.dt-buttons-partial').empty(); // Clear only partial view buttons
        }


        var table = $('#complaintTable_Partial').DataTable({
            responsive: true,
            searching: true,
            paging: true,
            ordering: false,
            info: true,
            lengthChange: false,
            pageLength: 10,
            destroy: true,
            autoWidth: false,
            scrollX: false,
            language: {
                search: "Search:",
                searchPlaceholder: "Type to search..."
            },
            drawCallback: function () {

                var pageInfo = this.api().page.info();
                this.api().column(1, { page: 'current' }).nodes().each(function (cell, i) {
                    cell.innerHTML = pageInfo.start + i + 1;
                });

            },
            buttons: [
                {
                    extend: 'copy',
                    className: 'btn btn-sm',
                    text: '<img src="/Content/Document/Image/Copy.png" alt="Copy">',
                    attr: { title: 'Copy to clipboard' },
                    title: 'Complaint List - ' + getCurrentDateTime(),
                    exportOptions: {
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckboxComplaint').prop('checked');
                        },
                        columns: ':not(:first-child)',
                        format: {
                            body: function (data, row, column, node) {
                                // Adjust serial numbers for selected rows
                                if (column === 0) { // Sr No column (index 0 after removing checkbox)
                                    var selectedRows = [];
                                    table.rows({ search: 'applied' }).nodes().each(function (rowNode, index) {
                                        if ($(rowNode).find('input.rowCheckboxComplaint').prop('checked')) {
                                            selectedRows.push(rowNode);
                                        }
                                    });
                                    return selectedRows.indexOf(node.parentNode) + 1;
                                }
                                return data;
                            }
                        }
                    },
                    action: function (e, dt, button, config) {
                        if (getSelectedCountComplaint() === 0) {
                            showErrorToast('Please select at least one row to export');
                            return false;
                        }
                        $.fn.dataTable.ext.buttons.copyHtml5.action.call(this, e, dt, button, config);
                    }
                },
                {
                    extend: 'csv',
                    className: 'btn btn-sm',
                    text: '<img src="/Content/Document/Image/CSV.png" alt="CSV">',
                    attr: { title: 'Export as CSV file' },
                    title: 'Complaint List - ' + getCurrentDateTime(),
                    exportOptions: {
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckboxComplaint').prop('checked');
                        },
                        columns: ':not(:first-child)',
                        format: {
                            body: function (data, row, column, node) {
                                if (column === 0) {
                                    var selectedRows = [];
                                    table.rows({ search: 'applied' }).nodes().each(function (rowNode, index) {
                                        if ($(rowNode).find('input.rowCheckboxComplaint').prop('checked')) {
                                            selectedRows.push(rowNode);
                                        }
                                    });
                                    return selectedRows.indexOf(node.parentNode) + 1;
                                }
                                return data;
                            }
                        }
                    },
                    action: function (e, dt, button, config) {
                        if (getSelectedCountComplaint() === 0) {
                            showErrorToast('Please select at least one row to export');
                            return false;
                        }
                        $.fn.dataTable.ext.buttons.csvHtml5.action.call(this, e, dt, button, config);
                    }
                },
                {
                    extend: 'excel',
                    className: 'btn btn-sm',
                    text: '<img src="/Content/Document/Image/XLS.png" alt="Excel">',
                    attr: { title: 'Export as Excel file' },
                    title: 'Complaint List - ' + getCurrentDateTime(),
                    exportOptions: {
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckboxComplaint').prop('checked');
                        },
                        columns: ':not(:first-child)',
                        format: {
                            body: function (data, row, column, node) {
                                if (column === 0) {
                                    var selectedRows = [];
                                    table.rows({ search: 'applied' }).nodes().each(function (rowNode, index) {
                                        if ($(rowNode).find('input.rowCheckboxComplaint').prop('checked')) {
                                            selectedRows.push(rowNode);
                                        }
                                    });
                                    return selectedRows.indexOf(node.parentNode) + 1;
                                }
                                return data;
                            }
                        }
                    },
                    action: function (e, dt, button, config) {
                        if (getSelectedCountComplaint() === 0) {
                            showErrorToast('Please select at least one row to export');
                            return false;
                        }
                        $.fn.dataTable.ext.buttons.excelHtml5.action.call(this, e, dt, button, config);
                    }
                },
                {
                    extend: 'pdf',
                    className: 'btn btn-sm',
                    text: '<img src="/Content/Document/Image/PDFicon.png" alt="PDF">',
                    attr: { title: 'Export as PDF file' },
                    filename: 'Complaint List ' + new Date().toISOString().slice(0, 10),
                    title: 'Complaint List',
                    orientation: 'landscape',
                    pageSize: 'A4',
                    action: function (e, dt, button, config) {
                        if (getSelectedCountComplaint() === 0) {
                            showErrorToast('Please select at least one row to export');
                            return false;
                        }
                        // ✅ Pass dt instance to config so customize can use it
                        config.customizeDataTable = dt;
                        $.fn.dataTable.ext.buttons.pdfHtml5.action.call(this, e, dt, button, config);
                    },
                    exportOptions: {
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckboxComplaint').prop('checked');
                        },
                        columns: ':not(:first-child)',
                        format: {
                            body: function (data, row, column, node) {
                                // Fix Sr No for dynamic numbering
                                if (column === 0) { // Sr No column (after removing checkbox column)
                                    // Get all selected rows and find the current row's position
                                    var selectedRows = [];
                                    table.rows({ search: 'applied' }).nodes().each(function (rowNode, index) {
                                        if ($(rowNode).find('input.rowCheckboxComplaint').prop('checked')) {
                                            selectedRows.push(rowNode);
                                        }
                                    });

                                    // Find the index of current row in selected rows
                                    var currentRowIndex = selectedRows.indexOf(node.parentNode);
                                    return currentRowIndex + 1;
                                }

                                const $td = $(node).closest('td');
                                if ($td.attr('data-order')) {
                                    const displayText = $td.text().trim();
                                    return displayText || data;
                                }
                                return data;
                            }
                        }
                    },
                    customize: function (doc, config) {
                        // ✅ Get dt reference back from config
                        var dt = config.customizeDataTable;

                        // Remove default title
                        doc.content.splice(0, 1);

                        // ✅ Count all selected records across ALL pages using dt reference
                        var totalRecords = dt.rows().nodes().to$()
                            .find('input.rowCheckboxComplaint:checked').length;

                        // Get current date and time
                        var dateTime = getCurrentDateTime();

                        // Add custom header with company name and report details
                        doc.content.unshift({
                            margin: [0, 0, 0, 12],
                            table: {
                                widths: ['*', '*', '*'],
                                body: [
                                    [
                                        { text: '', border: [false, false, false, false] },
                                        { text: 'Rahi Shop', alignment: 'center', fontSize: 16, bold: true, border: [false, false, false, false] },
                                        { text: '', border: [false, false, false, false] }
                                    ],
                                    [
                                        { text: '', border: [false, false, false, false] },
                                        { text: 'Complaint List', alignment: 'center', fontSize: 14, bold: true, border: [false, false, false, false] },
                                        { text: `Generated On: ${dateTime}\nTotal Records: ${totalRecords}`, alignment: 'right', fontSize: 10, italics: true, border: [false, false, false, false] }
                                    ]
                                ]
                            },
                            layout: 'noBorders'
                        });

                        // Set table column widths to be equal
                        var table = doc.content[1].table;
                        table.widths = Array(table.body[0].length).fill('*');

                        // Style table header
                        doc.styles.tableHeader.fillColor = '#007bff';
                        doc.styles.tableHeader.color = 'white';
                        doc.styles.tableHeader.alignment = 'center';
                        doc.styles.tableHeader.fontSize = 10;

                        // Set default font size for table content
                        doc.defaultStyle.fontSize = 9;

                        // Format table rows with proper alignment and serial numbering
                        var serial = 1;
                        doc.content[1].table.body.forEach(function (row, i) {
                            if (i > 0) { // Skip header row
                                row.forEach(function (cell, j) {
                                    if (j === 0) { // Serial number column
                                        cell.text = serial++;
                                        cell.alignment = 'center';
                                        cell.fontSize = 9;
                                    } else {
                                        // Apply specific column alignments for complaint data
                                        switch (j) {
                                            case 1: // Complaint ID - Center
                                                cell.alignment = 'center';
                                                break;
                                            case 2: // Customer Name - Left
                                                cell.alignment = 'center';
                                                break;
                                            case 3: // Email - Left
                                                cell.alignment = 'center';
                                                break;
                                            case 4: // Subject - Left
                                                cell.alignment = 'center';
                                                break;
                                            case 5: // Complaint Date - Center
                                                cell.alignment = 'center';
                                                break;
                                            case 6: // Status - Center
                                                cell.alignment = 'center';
                                                break;
                                            case 7: // Priority - Center
                                                cell.alignment = 'center';
                                                break;
                                            case 8: // Department - Left
                                                cell.alignment = 'center';
                                                break;
                                            default:
                                                cell.alignment = 'center';
                                        }
                                        cell.fontSize = 9;
                                    }
                                });
                            }
                        });

                        // Reduce page margins to maximize table space
                        doc.pageMargins = [20, 60, 20, 40];
                    }
                },

                {
                    extend: 'print',
                    className: 'btn btn-sm',
                    text: '<img src="/Content/Document/Image/Print.png" alt="Print">',
                    attr: { title: 'Print' },
                    title: 'Complaint List - ' + getCurrentDateTime(),
                    exportOptions: {
                        rows: function (idx, data, node) {
                            return $(node).find('input.rowCheckboxComplaint').prop('checked');
                        },
                        columns: ':not(:first-child)',
                        format: {
                            body: function (data, row, column, node) {
                                if (column === 0) {
                                    var selectedRows = [];
                                    table.rows({ search: 'applied' }).nodes().each(function (rowNode, index) {
                                        if ($(rowNode).find('input.rowCheckboxComplaint').prop('checked')) {
                                            selectedRows.push(rowNode);
                                        }
                                    });
                                    return selectedRows.indexOf(node.parentNode) + 1;
                                }
                                return data;
                            }
                        }
                    },
                    action: function (e, dt, button, config) {
                        if (getSelectedCountComplaint() === 0) {
                            showErrorToast('Please select at least one row to export');
                            return false;
                        }
                        $.fn.dataTable.ext.buttons.print.action.call(this, e, dt, button, config);
                    }
                }
            ],
            language: {
                search: "Search:",
                searchPlaceholder: "Type to search...",
                paginate: {
                    next: 'Next',
                    previous: 'Previous'
                }
            },
            initComplete: function () {
                this.api().buttons().container().appendTo($('.dt-buttons-Partial'));
                // Manually set the placeholder attribute as fallback
                $('#sellerTable_partial_filter input[type="search"]').attr('placeholder', 'Type to search...');
                $('#complaintTable_Partial_filter').appendTo($('#complaintTable_Partial_filter').parent());
            }
        });

        $('#selectAllComplaints_Partial').on('click', function () {
            var rows = table.rows({ 'search': 'applied' }).nodes();
            $('input.rowCheckboxComplaint', rows).prop('checked', this.checked);
        });

        $('#complaintTable_Partial tbody').on('change', 'input.rowCheckboxComplaint', function () {
            if (!this.checked) {
                $('#selectAllComplaints_Partial').prop('checked', false);
            } else {
                var allChecked = table.rows({ 'search': 'applied' }).nodes().find('input.rowCheckboxComplaint:not(:checked)').length === 0;
                $('#selectAllComplaints_Partial').prop('checked', allChecked);
            }
        });
    });

    function getSelectedCountComplaint() {
        return $('input.rowCheckboxComplaint:checked').length;
    }

    function showErrorToast(message) {
        $('#toastMessage').text(message);
        var toastEl = document.getElementById('liveToast');
        var toast = new bootstrap.Toast(toastEl);
        toast.show();
    }

    function getCurrentDateTime() {
        var now = new Date();
        return now.toLocaleDateString('en-GB') + ' ' + now.toLocaleTimeString('en-GB');
    }
</script>