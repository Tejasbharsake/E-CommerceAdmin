@model GSTECommerceLibrary.Admin.Admin
@{
    Layout = null;
}

<!-- Font Awesome for the eye icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link href="~/Content/Document/CSS/ChangePassWordProfileTB.css" rel="stylesheet" />

@*<style>
    /* Password Requirements Box */
    #password-requirements {
        display: none;
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-top: 10px;
        font-size: 14px;
    }

    .password-requirement {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        color: #dc3545;
        transition: color 0.3s;
    }

        .password-requirement.valid {
            color: #28a745;
        }

        .password-requirement i {
            margin-right: 8px;
            font-size: 16px;
        }

    /* Password Strength Bar */
    .password-strength-container {
        margin-top: 10px;
        margin-bottom: 10px;
    }

    .password-strength-bar {
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 5px;
    }

    .password-strength-fill {
        height: 100%;
        width: 0%;
        transition: width 0.3s, background-color 0.3s;
        border-radius: 4px;
    }

    .strength-weak {
        background-color: #dc3545;
    }

    .strength-medium {
        background-color: #ffc107;
    }

    .strength-strong {
        background-color: #17a2b8;
    }

    .strength-very-strong {
        background-color: #28a745;
    }

    .password-strength-text {
        font-size: 13px;
        font-weight: 600;
        color: #666;
    }

    /* Fix eye icon position for New Password field */
    .password-wrapper {
        position: relative;
    }

        .password-wrapper .toggle-password {
            position: absolute;
            right: 15px;
            top: 38px;
            cursor: pointer;
            color: #6c757d;
        }
</style>*@

<div class="password-container">
    <form id="changePasswordForm" method="post" action="@Url.Action("ChangePasswordProfileTB", "Admin")">
        <!-- Old Password Field -->
        <div class="mb-3 password-wrapper">
            <label>Old Password</label>
            <input type="password" name="oldPassword" class="form-control" required />
            <i class="fas fa-eye-slash toggle-password"></i>
        </div>

        <!-- New Password Field -->
        <div class="mb-3 password-wrapper">
            <label>New Password</label>
            <input type="password" id="NewPassword" name="newPassword" class="form-control" required />
            <i class="fas fa-eye-slash toggle-password"></i>

            <!-- Password Strength Indicator -->
            <div class="password-strength-container">
                <div class="password-strength-bar">
                    <div id="password-strength-bar" class="password-strength-fill"></div>
                </div>
                <div id="password-strength-text" class="password-strength-text"></div>
            </div>

            <!-- Password Requirements -->
            <div id="password-requirements">
                <div class="password-requirement" id="req-length">
                    <i class="fas fa-times-circle"></i>
                    <span>Minimum 8 characters</span>
                </div>
                <div class="password-requirement" id="req-uppercase">
                    <i class="fas fa-times-circle"></i>
                    <span>One uppercase letter (A-Z)</span>
                </div>
                <div class="password-requirement" id="req-lowercase">
                    <i class="fas fa-times-circle"></i>
                    <span>One lowercase letter (a-z)</span>
                </div>
                <div class="password-requirement" id="req-number">
                    <i class="fas fa-times-circle"></i>
                    <span>One number (0-9)</span>
                </div>
                <div class="password-requirement" id="req-special">
                    <i class="fas fa-times-circle"></i>
                    <span>One special character (!#$_.)</span>
                </div>
            </div>
        </div>

        <!-- Confirm Password Field -->
        <div class="mb-3 password-wrapper">
            <label>Confirm Password</label>
            <input type="password" name="confirmPassword" class="form-control" required />
            <i class="fas fa-eye-slash toggle-password"></i>
        </div>

        <button type="submit" class="btn btn-primary">Change Password</button>
    </form>

    @if (TempData["Message"] != null)
    {
        <div class="alert alert-success mt-2" style="display:none;">@TempData["Message"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger mt-2" style="display:none;">@TempData["Error"]</div>
    }
</div>

<script>
    // Wait for the document to be fully loaded
    $(document).ready(function () {

        // --- Password Validation Script (from your provided script) ---
        const pwd = document.getElementById("NewPassword");
        const bar = document.getElementById("password-strength-bar");
        const text = document.getElementById("password-strength-text");
        const rulesBox = document.getElementById("password-requirements");

        if (pwd && bar && text && rulesBox) {
            const req = {
                length: document.getElementById("req-length"),
                uppercase: document.getElementById("req-uppercase"),
                lowercase: document.getElementById("req-lowercase"),
                number: document.getElementById("req-number"),
                special: document.getElementById("req-special")
            };

            // Function to toggle validation icons
            const validateRule = (element, isValid) => {
                if (!element) return;
                const icon = element.querySelector("i");
                if (isValid) {
                    element.classList.add("valid");
                    icon.classList.replace("fa-times-circle", "fa-check-circle");
                } else {
                    element.classList.remove("valid");
                    icon.classList.replace("fa-check-circle", "fa-times-circle");
                }
            };

            // Function to calculate strength
            const checkStrength = (password) => {
                let score = 0;
                if (password.length >= 8) score++;
                if (/[a-z]/.test(password)) score++;
                if (/[A-Z]/.test(password)) score++;
                if (/\d/.test(password)) score++;
                if (/[^a-zA-Z\d]/.test(password)) score++;
                return score;
            };

            // Show validation box when input focused
            pwd.addEventListener("focus", () => {
                rulesBox.style.display = "block";
            });

            // Real-time validation while typing
            pwd.addEventListener("input", () => {
                const val = pwd.value;
                const checks = {
                    length: val.length >= 8,
                    uppercase: /[A-Z]/.test(val),
                    lowercase: /[a-z]/.test(val),
                    number: /\d/.test(val),
                    special: /[^a-zA-Z\d]/.test(val)
                };

                for (let key in req) {
                    validateRule(req[key], checks[key]);
                }

                const score = checkStrength(val);
                bar.className = "password-strength-fill";
                bar.style.width = `${score * 20}%`;

                switch (score) {
                    case 1:
                    case 2:
                        bar.classList.add("strength-weak");
                        text.textContent = "Weak";
                        break;
                    case 3:
                        bar.classList.add("strength-medium");
                        text.textContent = "Medium";
                        break;
                    case 4:
                        bar.classList.add("strength-strong");
                        text.textContent = "Strong";
                        break;
                    case 5:
                        bar.classList.add("strength-very-strong");
                        text.textContent = "Very Strong";
                        break;
                    default:
                        text.textContent = "";
                        break;
                }
            });

            // Hide validation box when valid or empty
            pwd.addEventListener("blur", () => {
                const val = pwd.value;
                const fullyValid =
                    val.length >= 8 &&
                    /[A-Z]/.test(val) &&
                    /[a-z]/.test(val) &&
                    /\d/.test(val) &&
                    /[^a-zA-Z\d]/.test(val);

                if (fullyValid || val.length === 0) {
                    rulesBox.style.display = "none";
                }
            });
        }

        // --- Password visibility toggle (existing functionality) ---
        $(".toggle-password").click(function () {
            var input = $(this).siblings("input");
            $(this).toggleClass("fa-eye fa-eye-slash");

            if (input.attr("type") === "password") {
                input.attr("type", "text");
            } else {
                input.attr("type", "password");
            }
        });

        // Show SweetAlert if there's a success or error message (existing functionality)
        var successMessage = $('.alert-success').text().trim();
        var errorMessage = $('.alert-danger').text().trim();

        if (successMessage) {
            Swal.fire({
                title: "Success!",
                text: successMessage,
                icon: "success",
                showConfirmButton: false,
                timer: 2500,
                timerProgressBar: true
            }).then(() => {
                // Close the modal/view after SweetAlert closes
                if (window.parent && window.parent.$) {
                    window.parent.$('.modal').modal('hide');
                }
                // Alternative: If it's a separate page, redirect
                // window.location.href = '@Url.Action("Index", "Admin")';
            });
        }

        if (errorMessage) {
            Swal.fire({
                title: 'Error!',
                text: errorMessage,
                icon: 'error',
                confirmButtonText: 'Try Again'
            });
        }

        // --- EXISTING: AJAX form submit ---
        $("#changePasswordForm").on("submit", function (e) {
            e.preventDefault();

            $.ajax({
                url: $(this).attr("action"),
                type: "POST",
                data: $(this).serialize(),
                success: function (result) {
                    // Check if the result contains success message
                    if ($(result).find('.alert-success').length > 0) {
                        var message = $(result).find('.alert-success').text().trim();
                        Swal.fire({
                            title: "Success!",
                            text: message,
                            icon: "success",
                            showConfirmButton: false,
                            timer: 2500,
                            timerProgressBar: true
                        }).then(() => {
                            // Close the modal/view after SweetAlert closes
                            if (window.parent && window.parent.$) {
                                window.parent.$('.modal').modal('hide');
                            }
                            // Alternative: If it's a separate page, redirect
                            // window.location.href = '@Url.Action("Index", "Admin")';
                        });
                    } else {
                        $("#changePasswordContent").html(result);
                    }
                },
                error: function () {
                    Swal.fire({
                        title: 'Oops...',
                        text: 'An error occurred while changing the password.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            });
        });
    });
</script>
