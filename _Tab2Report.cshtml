@model System.Data.DataSet
@using System.Data
@using System.Linq

@{
    // Dataset tables
    var mostSoldTable = Model?.Tables.Count > 2 ? Model.Tables[2] : null;
    var leastSoldTable = Model?.Tables.Count > 3 ? Model.Tables[3] : null;
    var productDetailsTable = Model?.Tables.Count > 0 ? Model.Tables[0] : null;

    // ViewBag totals
    var totalProducts = ViewBag.TotalProducts ?? 0;
    var soldProducts = ViewBag.SoldProducts ?? 0;
    var unsoldProducts = ViewBag.UnSoldProducts ?? 0;
}

@if (!string.IsNullOrEmpty(ViewBag.Error as string))
{
    <div class="alert alert-danger">@ViewBag.Error</div>
}
else
{




    <!-- ✅ Summary Cards -->
    <div class="d-flex justify-content-between flex-wrap gap-3 mb-4">
        <!-- Total -->
        <div class="flex-fill">
            <div class="card border-0 shadow-sm h-100" id="openTotalProducts" style="cursor:pointer;">
                <div class="card-body text-center">
                    <div class="d-flex justify-content-center align-items-center mb-3">
                        <div class="rounded-circle bg-primary bg-opacity-10 p-3">
                            <i class="fas fa-users text-primary" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                    <h3 class="text-primary mb-1 fw-bold">@totalProducts</h3>
                    <p class="text-muted mb-0">Total Products</p>
                </div>
            </div>
        </div>

        <!-- Sold -->
        <div class="flex-fill">
            <div class="card border-0 shadow-sm h-100" id="openSoldProducts" style="cursor:pointer;">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-3">
                        <div class="rounded-circle bg-success bg-opacity-10 p-3">
                            <i class="fas fa-check-circle text-success" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                    <h3 class="text-success mb-1 fw-bold">@soldProducts</h3>
                    <p class="text-muted mb-0">Sold Products</p>
                </div>
            </div>
        </div>

        <!-- Unsold -->
        <div class="flex-fill">
            <div class="card border-0 shadow-sm h-100" id="openUnsoldProducts" style="cursor:pointer;">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-3">
                        <div class="rounded-circle bg-warning bg-opacity-10 p-3">
                            <i class="fas fa-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                    <h3 class="text-warning mb-1 fw-bold">@unsoldProducts</h3>
                    <p class="text-muted mb-0">Unsold Products</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ✅ Product Details Table -->
    <div class="table-responsive mb-4">
        @if (productDetailsTable != null && productDetailsTable.Rows.Count > 0)
        {
            <div class="card">
                <div class="card-header"><h4 class="card-title">Product Data</h4></div>
                <div class="card-body">
                    <table id="productDetailsTable" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Sr No</th>
                                @foreach (DataColumn col in productDetailsTable.Columns)
                                {
                                    <th>@col.ColumnName</th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                var srNo = 1;
                            }
                            @foreach (DataRow row in productDetailsTable.Rows)
                            {
                                <tr>
                                    <td>@srNo</td>
                                    @foreach (var item in row.ItemArray)
                                    {
                                        <td>@(item ?? "")</td>
                                    }
                                </tr>
                                srNo++;
                            }
                        </tbody>
                    </table>


                </div>
            </div>
        }
        else
        {
            <div class="alert alert-warning">No product details available.</div>
        }
    </div>

    <!-- ✅ Product Sales Summary -->
    <div class="card mb-12">
        <div class="card-header text-white"  style="background: #2C3E50 ">
            <h5 class="mb-0">Product Sales Summary</h5>
        </div>

        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Total Sold Products
                            <span class="badge bg-success">@soldProducts</span>
                        </li>
                    </ul>
                </div>

                <div class="col-md-6">
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Total Unsold Products
                            <span class="badge bg-danger">@unsoldProducts</span>
                        </li>
                    </ul>
                </div>
            </div>
        

    @*<div class="col-md-6">
            <ul class="list-group">
                <li class="list-group-item">
                    <strong>Most Sold Product:</strong>
                    @if (mostSoldTable != null && mostSoldTable.Rows.Count > 0)
                    {
                        <span>@mostSoldTable.Rows[0]["ProductName"] (Qty: @mostSoldTable.Rows[0]["TotalQuantitySold"])</span>
                    }
                    else
                    { <span>N/A</span>}
                </li>
                <li class="list-group-item">
                    <strong>Least Sold Product:</strong>
                    @if (leastSoldTable != null && leastSoldTable.Rows.Count > 0)
                    {
                        <span>@leastSoldTable.Rows[0]["ProductName"] (Qty: @leastSoldTable.Rows[0]["TotalQuantitySold"])</span>
                    }
                    else
                    { <span>N/A</span>}
                </li>
            </ul>
        </div>*@
    </div>
    </div>

    <!-- ✅ Charts -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header  text-white" style="background: #2C3E50 "><h5 class="mb-0">Product Sales Distribution</h5></div>
                <div class="card-body">
                    <div id="productSalesDonutChart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
        @*<div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white"><h5 class="mb-0">Top 5 Products by Sales</h5></div>
                    <div class="card-body">
                        <div id="topProductsChart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>*@
    </div>
}

<!-- Product List Modal -->
<div class="modal fade" id="productListModal" tabindex="-1" aria-labelledby="productListModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header text-white" style="background: #2C3E50 ">
                <h5 class="modal-title" id="productListModalLabel">Product List</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="productListContent">
                    <p class="text-center text-muted">Loading...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function () {
    // --- Donut Chart ---
    Highcharts.chart('productSalesDonutChart', {
        chart: { type: 'pie' },
        title: { text: '' },
        series: [{
            name: 'Products',
            innerSize: '70%',
            colorByPoint: true,
            data: [
                { name: 'Sold', y: @soldProducts, color: '#28a745' },
                { name: 'Unsold', y: @unsoldProducts, color: '#dc3545' }
            ]
        }]
    });

    @*// --- Bar Chart ---
    Highcharts.chart('topProductsChart', {
        chart: { type: 'column' },
        title: { text: 'MOST SOLD PRODUCTS' },
        xAxis: {
            categories: [
                @if (mostSoldTable != null && mostSoldTable.Rows.Count > 0)
                {
                    var cats = mostSoldTable.AsEnumerable().Take(5)
                               .Select(r => "'" + r["ProductName"].ToString().Replace("'", "\\'") + "'");
                    @Html.Raw(string.Join(",", cats));
                }
            ]
        },
        yAxis: { title: { text: 'Quantity Sold' } },
        series: [{
            name: 'Units Sold',
            data: [
                @if (mostSoldTable != null && mostSoldTable.Rows.Count > 0)
                {
                    var vals = mostSoldTable.AsEnumerable().Take(5).Select(r => r["TotalQuantitySold"]);
                    @Html.Raw(string.Join(",", vals));
                }
            ]
        }]
    });*@

    Highcharts.chart('productSalesDonutChart', {
    chart: { type: 'pie' },
    title: { text: '' },
    plotOptions: {
        pie: {
            cursor: 'pointer',
            point: {
                events: {
                    click: function () {
                        // Open modal on click
                        if (this.name === 'Sold') {
                            loadProductList('Sold');
                        } else if (this.name === 'Unsold') {
                            loadProductList('Unsold');
                        }
                    }
                }
            }
        }
    },
    series: [{
        name: 'Products',
        innerSize: '70%',
        colorByPoint: true,
        data: [
            { name: 'Sold', y: @soldProducts, color: '#28a745' },
            { name: 'Unsold', y: @unsoldProducts, color: '#dc3545' }
        ]
    }]
});



    //$('#openSoldProducts').on('click', function () {
    //    loadProductList('Sold');
    //});

    //$('#openUnsoldProducts').on('click', function () {
    //    loadProductList('Unsold');
    //});
    // Use delegated events for dynamically loaded elements
    $(document).on('click', '#openSoldProducts', function () {
        loadProductList('Sold');
    });

    $(document).on('click', '#openUnsoldProducts', function () {
        loadProductList('Unsold');
    });


});

// --- Load Sold / Unsold Products in Modal ---
    // Updated function to load product lists with proper date handling
    function loadProductList(type) {
        // Get the date range from the product tab's date picker
        var dateRangeValue = $('#productDateRange').val();
        var startDate = '';
        var endDate = '';

        // Parse the date range if it exists
        if (dateRangeValue && dateRangeValue.includes(' - ')) {
            var dates = dateRangeValue.split(' - ');
            if (dates.length === 2) {
                // Convert MM/DD/YYYY to YYYY-MM-DD format
                var startParts = dates[0].split('/');
                var endParts = dates[1].split('/');

                if (startParts.length === 3 && endParts.length === 3) {
                    startDate = `${startParts[2]}-${startParts[0].padStart(2, '0')}-${startParts[1].padStart(2, '0')}`;
                    endDate = `${endParts[2]}-${endParts[0].padStart(2, '0')}-${endParts[1].padStart(2, '0')}`;
                }
            }
        }

        // Debug logging
        console.log('Date Range Value:', dateRangeValue);
        console.log('Start Date:', startDate);
        console.log('End Date:', endDate);

        // Update modal title
        $('#productListModalLabel').text(type + ' Products List');

        // Show loading
        $('#productListContent').html('<div class="text-center my-3"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</div>');

        // Open modal
        $('#productListModal').modal('show');

        // Determine URL based on type
        var url = type === 'Sold' ? '/Admin/SoldProductList' : '/Admin/UnsoldProductList';

        // AJAX call with proper date parameters
        $.ajax({
            url: url,
            type: 'GET',
            data: {
                startDate: startDate,
                endDate: endDate
            },
            success: function (result) {
                $('#productListContent').html(result);

                if ($.fn.DataTable.isDataTable('#productListTable')) {
                    $('#productListTable').DataTable().destroy();


                }
                $('#productListTable').DataTable({
                    paging: true,
                    searching: true,
                    ordering: false,
                    pageLength: 10,
                    lengthChange: false,
                    order: [[2, 'asc']]
                });
            },
            error: function (xhr, status, error) {
                console.error('AJAX Error:', error);
                $('#productListContent').html('<p class="text-danger text-center">Failed to load data. Please try again.</p>');
            }
        });
    }


</script>
<style>
    /* ✅ Stronger, DataTable-safe styles */
    table.dataTable thead th {
        background-color: #2C3E50 !important;
        color: #FFFFFF !important;
        font-weight: 600 !important;
        text-align: center !important;
        padding: 5px !important;
        border-bottom: 2px solid #ddd !important;
        font-size: 14px !important;
        height: 8px !important;
        font-family: 'Poppins', sans-serif !important;
        vertical-align: middle !important;
    }

    table.dataTable tbody td {
        padding: 2px 5px !important;
        height: 5px !important;
        line-height: 1 !important;
        font-size: 13px !important;
        text-align: center !important;
        font-family: 'Poppins', sans-serif !important;
        vertical-align: middle !important;
    }

</style>