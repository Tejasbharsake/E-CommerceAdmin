@model IEnumerable<GSTECommerceLibrary.Admin.Admin>

@{
    ViewBag.Title = "_ActiveCustomerANB";
}

<!-- Font Awesome for Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<!-- jsPDF CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- jsPDF AutoTable plugin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<div class="card mt-4">
    <div class="card-body">
        @if (Model != null && Model.Any())
        {
            <!-- Export Buttons Row -->
            <div class="row mb-3 align-items-end">
                <div class="col-md-5">
                    <!-- Filters can be added here if needed -->
                </div>
                <div class="col-md-7 text-end mt-3 mt-md-0 d-flex gap-2 justify-content-md-end justify-content-start">
                    <button class="btn btn-outline-primary btn-sm" id="copyBtn" title="Copy">
                        <img src="~/Content/Document/Image/Copy.png" alt="Copy" width="16" height="16" />
                    </button>
                    <button class="btn btn-outline-info btn-sm" id="csvBtn" title="Export to CSV">
                        <img src="~/Content/Document/Image/CSV.png" alt="CSV" width="16" height="16" />
                    </button>
                    <button class="btn btn-outline-success btn-sm" id="excelBtn" title="Export to Excel">
                        <img src="~/Content/Document/Image/XLS.png" alt="Excel" width="16" height="16" />
                    </button>
                    <button class="btn btn-outline-danger btn-sm" id="pdfBtn" title="Export to PDF">
                        <img src="~/Content/Document/Image/PDFicon.png" alt="PDF" width="16" height="16" />
                    </button>
                    <button class="btn btn-outline-dark btn-sm" id="printBtn" title="Print">
                        <img src="~/Content/Document/Image/Print.png" alt="Print" width="16" height="16" />
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table id="activeCustomerTable" class="table table-striped table-bordered">
                    <thead>
                        <tr style="background: #2C3E50; color: white;">
                            <th><input type="checkbox" id="selectAll" /></th>
                            <th>Sr No</th>
                            <th>Customer Code</th>
                            <th>Customer Name</th>
                            <th>Email</th>
                            <th>Mobile No</th>
                            <th>Total Orders</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var srNo = 1;
                        }
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td><input type="checkbox" class="row-checkbox" value="@srNo" /></td>
                                <td>@srNo</td>
                                <td>@item.CustomerCode</td>
                                <td>@item.CustomerName</td>
                                <td>@item.EmailAddress</td>
                                <td>+91 @(item.CustomerPhone)</td>
                                <td>@item.TotalOrder</td>
                            </tr>
                            srNo++;
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="alert alert-warning">No customers found.</div>
        }
    </div>
</div>

<style>
    #activeCustomerTable thead th {
        background-color: #2C3E50; /* Solid Navy */
        color: #FFFFFF; /* White text */
        font-weight: 600;
        text-align: center;
        padding: 5px;
        border-bottom: 2px solid #ddd;
        font-size: 14px; /* Smaller text */
        height: 8px !important; /* Fixed header height */
        font-family: 'Poppins', sans-serif; /* Added font */
        vertical-align: middle;
    }

    /* Reduce body row height */
    #activeCustomerTable tbody td {
        padding: 2px 5px !important;
        height: 5px !important;
        line-height: 1;
        font-size: 13px;
        text-align: center;
        font-family: 'Poppins', sans-serif; /* Added font */
        vertical-align: middle;
    }

    /* Target DataTables pagination buttons */
    #activeCustomerTable_paginate .pagination .page-link {
        padding: 2px 10px; /* Smaller height & width */
        font-size: 12px; /* Smaller text */
        min-width: 33px; /* Button width */
    }

    /* Remove hover effect from export buttons */
    .btn-outline-primary, .btn-outline-info, .btn-outline-success, .btn-outline-danger, .btn-outline-dark {
        transition: none !important; /* Disable all transitions */
    }

        .btn-outline-primary:hover, .btn-outline-info:hover, .btn-outline-success:hover, .btn-outline-danger:hover, .btn-outline-dark:hover {
            background-color: transparent !important; /* Prevent background change */
            border-color: inherit !important; /* Maintain original border color */
            color: inherit !important; /* Maintain original text color */
            box-shadow: none !important; /* Remove any shadow */
        }

    /* Selected row styling */
    .selected-row {
        background-color: #e3f2fd !important;
    }

    .row-checkbox, #selectAll {
        cursor: pointer;
    }

    /* Hide DataTables length menu */
    .dataTables_length {
        display: none;
    }
</style>

<script>
    // Global variables to store all data and selections
    var dataTable;
    var allTableData = []; // Store all row data
    var selectedRowIds = new Set(); // Store selected row IDs across all pages
    var tableHeaders = []; // Store table headers

    $(document).ready(function () {
        // Store all table data before initializing DataTable
        storeAllTableData();

        // Initialize DataTable with pagination
        initializeDataTable();

        // Initialize checkboxes
        initializeCheckboxes();
    });

    // Function to store all table data
    function storeAllTableData() {
        // Store headers (excluding checkbox column)
        tableHeaders = [];
        $('#activeCustomerTable thead tr th').each(function (index) {
            if (index > 0) { // Skip checkbox column
                tableHeaders.push($(this).text().trim());
            }
        });

        // Store all row data
        allTableData = [];
        $('#activeCustomerTable tbody tr').each(function () {
            var rowData = [];
            var rowId = $(this).find('.row-checkbox').val();

            $(this).find('td').each(function (index) {
                if (index > 0) { // Skip checkbox column
                    var cellText = $(this).text().trim();
                    // Clean up any extra whitespace
                    cellText = cellText.replace(/\s+/g, ' ');
                    rowData.push(cellText);
                }
            });

            if (rowData.length > 0) {
                allTableData.push({
                    id: rowId,
                    data: rowData
                });
            }
        });

        console.log('Stored all table data:', allTableData.length, 'rows');
        console.log('Headers:', tableHeaders);
    }

    function initializeDataTable() {
        // Destroy existing DataTable if it exists
        if ($.fn.DataTable.isDataTable('#activeCustomerTable')) {
            dataTable.destroy();
        }

        // Initialize DataTable
        dataTable = $('#activeCustomerTable').DataTable({
            paging: true,
            pageLength: 10,
            lengthChange: true,
            lengthMenu: [10, 25, 50, 100],
            searching: true,
            ordering: false,
            info: true,
            autoWidth: false,
            responsive: true,
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>><"row"<"col-sm-12"tr>><"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
            language: {
                search: "Search:",
                searchPlaceholder: "Type to search",
                lengthMenu: "", // Remove "Show MENU entries" text
                paginate: {
                    first: "First",
                    last: "Last",
                    next: "Next",
                    previous: "Previous"
                }
            },
            drawCallback: function (settings) {
                // Re-initialize checkboxes after each DataTable draw
                initializeCheckboxes();
            },
            initComplete: function (settings, json) {
                // Initialize checkboxes after DataTable is fully loaded
                initializeCheckboxes();

                // Hide the "Show entries" label completely
                $('.dataTables_length label').contents().filter(function () {
                    return this.nodeType === 3; // Text nodes
                }).remove();
            }
        });
    }

    function initializeCheckboxes() {
        var $modalTable = $('#activeCustomerTable');
        // Select All functionality
        $modalTable.find('#selectAll').off('click').on('click', function () {
            var isChecked = $(this).is(':checked');
            $modalTable.find('.row-checkbox').prop('checked', isChecked);

            if (isChecked) {
                // Add all row IDs to selection
                allTableData.forEach(function (row) {
                    selectedRowIds.add(row.id);
                });
                $modalTable.find('.row-checkbox').each(function () {
                    $(this).closest('tr').addClass('selected-row');
                });
            } else {
                // Clear all selections
                selectedRowIds.clear();
                $modalTable.find('tr').removeClass('selected-row');
            }
        });

        // Individual checkbox selection
        $modalTable.find('.row-checkbox').off('change').on('change', function () {
            var row = $(this).closest('tr');
            var rowId = $(this).val();
            var isChecked = $(this).is(':checked');

            if (isChecked) {
                selectedRowIds.add(rowId);
                row.addClass('selected-row');
            } else {
                selectedRowIds.delete(rowId);
                row.removeClass('selected-row');
            }

            // Update select all checkbox state
            updateSelectAllCheckbox();
        });

        // Maintain selections when changing pages
        $modalTable.find('.row-checkbox').each(function () {
            var rowId = $(this).val();
            if (selectedRowIds.has(rowId)) {
                $(this).prop('checked', true);
                $(this).closest('tr').addClass('selected-row');
            }
        });

        // Update select all checkbox based on current selection
        updateSelectAllCheckbox();
    }

    function updateSelectAllCheckbox() {
        var totalRows = allTableData.length;
        var selectedCount = selectedRowIds.size;

        if (selectedCount === 0) {
            $('#selectAll').prop('checked', false).prop('indeterminate', false);
        } else if (selectedCount === totalRows) {
            $('#selectAll').prop('checked', true).prop('indeterminate', false);
        } else {
            $('#selectAll').prop('checked', false).prop('indeterminate', true);
        }
    }

    // Function to get selected rows data from global store
    function getSelectedRowsData() {
        var selectedData = [];

        // Get selected row data from global store
        allTableData.forEach(function (row) {
            if (selectedRowIds.has(row.id)) {
                selectedData.push(row.data);
            }
        });

        console.log('Selected Headers:', tableHeaders);
        console.log('Selected Data from global store:', selectedData);

        return { headers: tableHeaders, data: selectedData };
    }

    // Copy Function with Dynamic Sr.No
    $('#copyBtn').on('click', function () {
        var result = getSelectedRowsData();
        if (result.data.length === 0) {
            showErrorToast('Please select at least one row to copy.');
            return;
        }

        // Generate Copy headers with Sr No as first column
        var copyHeaders = ['Sr No'];
        result.headers.forEach(function (header) {
            if (header.toLowerCase() !== 'sr no' && header.toLowerCase() !== 'sr.no' && header.toLowerCase() !== 'serial number') {
                copyHeaders.push(header);
            }
        });

        var copyText = copyHeaders.join('\t') + '\n';

        // Generate Copy data with dynamic Sr.No
        result.data.forEach(function (row, index) {
            var copyRow = [index + 1]; // Dynamic Sr.No starting from 1

            row.forEach(function (cell, cellIndex) {
                var headerName = result.headers[cellIndex];
                if (headerName && headerName.toLowerCase() !== 'sr no' && headerName.toLowerCase() !== 'sr.no' && headerName.toLowerCase() !== 'serial number') {
                    copyRow.push(cell);
                }
            });

            copyText += copyRow.join('\t') + '\n';
        });

        navigator.clipboard.writeText(copyText).then(function () {
            showSuccessToast('Data copied to clipboard! (' + result.data.length + ' rows)');
        }).catch(function () {
            showErrorToast('Copy failed. Please try again.');
        });
    });

    // CSV Export with Dynamic Sr.No
    $('#csvBtn').on('click', function () {
        var result = getSelectedRowsData();
        if (result.data.length === 0) {
            showErrorToast('Please select at least one row to export.');
            return;
        }

        // Generate CSV headers with Sr No as first column
        var csvHeaders = ['Sr No'];
        result.headers.forEach(function (header) {
            if (header.toLowerCase() !== 'sr no' && header.toLowerCase() !== 'sr.no' && header.toLowerCase() !== 'serial number') {
                csvHeaders.push(header);
            }
        });

        var csvContent = csvHeaders.join(',') + '\n';

        // Generate CSV data with dynamic Sr.No
        result.data.forEach(function (row, index) {
            var csvRow = [index + 1]; // Dynamic Sr.No starting from 1

            row.forEach(function (cell, cellIndex) {
                var headerName = result.headers[cellIndex];
                if (headerName && headerName.toLowerCase() !== 'sr no' && headerName.toLowerCase() !== 'sr.no' && headerName.toLowerCase() !== 'serial number') {
                    csvRow.push('"' + cell.replace(/"/g, '""') + '"');
                }
            });

            csvContent += csvRow.join(',') + '\n';
        });

        var blob = new Blob([csvContent], { type: 'text/csv' });
        var url = window.URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'active_customers_' + new Date().getTime() + '.csv';
        a.click();
        window.URL.revokeObjectURL(url);

        showSuccessToast('CSV file downloaded! (' + result.data.length + ' rows)');
    });

    // Excel Export with Dynamic Sr.No
    $('#excelBtn').on('click', function () {
        var result = getSelectedRowsData();
        if (result.data.length === 0) {
            showErrorToast('Please select at least one row to export.');
            return;
        }

        // Generate Excel headers with Sr No as first column
        var excelHeaders = ['Sr No'];
        result.headers.forEach(function (header) {
            if (header.toLowerCase() !== 'sr no' && header.toLowerCase() !== 'sr.no' && header.toLowerCase() !== 'serial number') {
                excelHeaders.push(header);
            }
        });

        var excelContent = '<table border="1"><thead><tr>';
        excelHeaders.forEach(function (header) {
            excelContent += '<th>' + header + '</th>';
        });
        excelContent += '</tr></thead><tbody>';

        // Generate Excel data with dynamic Sr.No
        result.data.forEach(function (row, index) {
            excelContent += '<tr>';
            excelContent += '<td>' + (index + 1) + '</td>'; // Dynamic Sr.No

            row.forEach(function (cell, cellIndex) {
                var headerName = result.headers[cellIndex];
                if (headerName && headerName.toLowerCase() !== 'sr no' && headerName.toLowerCase() !== 'sr.no' && headerName.toLowerCase() !== 'serial number') {
                    excelContent += '<td>' + cell + '</td>';
                }
            });

            excelContent += '</tr>';
        });
        excelContent += '</tbody></table>';

        var blob = new Blob([excelContent], { type: 'application/vnd.ms-excel' });
        var url = window.URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'active_customers_' + new Date().getTime() + '.xls';
        a.click();
        window.URL.revokeObjectURL(url);

        showSuccessToast('Excel file downloaded! (' + result.data.length + ' rows)');
    });

    // PDF Export with Dynamic Sr.No
    $('#pdfBtn').on('click', function () {
        var result = getSelectedRowsData();
        if (result.data.length === 0) {
            showErrorToast('Please select at least one row to export.');
            return;
        }

        if (typeof window.jspdf === 'undefined') {
            showErrorToast('jsPDF library is not loaded. Please include jsPDF library.');
            return;
        }

        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Custom Header Design
            doc.setFont("helvetica", "bold");
            doc.setFontSize(24);
            doc.setTextColor(0, 0, 0);
            const pageWidth = doc.internal.pageSize.getWidth();
            doc.text("RahiShop", pageWidth / 2, 25, { align: 'center' });

            doc.setFont("helvetica", "normal");
            doc.setFontSize(16);
            doc.setTextColor(80, 80, 80);
            doc.text("Active Customers Report", pageWidth / 2, 35, { align: 'center' });

            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            const currentDateTime = new Date().toLocaleString('en-GB', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).replace(',', '');
            doc.text("Generated On: " + currentDateTime, pageWidth - 15, 35, { align: 'right' });
            doc.text("Total Records: " + result.data.length, pageWidth - 15, 42, { align: 'right' });

            if (typeof doc.autoTable === 'function') {
                // Generate dynamic Sr.No for PDF
                var pdfData = [];
                var pdfHeaders = ['Sr No'];
                result.headers.forEach(function (header) {
                    if (header.toLowerCase() !== 'sr no' && header.toLowerCase() !== 'sr.no' && header.toLowerCase() !== 'serial number') {
                        pdfHeaders.push(header);
                    }
                });

                // Generate data with dynamic Sr.No
                result.data.forEach(function (row, index) {
                    var pdfRow = [index + 1]; // Dynamic Sr.No starting from 1
                    row.forEach(function (cell, cellIndex) {
                        var headerName = result.headers[cellIndex];
                        if (headerName && headerName.toLowerCase() !== 'sr no' && headerName.toLowerCase() !== 'sr.no' && headerName.toLowerCase() !== 'serial number') {
                            pdfRow.push(cell);
                        }
                    });
                    pdfData.push(pdfRow);
                });

                // Borderless Table Styling
                doc.autoTable({
                    head: [pdfHeaders],
                    body: pdfData,
                    startY: 55,
                    styles: {
                        fontSize: 8,
                        cellPadding: 4,
                        lineColor: [255, 255, 255], // White lines (invisible)
                        lineWidth: 0, // No line width
                        textColor: [0, 0, 0],
                        fontStyle: 'normal'
                    },
                    headStyles: {
                        fillColor: [33, 150, 243], // Professional blue color (#2196F3)
                        textColor: [255, 255, 255], // White text
                        fontStyle: 'bold',
                        halign: 'center',
                        fontSize: 9,
                        cellPadding: 5,
                        lineColor: [255, 255, 255], // No border on headers
                        lineWidth: 0 // No border width
                    },
                    bodyStyles: {
                        halign: 'center',
                        fontSize: 8,
                        lineColor: [255, 255, 255], // No border on body cells
                        lineWidth: 0 // No border width
                    },
                    alternateRowStyles: {
                        fillColor: [248, 249, 250], // Light gray for alternate rows
                        lineColor: [255, 255, 255], // No border on alternate rows
                        lineWidth: 0 // No border width
                    },
                    margin: {
                        top: 10,
                        right: 15,
                        bottom: 15,
                        left: 15
                    },
                    columnStyles: {
                        0: {
                            halign: 'center',
                            cellWidth: 15,
                            fontStyle: 'bold',
                            lineColor: [255, 255, 255], // No border on Sr.No column
                            lineWidth: 0 // No border width
                        }
                    },
                    theme: 'plain', // Changed from 'striped' to 'plain' to remove default borders
                    tableLineColor: [255, 255, 255], // No table border
                    tableLineWidth: 0 // No table border width
                });
            } else {
                showErrorToast('autoTable plugin is not loaded.');
                return;
            }

            // Save PDF with Timestamp
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '').replace('T', '_');
            const filename = 'RahiShop_ActiveCustomers_' + timestamp + '.pdf';
            doc.save(filename);
            showSuccessToast('PDF generated successfully! (' + result.data.length + ' records)');
        } catch (error) {
            console.error('PDF Generation Error:', error);
            showErrorToast('Error generating PDF: ' + error.message);
        }
    });

    // Print Function with Dynamic Sr.No
    $('#printBtn').on('click', function () {
        var result = getSelectedRowsData();
        if (result.data.length === 0) {
            showErrorToast('Please select at least one row to print.');
            return;
        }

        // Generate Print headers with Sr No as first column
        var printHeaders = ['Sr No'];
        result.headers.forEach(function (header) {
            if (header.toLowerCase() !== 'sr no' && header.toLowerCase() !== 'sr.no' && header.toLowerCase() !== 'serial number') {
                printHeaders.push(header);
            }
        });

        var printContent = '<html><head><title>Active Customers Report</title>';
        printContent += '<style>';
        printContent += 'body{font-family:Arial,sans-serif;margin:20px;}';
        printContent += 'table{border-collapse:collapse;width:100%;margin-top:20px;}';
        printContent += 'th,td{border:1px solid #ddd;padding:8px;text-align:left;}';
        printContent += 'th{background-color:#f2f2f2;font-weight:bold;text-align:center;}';
        printContent += 'td:first-child{text-align:center;}';
        printContent += '@@media print{body{margin:0;}}';
        printContent += '</style>';
        printContent += '</head><body>';
        printContent += '<h2>Active Customers Report</h2>';
        printContent += '<p>Generated on: ' + new Date().toLocaleDateString() + ' | Total Records: ' + result.data.length + '</p>';
        printContent += '<table><thead><tr>';

        printHeaders.forEach(function (header) {
            printContent += '<th>' + header + '</th>';
        });
        printContent += '</tr></thead><tbody>';

        // Generate Print data with dynamic Sr.No
        result.data.forEach(function (row, index) {
            printContent += '<tr>';
            printContent += '<td>' + (index + 1) + '</td>'; // Dynamic Sr.No

            row.forEach(function (cell, cellIndex) {
                var headerName = result.headers[cellIndex];
                if (headerName && headerName.toLowerCase() !== 'sr no' && headerName.toLowerCase() !== 'sr.no' && headerName.toLowerCase() !== 'serial number') {
                    printContent += '<td>' + cell + '</td>';
                }
            });

            printContent += '</tr>';
        });
        printContent += '</tbody></table></body></html>';

        var printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.print();
        printWindow.close();

        showSuccessToast('Print dialog opened! (' + result.data.length + ' rows)');
    });
</script>