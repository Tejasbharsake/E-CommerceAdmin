@model IEnumerable<GSTECommerceLibrary.Admin.Admin>

@{
    ViewBag.Title = "_TotalOrdersANB";
}

<!-- Font Awesome for Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<!-- jsPDF CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- jsPDF AutoTable plugin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<!-- Export Buttons Row -->
<div class="row mb-3">
    <div class="col-12 d-flex gap-2 justify-content-end">
        <button class="btn btn-outline-primary btn-sm" id="copyBtnTotalOrders" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Copy to clipboard">
            <img src="~/Content/Document/Image/Copy.png" alt="Copy" width="16" height="16" />
        </button>
        <button class="btn btn-outline-info btn-sm" id="csvBtnTotalOrders" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Export as CSV file">
            <img src="~/Content/Document/Image/CSV.png" alt="CSV" width="16" height="16" />
        </button>
        <button class="btn btn-outline-success btn-sm" id="excelBtnTotalOrders" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Export as Excel file">
            <img src="~/Content/Document/Image/XLS.png" alt="Excel" width="16" height="16" />
        </button>
        <button class="btn btn-outline-danger btn-sm" id="pdfBtnTotalOrders" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Export as PDF file">
            <img src="~/Content/Document/Image/PDFicon.png" alt="PDF" width="16" height="16" />
        </button>
        <button class="btn btn-outline-dark btn-sm" id="printBtnTotalOrders" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Print">
            <img src="~/Content/Document/Image/Print.png" alt="Print" width="16" height="16" />
        </button>
    </div>
</div>

<div class="card-body">
    @if (Model != null && Model.Any())
    {
        <div class="table-responsive">
            <table id="totalOrdersTable" class="table table-striped table-bordered align-middle">
                <thead class="table-dark">
                    <tr>
                        <th><input type="checkbox" id="selectAllTotalOrders" /></th>
                        <th>Sr No</th>
                        <th>Order Code</th>
                        <th>Customer Name</th>
                        <th>Product Name</th>
                        <th>Quantity</th>
                        <th>Product MRP(₹)</th>
                        <th>Actual Price(₹)</th>
                        <th>Status</th>
                        <th>Order Date</th>
                    </tr>
                </thead>
                <tbody>
                    @{ var srNo = 1; }
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td><input type="checkbox" class="row-checkbox" value="@srNo" /></td>
                            <td>@srNo</td>
                            <td>@(item.OrderCode ?? "N/A")</td>
                            <td>@(item.CustomerName ?? "N/A")</td>
                            <td>@(item.ProductName ?? "N/A")</td>
                            <td>@(item.Quantity != null ? item.Quantity.ToString() : "N/A")</td>
                            <td>@(item.ProductMRP != null ? item.ProductMRP.ToString() : "N/A")</td>
                            <td>@(item.ActualProductPrice != null ? item.ActualProductPrice.ToString() : "N/A")</td>
                            <td>
                                @if (!string.IsNullOrEmpty(item.Status))
                                {
                                    if (item.Status.ToLower() == "active")
                                    {
                                        <span class="badge bg-success">@item.Status</span>
                                    }
                                    else if (item.Status.ToLower() == "cancelled")
                                    {
                                        <span class="badge bg-danger">@item.Status</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">@item.Status</span>
                                    }
                                }
                                else
                                {
                                    <span>N/A</span>
                                }
                            </td>
                            <td>
                                @(item.OrderDate != DateTime.MinValue
                                    ? item.OrderDate.ToString("dd-MM-yyyy", System.Globalization.CultureInfo.InvariantCulture)
                                    : "N/A")
                            </td>
                        </tr>
                        srNo++;
                    }
                </tbody>
            </table>
        </div>

        <!-- Toast Notification HTML -->
        <div class="position-fixed end-0 p-3" style="z-index: 11; top: 60px;">
            <div id="liveToastTotalOrders" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <span id="toastMessageTotalOrders"></span>
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-warning mb-0">No orders found.</div>
    }
</div>

<style>
    #totalOrdersTable thead th {
        background-color: #2C3E50;
        color: #FFFFFF;
        font-weight: 600;
        text-align: center;
        padding: 5px;
        border-bottom: 2px solid #ddd;
        font-size: 14px;
        height: 8px !important;
        font-family: 'Poppins', sans-serif;
        vertical-align: middle;
    }

    #totalOrdersTable tbody td {
        padding: 2px 5px !important;
        height: 5px !important;
        line-height: 1;
        font-size: 13px;
        text-align: center;
        font-family: 'Poppins', sans-serif;
        vertical-align: middle;
    }

    #totalOrdersTable .pagination .page-link {
        padding: 2px 10px;
        font-size: 12px;
        min-width: 33px;
    }

    .card-header .btn-sm {
        padding: 0.25rem 0.4rem;
        margin-left: 0.5rem;
    }

    .card-header .d-flex {
        flex-wrap: nowrap;
    }

    .selected-row {
        background-color: #e3f2fd !important;
    }

    #selectAllTotalOrders, .row-checkbox {
        cursor: pointer;
    }

    @@media (max-width: 576px) {
        .card-header .d-flex {
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .card-header .btn-sm {
            margin-left: 0.25rem;
        }
    }
</style>

<script>
    (function () {
        // ===== TOTAL-ORDERS-SPECIFIC TOAST FUNCTIONS =====
        function showErrorToast(message) {
            $('#toastMessageTotalOrders').text(message);
            $('#liveToastTotalOrders').removeClass('bg-success').addClass('bg-danger');
            var toastEl = document.getElementById('liveToastTotalOrders');
            var toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        //function showSuccessToast(message) {
        //    $('#toastMessageTotalOrders').text(message);
        //    $('#liveToastTotalOrders').removeClass('bg-danger').addClass('bg-success');
        //    var toastEl = document.getElementById('liveToastTotalOrders');
        //    var toast = new bootstrap.Toast(toastEl);
        //    toast.show();
        //}

        // ===== GLOBAL VARIABLES =====
        var dataTable;
        var allTableData = [];
        var selectedRowIds = new Set();
        var tableHeaders = [];

        // ===== UTILITY FUNCTIONS =====
        function storeAllTableData() {
            tableHeaders = [];
            $('#totalOrdersTable thead tr th').each(function (index) {
                if (index > 0) {
                    tableHeaders.push($(this).text().trim());
                }
            });

            allTableData = [];
            $('#totalOrdersTable tbody tr').each(function () {
                var rowData = [];
                var rowId = $(this).find('.row-checkbox').val();

                $(this).find('td').each(function (index) {
                    if (index > 0) {
                        var cellText = $(this).text().trim().replace(/\s+/g, ' ');
                        rowData.push(cellText);
                    }
                });

                if (rowData.length > 0) {
                    allTableData.push({
                        id: rowId,
                        data: rowData
                    });
                }
            });
        }

        function getSelectedRowsData() {
            var selectedData = [];
            allTableData.forEach(function (row) {
                if (selectedRowIds.has(row.id)) {
                    selectedData.push(row.data);
                }
            });
            return { headers: tableHeaders, data: selectedData };
        }

        // ===== FIXED CHECKBOX FUNCTIONS =====
        function initializeCheckboxes() {
            console.log('Initializing checkboxes for totalOrdersTable...');

            // Remove any existing handlers first
            $(document).off('click', '#selectAllTotalOrders');
            $(document).off('change', '#totalOrdersTable .row-checkbox');

            // Select All functionality with event delegation
            $(document).on('click', '#selectAllTotalOrders', function (e) {
                e.stopPropagation();
                console.log('Select All clicked for totalOrdersTable');

                var isChecked = $(this).is(':checked');

                if (isChecked) {
                    allTableData.forEach(function (row) {
                        selectedRowIds.add(row.id);
                    });

                    $('#totalOrdersTable .row-checkbox').each(function () {
                        $(this).prop('checked', true);
                        $(this).closest('tr').addClass('selected-row');
                    });

                    console.log('All rows selected for totalOrdersTable:', selectedRowIds.size);
                   // showSuccessToast(`All ${allTableData.length} rows selected across all pages`);
                } else {
                    selectedRowIds.clear();

                    $('#totalOrdersTable .row-checkbox').each(function () {
                        $(this).prop('checked', false);
                        $(this).closest('tr').removeClass('selected-row');
                    });

                    console.log('All selections cleared for totalOrdersTable');
                   // showSuccessToast('All selections cleared');
                }

                updateSelectAllCheckbox();
            });

            // Individual checkbox selection with event delegation
            $(document).on('change', '#totalOrdersTable .row-checkbox', function (e) {
                e.stopPropagation();

                var row = $(this).closest('tr');
                var rowId = $(this).val();
                var isChecked = $(this).is(':checked');

                console.log('Row checkbox changed for totalOrdersTable:', rowId, 'checked:', isChecked);

                if (isChecked) {
                    selectedRowIds.add(rowId);
                    row.addClass('selected-row');
                } else {
                    selectedRowIds.delete(rowId);
                    row.removeClass('selected-row');
                }

                updateSelectAllCheckbox();
            });

            // Maintain selections when changing pages
            $('#totalOrdersTable .row-checkbox').each(function() {
                var rowId = $(this).val();
                if (selectedRowIds.has(rowId)) {
                    $(this).prop('checked', true);
                    $(this).closest('tr').addClass('selected-row');
                } else {
                    $(this).prop('checked', false);
                    $(this).closest('tr').removeClass('selected-row');
                }
            });

            updateSelectAllCheckbox();
            console.log('Checkbox initialization complete for totalOrdersTable');
        }

        function updateSelectAllCheckbox() {
            var totalRows = allTableData.length;
            var selectedCount = selectedRowIds.size;

            console.log('Updating select all checkbox. Total:', totalRows, 'Selected:', selectedCount);

            var selectAllCheckbox = $('#selectAllTotalOrders');

            if (selectedCount === 0) {
                selectAllCheckbox.prop('checked', false).prop('indeterminate', false);
            } else if (selectedCount === totalRows) {
                selectAllCheckbox.prop('checked', true).prop('indeterminate', false);
            } else {
                selectAllCheckbox.prop('checked', false).prop('indeterminate', true);
            }
        }

        // ===== EXPORT FUNCTIONS =====
        function exportTable(exportType) {
            var result = getSelectedRowsData();
            if (result.data.length === 0) {
                showErrorToast('Please select at least one row to export.');
                return;
            }

            var exportHeaders = ['Sr No'];
            result.headers.forEach(function (header) {
                if (header.toLowerCase() !== 'sr no' && header.toLowerCase() !== 'sr.no' && header.toLowerCase() !== 'serial number') {
                    exportHeaders.push(header);
                }
            });

            if (exportType === 'copy') {
                var copyText = exportHeaders.join('\t') + '\n';
                result.data.forEach(function (row, index) {
                    var copyRow = [index + 1];
                    row.forEach(function (cell, cellIndex) {
                        var headerName = result.headers[cellIndex];
                        if (headerName && headerName.toLowerCase() !== 'sr no' && headerName.toLowerCase() !== 'sr.no' && headerName.toLowerCase() !== 'serial number') {
                            copyRow.push(cell);
                        }
                    });
                    copyText += copyRow.join('\t') + '\n';
                });

                navigator.clipboard.writeText(copyText).then(function () {
                    showSuccessToast('Data copied to clipboard! (' + result.data.length + ' rows)');
                }).catch(function () {
                    showErrorToast('Copy failed. Please try again.');
                });
            } else if (exportType === 'csv') {
                var csvContent = exportHeaders.join(',') + '\n';
                result.data.forEach(function (row, index) {
                    var csvRow = [index + 1];
                    row.forEach(function (cell, cellIndex) {
                        var headerName = result.headers[cellIndex];
                        if (headerName && headerName.toLowerCase() !== 'sr no' && headerName.toLowerCase() !== 'sr.no' && headerName.toLowerCase() !== 'serial number') {
                            csvRow.push('"' + cell.replace(/"/g, '""') + '"');
                        }
                    });
                    csvContent += csvRow.join(',') + '\n';
                });

                var blob = new Blob([csvContent], { type: 'text/csv' });
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'total_orders_' + new Date().getTime() + '.csv';
                a.click();
                window.URL.revokeObjectURL(url);
              //  showSuccessToast('CSV file downloaded! (' + result.data.length + ' rows)');
            } else if (exportType === 'excel') {
                var excelContent = '<table border="1"><thead><tr>';
                exportHeaders.forEach(function (header) {
                    excelContent += '<th>' + header + '</th>';
                });
                excelContent += '</tr></thead><tbody>';

                result.data.forEach(function (row, index) {
                    excelContent += '<tr>';
                    excelContent += '<td>' + (index + 1) + '</td>';
                    row.forEach(function (cell, cellIndex) {
                        var headerName = result.headers[cellIndex];
                        if (headerName && headerName.toLowerCase() !== 'sr no' && headerName.toLowerCase() !== 'sr.no' && headerName.toLowerCase() !== 'serial number') {
                            excelContent += '<td>' + cell + '</td>';
                        }
                    });
                    excelContent += '</tr>';
                });
                excelContent += '</tbody></table>';

                var blob = new Blob([excelContent], { type: 'application/vnd.ms-excel' });
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'total_orders_' + new Date().getTime() + '.xls';
                a.click();
                window.URL.revokeObjectURL(url);
                //showSuccessToast('Excel file downloaded! (' + result.data.length + ' rows)');
            } else if (exportType === 'pdf') {
                if (typeof window.jspdf === 'undefined') {
                    showErrorToast('jsPDF library is not loaded.');
                    return;
                }

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(24);
                    doc.setTextColor(0, 0, 0);
                    const pageWidth = doc.internal.pageSize.getWidth();
                    doc.text("RahiShop", pageWidth / 2, 25, { align: 'center' });

                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(16);
                    doc.setTextColor(80, 80, 80);
                    doc.text("Total Orders Report", pageWidth / 2, 35, { align: 'center' });

                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    const currentDateTime = new Date().toLocaleString('en-GB', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    }).replace(',', '');
                    doc.text("Generated On: " + currentDateTime, pageWidth - 15, 35, { align: 'right' });
                    doc.text("Total Records: " + result.data.length, pageWidth - 15, 42, { align: 'right' });

                    if (typeof doc.autoTable === 'function') {
                        var pdfHeaders = ['Sr No'];
                        result.headers.forEach(function (header) {
                            if (header.toLowerCase() !== 'sr no' && header.toLowerCase() !== 'sr.no' && header.toLowerCase() !== 'serial number') {
                                pdfHeaders.push(header);
                            }
                        });

                        var pdfData = [];
                        result.data.forEach(function (row, index) {
                            var pdfRow = [index + 1];
                            row.forEach(function (cell, cellIndex) {
                                var headerName = result.headers[cellIndex];
                                if (headerName && headerName.toLowerCase() !== 'sr no' && headerName.toLowerCase() !== 'sr.no' && headerName.toLowerCase() !== 'serial number') {
                                    pdfRow.push(cell);
                                }
                            });
                            pdfData.push(pdfRow);
                        });

                        doc.autoTable({
                            head: [pdfHeaders],
                            body: pdfData,
                            startY: 55,
                            styles: {
                                fontSize: 8,
                                cellPadding: 4,
                                lineColor: [255, 255, 255],
                                lineWidth: 0,
                                textColor: [0, 0, 0],
                                fontStyle: 'normal'
                            },
                            headStyles: {
                                fillColor: [33, 150, 243],
                                textColor: [255, 255, 255],
                                fontStyle: 'bold',
                                halign: 'center',
                                fontSize: 9,
                                cellPadding: 5,
                                lineColor: [255, 255, 255],
                                lineWidth: 0
                            },
                            bodyStyles: {
                                halign: 'center',
                                fontSize: 8,
                                lineColor: [255, 255, 255],
                                lineWidth: 0
                            },
                            alternateRowStyles: {
                                fillColor: [248, 249, 250],
                                lineColor: [255, 255, 255],
                                lineWidth: 0
                            },
                            margin: {
                                top: 10,
                                right: 15,
                                bottom: 15,
                                left: 15
                            },
                            columnStyles: {
                                0: {
                                    halign: 'center',
                                    cellWidth: 15,
                                    fontStyle: 'bold',
                                    lineColor: [255, 255, 255],
                                    lineWidth: 0
                                }
                            },
                            theme: 'plain',
                            tableLineColor: [255, 255, 255],
                            tableLineWidth: 0
                        });
                    }

                    const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '').replace('T', '_');
                    const filename = 'RahiShop_TotalOrdersReport_' + timestamp + '.pdf';
                    doc.save(filename);
                   // showSuccessToast('PDF generated successfully! (' + result.data.length + ' records)');
                } catch (error) {
                    console.error('PDF Generation Error:', error);
                    showErrorToast('Error generating PDF: ' + error.message);
                }
            } else if (exportType === 'print') {
                var printContent = '<html><head><title>Total Orders Report</title>';
                printContent += '<style>body{font-family:Arial,sans-serif;margin:20px;}table{border-collapse:collapse;width:100%;margin-top:20px;}th,td{border:1px solid #ddd;padding:8px;text-align:left;}th{background-color:#f2f2f2;font-weight:bold;text-align:center;}td:first-child{text-align:center;}@@media print{body{margin:0;}}</style>';
                printContent += '</head><body>';
                printContent += '<h2>Total Orders Report</h2>';
                printContent += '<p>Generated on: ' + new Date().toLocaleDateString() + ' | Total Records: ' + result.data.length + '</p>';
                printContent += '<table><thead><tr>';

                exportHeaders.forEach(function (header) {
                    printContent += '<th>' + header + '</th>';
                });
                printContent += '</tr></thead><tbody>';

                result.data.forEach(function (row, index) {
                    printContent += '<tr>';
                    printContent += '<td>' + (index + 1) + '</td>';
                    row.forEach(function (cell, cellIndex) {
                        var headerName = result.headers[cellIndex];
                        if (headerName && headerName.toLowerCase() !== 'sr no' && headerName.toLowerCase() !== 'sr.no' && headerName.toLowerCase() !== 'serial number') {
                            printContent += '<td>' + cell + '</td>';
                        }
                    });
                    printContent += '</tr>';
                });
                printContent += '</tbody></table></body></html>';

                var printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.print();
                printWindow.close();
                //showSuccessToast('Print dialog opened! (' + result.data.length + ' rows)');
            }
        }

        // ===== FIXED EVENT DELEGATION FOR EXPORT BUTTONS =====
        $(document).on('click', '#copyBtnTotalOrders', function(e) {
            e.preventDefault();
            exportTable('copy');
        });

        $(document).on('click', '#csvBtnTotalOrders', function(e) {
            e.preventDefault();
            exportTable('csv');
        });

        $(document).on('click', '#excelBtnTotalOrders', function(e) {
            e.preventDefault();
            exportTable('excel');
        });

        $(document).on('click', '#pdfBtnTotalOrders', function(e) {
            e.preventDefault();
            exportTable('pdf');
        });

        $(document).on('click', '#printBtnTotalOrders', function(e) {
            e.preventDefault();
            exportTable('print');
        });

        // ===== DOCUMENT READY =====
        $(document).ready(function () {
            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                new bootstrap.Tooltip(tooltipTriggerEl);
            });

            if ($('#totalOrdersTable').length > 0) {
                storeAllTableData();
                initializeDataTable();
                initializeCheckboxes();
            }
        });

        function initializeDataTable() {
            if ($.fn.DataTable.isDataTable('#totalOrdersTable')) {
                dataTable.destroy();
            }

            dataTable = $('#totalOrdersTable').DataTable({
                paging: true,
                pageLength: 10,
                lengthChange: false,
                lengthMenu: [10, 25, 50, 100],
                searching: true,
                ordering: false,
                info: true,
                autoWidth: false,
                responsive: true,
                order: [[9, 'desc']], // Order by Order Date (column 9 after checkbox and Sr No)
                language: {
                    search: "Search:",
                    searchPlaceholder: "Type to search...",
                    lengthMenu: "",
                    paginate: {
                        first: "First",
                        last: "Last",
                        next: "Next",
                        previous: "Previous"
                    }
                },
                columnDefs: [
                    { orderable: false, targets: 0, width: "50px" },
                    { orderable: false, targets: 1, width: "50px" }
                ],
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>><"row"<"col-sm-12"tr>><"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                drawCallback: function (settings) {
                    initializeCheckboxes();
                    // Re-initialize tooltips after draw
                    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                        new bootstrap.Tooltip(tooltipTriggerEl);
                    });
                },
                initComplete: function (settings, json) {
                    initializeCheckboxes();
                    $('.dataTables_length label').contents().filter(function () {
                        return this.nodeType === 3;
                    }).remove();
                }
            });
        }
    })();
</script>