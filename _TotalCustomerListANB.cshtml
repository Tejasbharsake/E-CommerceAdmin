@model IEnumerable<GSTECommerceLibrary.Admin.Admin>

<!-- Font Awesome for Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<!-- jsPDF CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- jsPDF AutoTable plugin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<div class="card mt-0">
    <div class="card-body">
        @if (Model != null && Model.Any())
        {
            <!-- Export Buttons Row -->
            <div class="row mb-3">
                <div class="col-12 d-flex gap-2 justify-content-end">
                    <button class="btn btn-outline-primary btn-sm" id="copyBtnTotalOrders" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy to clipboard">
                        <img src="~/Content/Document/Image/Copy.png" alt="Copy" width="16" height="16" />
                    </button>
                    <button class="btn btn-outline-info btn-sm" id="csvBtnTotalOrders" data-bs-toggle="tooltip" data-bs-placement="top" title="Export as CSV file">
                        <img src="~/Content/Document/Image/CSV.png" alt="CSV" width="16" height="16" />
                    </button>
                    <button class="btn btn-outline-success btn-sm" id="excelBtnTotalOrders" data-bs-toggle="tooltip" data-bs-placement="top" title="Export as Excel file">
                        <img src="~/Content/Document/Image/XLS.png" alt="Excel" width="16" height="16" />
                    </button>
                    <button class="btn btn-outline-danger btn-sm" id="pdfBtnTotalOrders" data-bs-toggle="tooltip" data-bs-placement="top" title="Export as PDF file">
                        <img src="~/Content/Document/Image/PDFicon.png" alt="PDF" width="16" height="16" />
                    </button>
                    <button class="btn btn-outline-dark btn-sm" id="printBtnTotalOrders" data-bs-toggle="tooltip" data-bs-placement="top" title="Print">
                        <img src="~/Content/Document/Image/Print.png" alt="Print" width="16" height="16" />
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table id="totalOrdersTable" class="table table-striped table-bordered align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th><input type="checkbox" id="selectAllTotalOrders" /></th>
                            <th>Sr No</th>
                            <th>Customer Code</th>
                            <th>Customer Name</th>
                            <th>Email</th>
                            <th>Mobile No</th>
                            <th>Total Order</th>

                        </tr>
                    </thead>
                    <tbody>
                        @{ var srNo = 1; }
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td><input type="checkbox" class="row-checkbox" value="@srNo" /></td>
                                <td>@srNo</td>
                                <td>@(item.CustomerCode)</td>
                                <td>@(item.CustomerName)</td>
                                <td>@item.EmailAddress</td>
                                <td>+91 @(item.CustomerPhone)</td>
                                <td>@item.TotalOrder</td>
                            </tr>
                            srNo++;
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="alert alert-warning mb-0">No orders found.</div>
        }
    </div>
</div>

<style>
    #totalOrdersTable thead th {
        background-color: #2C3E50;
        color: #FFFFFF;
        font-weight: 600;
        text-align: center;
        padding: 5px;
        border-bottom: 2px solid #ddd;
        font-size: 14px;
        height: 8px !important;
        font-family: 'Poppins', sans-serif;
        vertical-align: middle;
    }

    #totalOrdersTable tbody td {
        padding: 2px 5px !important;
        height: 5px !important;
        line-height: 1;
        font-size: 13px;
        text-align: center;
        font-family: 'Poppins', sans-serif;
        vertical-align: middle;
    }

    #totalOrdersTable_paginate .pagination .page-link {
        padding: 2px 10px;
        font-size: 12px;
        min-width: 33px;
    }

    .btn-outline-primary, .btn-outline-info, .btn-outline-success, .btn-outline-danger, .btn-outline-dark {
        transition: none !important;
    }

        .btn-outline-primary:hover, .btn-outline-info:hover, .btn-outline-success:hover, .btn-outline-danger:hover, .btn-outline-dark:hover {
            background-color: transparent !important;
            border-color: inherit !important;
            color: inherit !important;
            box-shadow: none !important;
        }

    .selected-row {
        background-color: #e3f2fd !important;
    }

    .row-checkbox, #selectAllTotalOrders {
        cursor: pointer;
    }

    .dataTables_length {
        display: none;
    }
</style>

<script>
    // Global variables for DataTable
    var dataTable;
    var allTableData = [];
    var selectedRowIds = new Set();
    var tableHeaders = [];

    $(document).ready(function () {
        storeAllTableData();
        initializeDataTable();
        initializeCheckboxes();
    });

    function storeAllTableData() {
        tableHeaders = [];
        $('#totalOrdersTable thead tr th').each(function (index) {
            if (index > 0) {
                tableHeaders.push($(this).text().trim());
            }
        });

        allTableData = [];
        $('#totalOrdersTable tbody tr').each(function () {
            var rowData = [];
            var rowId = $(this).find('.row-checkbox').val();

            $(this).find('td').each(function (index) {
                if (index > 0) {
                    var cellText = $(this).text().trim().replace(/\s+/g, ' ');
                    rowData.push(cellText);
                }
            });

            if (rowData.length > 0) {
                allTableData.push({
                    id: rowId,
                    data: rowData
                });
            }
        });
    }

    function initializeDataTable() {
        if ($.fn.DataTable.isDataTable('#totalOrdersTable')) {
            dataTable.destroy();
        }

        dataTable = $('#totalOrdersTable').DataTable({
            paging: true,
            pageLength: 10,
            lengthChange: true,
            lengthMenu: [10, 25, 50, 100],
            searching: true,
            ordering: false,
            info: true,
            autoWidth: false,
            responsive: true,
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>><"row"<"col-sm-12"tr>><"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
            language: {
                search: "Search:",
                searchPlaceholder: "Type to search",
                lengthMenu: "",
                paginate: {
                    first: "First",
                    last: "Last",
                    next: "Next",
                    previous: "Previous"
                }
            },
            drawCallback: function (settings) {
                initializeCheckboxes();
            },
            initComplete: function (settings, json) {
                initializeCheckboxes();
                $('.dataTables_length label').contents().filter(function () {
                    return this.nodeType === 3;
                }).remove();
            }
        });
    }

    function initializeCheckboxes() {
        var $modalTable = $('#totalOrdersTable');
        $modalTable.find('#selectAllTotalOrders').off('click').on('click', function () {
            var isChecked = $(this).is(':checked');
            $modalTable.find('.row-checkbox').prop('checked', isChecked);

            if (isChecked) {
                allTableData.forEach(function (row) {
                    selectedRowIds.add(row.id);
                });
                $modalTable.find('.row-checkbox').each(function () {
                    $(this).closest('tr').addClass('selected-row');
                });
            } else {
                selectedRowIds.clear();
                $modalTable.find('tr').removeClass('selected-row');
            }
        });

        $modalTable.find('.row-checkbox').off('change').on('change', function () {
            var row = $(this).closest('tr');
            var rowId = $(this).val();
            var isChecked = $(this).is(':checked');

            if (isChecked) {
                selectedRowIds.add(rowId);
                row.addClass('selected-row');
            } else {
                selectedRowIds.delete(rowId);
                row.removeClass('selected-row');
            }

            updateSelectAllCheckbox();
        });

        $modalTable.find('.row-checkbox').each(function () {
            var rowId = $(this).val();
            if (selectedRowIds.has(rowId)) {
                $(this).prop('checked', true);
                $(this).closest('tr').addClass('selected-row');
            }
        });

        updateSelectAllCheckbox();
    }

    function updateSelectAllCheckbox() {
        var totalRows = allTableData.length;
        var selectedCount = selectedRowIds.size;

        if (selectedCount === 0) {
            $('#selectAllTotalOrders').prop('checked', false).prop('indeterminate', false);
        } else if (selectedCount === totalRows) {
            $('#selectAllTotalOrders').prop('checked', true).prop('indeterminate', false);
        } else {
            $('#selectAllTotalOrders').prop('checked', false).prop('indeterminate', true);
        }
    }

    function getSelectedRowsData() {
        var selectedData = [];
        allTableData.forEach(function (row) {
            if (selectedRowIds.has(row.id)) {
                selectedData.push(row.data);
            }
        });
        return { headers: tableHeaders, data: selectedData };
    }

    $('#copyBtnTotalOrders').on('click', function () {
        var result = getSelectedRowsData();
        if (result.data.length === 0) {
            showErrorToast('Please select at least one row to copy.');
            return;
        }

        var copyHeaders = ['Sr No'];
        result.headers.forEach(function (header) {
            if (header.toLowerCase() !== 'sr no' && header.toLowerCase() !== 'sr.no' && header.toLowerCase() !== 'serial number') {
                copyHeaders.push(header);
            }
        });

        var copyText = copyHeaders.join('\t') + '\n';
        result.data.forEach(function (row, index) {
            var copyRow = [index + 1];
            row.forEach(function (cell, cellIndex) {
                var headerName = result.headers[cellIndex];
                if (headerName && headerName.toLowerCase() !== 'sr no' && headerName.toLowerCase() !== 'sr.no' && headerName.toLowerCase() !== 'serial number') {
                    copyRow.push(cell);
                }
            });
            copyText += copyRow.join('\t') + '\n';
        });

        navigator.clipboard.writeText(copyText).then(function () {
            showSuccessToast('Data copied to clipboard! (' + result.data.length + ' rows)');
        }).catch(function () {
            showErrorToast('Copy failed. Please try again.');
        });
    });

    $('#csvBtnTotalOrders').on('click', function () {
        var result = getSelectedRowsData();
        if (result.data.length === 0) {
            showErrorToast('Please select at least one row to export.');
            return;
        }

        var csvHeaders = ['Sr No'];
        result.headers.forEach(function (header) {
            if (header.toLowerCase() !== 'sr no' && header.toLowerCase() !== 'sr.no' && header.toLowerCase() !== 'serial number') {
                csvHeaders.push(header);
            }
        });

        var csvContent = csvHeaders.join(',') + '\n';
        result.data.forEach(function (row, index) {
            var csvRow = [index + 1];
            row.forEach(function (cell, cellIndex) {
                var headerName = result.headers[cellIndex];
                if (headerName && headerName.toLowerCase() !== 'sr no' && headerName.toLowerCase() !== 'sr.no' && headerName.toLowerCase() !== 'serial number') {
                    csvRow.push('"' + cell.replace(/"/g, '""') + '"');
                }
            });
            csvContent += csvRow.join(',') + '\n';
        });

        var blob = new Blob([csvContent], { type: 'text/csv' });
        var url = window.URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'customer_report_' + new Date().getTime() + '.csv';
        a.click();
        window.URL.revokeObjectURL(url);
        showSuccessToast('CSV file downloaded! (' + result.data.length + ' rows)');
    });

    $('#excelBtnTotalOrders').on('click', function () {
        var result = getSelectedRowsData();
        if (result.data.length === 0) {
            showErrorToast('Please select at least one row to export.');
            return;
        }

        var excelHeaders = ['Sr No'];
        result.headers.forEach(function (header) {
            if (header.toLowerCase() !== 'sr no' && header.toLowerCase() !== 'sr.no' && header.toLowerCase() !== 'serial number') {
                excelHeaders.push(header);
            }
        });

        var excelContent = '<table border="1"><thead><tr>';
        excelHeaders.forEach(function (header) {
            excelContent += '<th>' + header + '</th>';
        });
        excelContent += '</tr></thead><tbody>';

        result.data.forEach(function (row, index) {
            excelContent += '<tr>';
            excelContent += '<td>' + (index + 1) + '</td>';
            row.forEach(function (cell, cellIndex) {
                var headerName = result.headers[cellIndex];
                if (headerName && headerName.toLowerCase() !== 'sr no' && headerName.toLowerCase() !== 'sr.no' && headerName.toLowerCase() !== 'serial number') {
                    excelContent += '<td>' + cell + '</td>';
                }
            });
            excelContent += '</tr>';
        });
        excelContent += '</tbody></table>';

        var blob = new Blob([excelContent], { type: 'application/vnd.ms-excel' });
        var url = window.URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'customer_report_' + new Date().getTime() + '.xls';
        a.click();
        window.URL.revokeObjectURL(url);
        showSuccessToast('Excel file downloaded! (' + result.data.length + ' rows)');
    });

    $('#pdfBtnTotalOrders').on('click', function () {
        var result = getSelectedRowsData();
        if (result.data.length === 0) {
            showErrorToast('Please select at least one row to export.');
            return;
        }

        if (typeof window.jspdf === 'undefined') {
            showErrorToast('jsPDF library is not loaded. Please include jsPDF library.');
            return;
        }

        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFont("helvetica", "bold");
            doc.setFontSize(24);
            doc.setTextColor(0, 0, 0);
            const pageWidth = doc.internal.pageSize.getWidth();
            doc.text("RahiShop", pageWidth / 2, 25, { align: 'center' });

            doc.setFont("helvetica", "normal");
            doc.setFontSize(16);
            doc.setTextColor(80, 80, 80);
            doc.text("Customer Management", pageWidth / 2, 35, { align: 'center' });

            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            const currentDateTime = new Date().toLocaleString('en-GB', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).replace(',', '');
            doc.text("Generated On: " + currentDateTime, pageWidth - 15, 35, { align: 'right' });
            doc.text("Total Records: " + result.data.length, pageWidth - 15, 42, { align: 'right' });

            if (typeof doc.autoTable === 'function') {
                var pdfData = [];
                var pdfHeaders = ['Sr No'];
                result.headers.forEach(function (header) {
                    if (header.toLowerCase() !== 'sr no' && header.toLowerCase() !== 'sr.no' && header.toLowerCase() !== 'serial number') {
                        pdfHeaders.push(header);
                    }
                });

                result.data.forEach(function (row, index) {
                    var pdfRow = [index + 1];
                    row.forEach(function (cell, cellIndex) {
                        var headerName = result.headers[cellIndex];
                        if (headerName && headerName.toLowerCase() !== 'sr no' && headerName.toLowerCase() !== 'sr.no' && headerName.toLowerCase() !== 'serial number') {
                            pdfRow.push(cell);
                        }
                    });
                    pdfData.push(pdfRow);
                });

                doc.autoTable({
                    head: [pdfHeaders],
                    body: pdfData,
                    startY: 55,
                    styles: {
                        fontSize: 8,
                        cellPadding: 4,
                        lineColor: [255, 255, 255],
                        lineWidth: 0,
                        textColor: [0, 0, 0],
                        fontStyle: 'normal'
                    },
                    headStyles: {
                        fillColor: [33, 150, 243],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        halign: 'center',
                        fontSize: 9,
                        cellPadding: 5,
                        lineColor: [255, 255, 255],
                        lineWidth: 0
                    },
                    bodyStyles: {
                        halign: 'center',
                        fontSize: 8,
                        lineColor: [255, 255, 255],
                        lineWidth: 0
                    },
                    alternateRowStyles: {
                        fillColor: [248, 249, 250],
                        lineColor: [255, 255, 255],
                        lineWidth: 0
                    },
                    margin: {
                        top: 10,
                        right: 15,
                        bottom: 15,
                        left: 15
                    },
                    columnStyles: {
                        0: {
                            halign: 'center',
                            cellWidth: 15,
                            fontStyle: 'bold',
                            lineColor: [255, 255, 255],
                            lineWidth: 0
                        }
                    },
                    theme: 'plain',
                    tableLineColor: [255, 255, 255],
                    tableLineWidth: 0
                });
            } else {
                showErrorToast('autoTable plugin is not loaded.');
                return;
            }

            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '').replace('T', '_');
            const filename = 'RahiShop_CustomerReport_' + timestamp + '.pdf';
            doc.save(filename);
            showSuccessToast('PDF generated successfully! (' + result.data.length + ' records)');
        } catch (error) {
            console.error('PDF Generation Error:', error);
            showErrorToast('Error generating PDF: ' + error.message);
        }
    });

    $('#printBtnTotalOrders').on('click', function () {
        var result = getSelectedRowsData();
        if (result.data.length === 0) {
            showErrorToast('Please select at least one row to print.');
            return;
        }

        var printHeaders = ['Sr No'];
        result.headers.forEach(function (header) {
            if (header.toLowerCase() !== 'sr no' && header.toLowerCase() !== 'sr.no' && header.toLowerCase() !== 'serial number') {
                printHeaders.push(header);
            }
        });

        var printContent = '<html><head><title>Customer Report</title>';
        printContent += '<style>';
        printContent += 'body{font-family:Arial,sans-serif;margin:20px;}';
        printContent += 'table{border-collapse:collapse;width:100%;margin-top:20px;}';
        printContent += 'th,td{border:1px solid #ddd;padding:8px;text-align:left;}';
        printContent += 'th{background-color:#f2f2f2;font-weight:bold;text-align:center;}';
        printContent += 'td:first-child{text-align:center;}';
        printContent += '@@media print{body{margin:0;}}';
        printContent += '</style>';
        printContent += '</head><body>';
        printContent += '<h2>Customer Report</h2>';
        printContent += '<p>Generated on: ' + new Date().toLocaleDateString() + ' | Total Records: ' + result.data.length + '</p>';
        printContent += '<table><thead><tr>';

        printHeaders.forEach(function (header) {
            printContent += '<th>' + header + '</th>';
        });
        printContent += '</tr></thead><tbody>';

        result.data.forEach(function (row, index) {
            printContent += '<tr>';
            printContent += '<td>' + (index + 1) + '</td>';
            row.forEach(function (cell, cellIndex) {
                var headerName = result.headers[cellIndex];
                if (headerName && headerName.toLowerCase() !== 'sr no' && headerName.toLowerCase() !== 'sr.no' && headerName.toLowerCase() !== 'serial number') {
                    printContent += '<td>' + cell + '</td>';
                }
            });
            printContent += '</tr>';
        });
        printContent += '</tbody></table></body></html>';

        var printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.print();
        printWindow.close();
        showSuccessToast('Print dialog opened! (' + result.data.length + ' rows)');
    });
</script>