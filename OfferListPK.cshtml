@model List<GSTECommerceLibrary.Admin.Admin>

@{
    ViewBag.Title = "Offer List";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Breadcrumb {
    <li class="breadcrumb-item active" aria-current="page">
        Add Offer
    </li>
}

<style>
    #offerTable thead th {
        background-color: #2C3E50; /* Solid Navy */
        color: #FFFFFF; /* White text */
        font-weight: 600;
        text-align: center;
        padding: 5px;
        border-bottom: 2px solid #ddd;
        font-size: 14px; /* smaller text */
        height: 8px !important; /* fixed header height */
        font-family: 'Poppins', sans-serif; /* Added font */
        vertical-align: middle;
    }



    /* Reduce body row height */
    #offerTable tbody td {
        padding: 2px 5px !important;
        height: 5px !important;
        line-height: 1;
        font-size: 13px;
        text-align: center;
        font-family: 'Poppins', sans-serif; /* Added font */
        vertical-align: middle;
    }
</style>

<!-- Export Buttons Row -->
<div class="row  align-items-end">
    <div class="col-md-5 mb-3">
        <button id="addOfferBtn" class="btn btn-primary px-3 py-1" style="font-weight: bold;">
            <i class="bi bi-plus-circle"></i>
            Add New Offer
        </button>
    </div>
    <div class="row align-items-center ">

        <!-- Left Side (Filter) -->

        <div class="col-md-6 d-flex align-items-center gap-4">
            <!-- Start Date Range -->
            <div class="d-flex align-items-center">
                <label for="dateRangeFilter"
                       class="form-label fw-semibold small mb-0 me-2"
                       style="white-space: nowrap;">
                    Date Range Filter:
                </label>
                <input class="form-control form-control-sm input-daterange-datepicker"
                       type="text" id="dateRangeFilter" name="daterange"
                       placeholder="Select Date Range" autocomplete="off" />
            </div>


        </div>


        <!-- Right Side (Export Buttons) -->
        <div class="col-md-6 d-flex gap-2 justify-content-md-end justify-content-start mt-3 mt-md-0">
            <button class="btn border-primary btn-sm" id="copyBtn">
                <img src="~/Content/Document/Image/Copy.png" title="Copy to clipboard" alt="Copy" style="width:16px; margin-right:4px;">
            </button>
            <button class="btn border-primary btn-sm" id="csvBtn">
                <img src="~/Content/Document/Image/CSV.png" title="Export as CSV file" alt="CSV" style="width:16px; margin-right:4px;">
            </button>
            <button class="btn border-primary btn-sm" id="excelBtn">
                <img src="~/Content/Document/Image/XLS.png" title="Export as Excel file" alt="Excel" style="width:16px; margin-right:4px;">
            </button>
            <button class="btn border-primary btn-sm" id="pdfBtn">
                <img src="~/Content/Document/Image/PDFicon.png" title="Export as PDF" alt="PDF" style="width:16px; margin-right:4px;">
            </button>
            <button class="btn border-primary btn-sm" id="printBtn">
                <img src="~/Content/Document/Image/Print.png" title="Print" alt="Print" style="width:16px; margin-right:4px;">
            </button>
        </div>
    </div>

</div>

<!-- Date Range Filter Row (Reduced Size) -->
<div class="row mb-2 align-items-end">

</div>


<!-- ✅ Modal structure for Add -->
<div class="modal fade" id="addOfferModal" tabindex="-1" aria-labelledby="addOfferModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="addOfferModalContent">
            <!-- Partial View Content Will Load Here -->
        </div>
    </div>
</div>

<!-- Update Offer Modal -->
<div class="modal fade" id="updateOfferModal" tabindex="-1" aria-labelledby="updateOfferModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="updateOfferModalContent">
            <!-- Partial View Content Will Load Here -->
        </div>
    </div>
</div>

@if (Model != null && Model.Any())




{
    <div class="table-responsive">
        <table id="offerTable" class="table table-striped table-bordered dataTable">
            <thead class="table-borderless">
                <tr>
                    <th><input type="checkbox" id="selectAll" /></th>
                    <th>Sr No</th>
                    <th>Offer Code</th>
                    <th>Offer Name</th>
                    <th>Product Code</th>
                    <th>Product Name</th>
                    <th>Main Category</th>
                    <th>Sub Category</th>
                    <th>Start Date</th>
                    <th>Duration (Days)</th>
                    <th>Discount (%)</th>
                    <th>Action</th>
                </tr>
            </thead>

            <tbody>
                @{
                    var srNo = 1;
                }
                @foreach (var item in Model)
                {
                    <tr>
                        <td><input type="checkbox" class="offer-checkbox" value="@item.OfferCode" /></td>
                        <td>@srNo</td>
                        <td>@item.OfferCode</td>
                        <td>@item.OfferName</td>
                        <td>@item.ProductCode</td>
                        <td>@item.ProductName</td>
                        <td>@item.MainCategoryName</td>
                        <td>@item.SubCategoryName</td>
                        <td>@(item.OfferStartDate?.ToString("dd-MM-yyyy") ?? "")</td>

                        <td>@item.OfferDuration</td>
                        <td>@item.OfferDiscountPercentage</td>
                        <td>
                            <!-- View Offer -->
                            <button type="button" class="btn btn-link p-0 view-offer-btn"
                                    style="font-size: 1.2rem;"
                                    data-offercode="@item.OfferCode"
                                    title="View Offer">
                                <i class="bi bi-eye text-dark"></i>
                            </button>

                            <!-- Edit Offer -->
                            <button type="button" class="btn btn-link p-0 edit-offer-btn"
                                    style="font-size: 1.2rem;"
                                    data-offercode="@item.OfferCode"
                                    title="Edit Offer">
                                <i class="bi bi-pencil-square text-dark"></i>
                            </button>

                            <!-- Delete Offer -->
                            @*<form asp-action="DeleteOffer" asp-controller="Admin" method="post" style="display:inline;">
                                    <input type="hidden" name="offerCode" value="@item.OfferCode" />
                                    <button type="submit" class="btn btn-link p-0"
                                            style="font-size: 1.2rem;"
                                            onclick="return confirm('Are you sure you want to delete this offer?');"
                                            title="Delete Offer">
                                        <i class="bi bi-trash text-dark"></i>
                                    </button>
                                </form>*@

                            <form asp-action="DeleteOffer" asp-controller="Admin" method="post" class="delete-offer-form" style="display:inline;">
                                <input type="hidden" name="offerCode" value="@item.OfferCode" />
                                <button type="button" class="btn btn-link p-0 delete-offer-btn"
                                        data-offercode="@item.OfferCode"
                                        style="font-size: 1.2rem;"
                                        title="Delete Offer">
                                    <i class="bi bi-trash text-dark"></i>
                                </button>
                            </form>


                        </td>
                    </tr>
                    srNo++;
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="alert alert-info text-center">No offers found.</div>
}

<!-- ✅ Modal structure -->
<div class="modal fade" id="offerDetailsModal" tabindex="-1" aria-labelledby="offerDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" id="offerDetailsBody">
            <!-- Partial View Content Will Load Here -->
        </div>
    </div>
</div>

<!-- Toast Notification HTML -->
<div class="position-fixed end-0 p-3" style="z-index: 11; top: 60px;">
    <div id="liveToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <span id="toastMessage"></span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

@section Styles {
    <!-- DataTables Bootstrap 5 CSS -->
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet" />

    <link href="~/Content/Document/CSS/PDFPK.css" rel="stylesheet" />

    <!-- Daterangepicker CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker@3.1/daterangepicker.css" />

    <link href="~/Content/Document/CSS/TableheadOffer.css" rel="stylesheet" />

}

@section Scripts {

    <!-- 1. jQuery (must be first) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- 2. Moment.js (required by Daterangepicker) -->
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/min/moment.min.js"></script>
    <!-- 3. Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 4. SweetAlert2 (only once) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- 5. DataTables -->
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <!-- 6. Daterangepicker JS (after jQuery and Moment.js) -->
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker@3.1/daterangepicker.min.js"></script>
    <!-- 7. jsPDF for exporting -->
    <script src="~/Content/Document/CustomJS/jspdf.umd.min.js"></script>
    <script src="~/Content/Document/CustomJS/jspdf.plugin.autotable.min.js"></script>

    <script>








        $(document).on("click", ".delete-offer-btn", function () {
            var offerCode = $(this).data("offercode");  // get offer code from button
            var $row = $(this).closest("tr");           // get the table row

            Swal.fire({
                title: "Are you sure?",
                text: "This offer will be permanently deleted!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#d33",
                cancelButtonColor: "#3085d6",
                confirmButtonText: "Yes, delete it!"
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/Admin/DeleteOfferPK', // controller action
                        type: 'POST',
                        data: { offerCode: offerCode }, // send correct variable
                        success: function (response) {
                            if (response.success) {
                                $row.fadeOut(500, function () {
                                    $row.remove(); // remove row from DOM
                                   /* Swal.fire("Deleted!", "Offer has been deleted.", "success");*/

                                    // Optional: reload page after deletion
                                    setTimeout(function () {
                                        location.reload();
                                    }, 1000);
                                });
                            } else {
                                Swal.fire("Error", "Failed to delete offer.", "error");
                            }
                        },
                        error: function () {
                            Swal.fire("Error", "An error occurred while deleting offer.", "error");
                        }
                    });
                }
            });
        });



        // Global variables
        var dataTable;
        var selectedRows = new Set();

        // Toast notification functions
        function showErrorToast(message) {
            $('#toastMessage').text(message);
            $('#liveToast').removeClass('bg-success').addClass('bg-danger');
            var toastEl = document.getElementById('liveToast');
            var toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        function showSuccessToast(message) {
            $('#toastMessage').text(message);
            $('#liveToast').removeClass('bg-danger').addClass('bg-success');
            var toastEl = document.getElementById('liveToast');
            var toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        // Function to parse date from dd-MM-yyyy format to Date object
        function parseDate(dateStr) {
            if (!dateStr) return null;
            var parts = dateStr.split('-');
            if (parts.length === 3) {
                return new Date(parts[2], parts[1] - 1, parts[0]); // year, month-1, day
            }
            return null;
        }

        // Custom date range filtering function for DataTables
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                if (settings.nTable.id !== 'offerTable') {
                    return true;
                }

                var dateRange = $('#dateRangeFilter').val();
                if (!dateRange) {
                    return true; // No filter applied
                }

                var dates = dateRange.split(' - ');
                if (dates.length !== 2) {
                    return true;
                }

                var startDate = moment(dates[0], 'DD/MM/YYYY').toDate();
                var endDate = moment(dates[1], 'DD/MM/YYYY').toDate();

                // Get the date from the Start Date column (index 8)
                var rowDateStr = data[8];
                var rowDate = parseDate(rowDateStr);

                if (!rowDate) {
                    return false;
                }

                return (rowDate >= startDate && rowDate <= endDate);
            }
        );

        $(document).ready(function () {
            // Initialize Date Range Picker
            $('#dateRangeFilter').daterangepicker({
                opens: 'right',
                locale: {
                    format: 'DD/MM/YYYY',
                    separator: ' - ',
                    cancelLabel: 'Clear'
                },
                autoUpdateInput: false
            });

            // Handle date range picker events
            $('#dateRangeFilter').on('apply.daterangepicker', function(ev, picker) {
                $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
                dataTable.draw(); // Redraw the table with filter applied
            });

            $('#dateRangeFilter').on('cancel.daterangepicker', function(ev, picker) {
                $(this).val('');
                dataTable.draw();
            });

            // Clear date filter button
            $('#clearDateFilter').on('click', function() {
                $('#dateRangeFilter').val('');
                dataTable.draw();
            });

            // Check if required libraries are loaded
            if (typeof $.fn.DataTable === 'undefined') {
                console.error('DataTables library is not loaded!');
                alert('DataTables library missing. Please include DataTables JS file.');
                return;
            }

            // Initialize DataTable with export functionality
            //setTimeout(function () {
            //    // Destroy existing DataTable if it exists
            //    if ($.fn.DataTable.isDataTable('#offerTable')) {
            //        $('#offerTable').DataTable().destroy();
            //    }
            //    var dataTable = $('#offerTable').DataTable({
            //        responsive: true,
            //        searching: true,
            //        paging: true,
            //        ordering: false,
            //        info: true,
            //        lengthChange: false,
            //        pageLength: 10,
            //        destroy: true,
            //        autoWidth: false,
            //        scrollX: false,
            //        lengthMenu: [5, 10, 25, 50, 100],
            //        language: {
            //            search: "Search:",
            //            searchPlaceholder: "Type to search..."
            //        },
            //        columnDefs: [
            //            { orderable: false, targets: [0, 5] },
            //            {
            //                targets: 1, // Sr.No column index
            //                render: function (data, type, row, meta) {
            //                    // Continuous serial number across pages
            //                    return meta.row + meta.settings._iDisplayStart + 1;
            //                }
            //            }
            //        ],
            //        drawCallback: function () {
            //            var api = this.api();

            //            // Update Sr.No after search/pagination
            //            var start = api.page.info().start;
            //            api.column(1, { page: 'current' }).nodes().each(function (cell, i) {
            //                cell.innerHTML = start + i + 1;
            //            });

            //            // Restore checkbox states (if you use them)
            //            if (typeof restoreCheckboxStates === "function") restoreCheckboxStates();
            //            if (typeof updateSelectAllState === "function") updateSelectAllState();
            //        }
            //    });

            setTimeout(function () {
                if ($.fn.DataTable.isDataTable('#offerTable')) {
                    $('#offerTable').DataTable().destroy();
                }
                // Assign to the higher-scoped 'dataTable' variable.
                dataTable = $('#offerTable').DataTable({
                    responsive: true,
                            searching: true,
                            paging: true,
                            ordering: false,
                            info: true,
                            lengthChange: false,
                            pageLength: 10,
                            destroy: true,
                            autoWidth: false,
                            scrollX: false,
                            lengthMenu: [5, 10, 25, 50, 100],
                            language: {
                                search: "Search:",
                                searchPlaceholder: "Type to search..."
                            },
                    columnDefs: [
                        { orderable: false, targets: [0, 11] }, // Checkbox and Action columns
                        {
                            targets: 1, // Sr.No column
                            render: function (data, type, row, meta) {
                                return meta.row + meta.settings._iDisplayStart + 1;
                            }
                        }
                    ],
                    drawCallback: function () {
                        var api = this.api();
                        var start = api.page.info().start;
                        api.column(1, { page: 'current' }).nodes().each(function (cell, i) {
                            cell.innerHTML = start + i + 1;
                        });
                        restoreCheckboxStates();
                        updateSelectAllState();
                    }
                });

                // Dynamic width assignment
                dataTable.columns().every(function (index) {
                    if (index === 0) {
                        $(this.header()).css("width", "1%");
                    } else if (index === dataTable.columns().nodes().length - 1) {
                        $(this.header()).css("width", "10%");
                    } else {
                        $(this.header()).css("width", "auto");
                    }
                });

                // Function to restore checkbox states on page change
                function restoreCheckboxStates() {
                    $('.offer-checkbox').each(function () {
                        var offerCode = $(this).val();
                        var isSelected = selectedRows.has(offerCode);
                        $(this).prop('checked', isSelected);
                        $(this).closest('tr').toggleClass('selected-row', isSelected);
                    });
                }

                // Function to update Select All checkbox state
                function updateSelectAllState() {
                    var currentPageCheckboxes = $('.offer-checkbox:visible');
                    var currentPageChecked = currentPageCheckboxes.filter(':checked');

                    if (currentPageCheckboxes.length === 0) {
                        $('#selectAll').prop('checked', false).prop('indeterminate', false);
                    } else if (currentPageChecked.length === currentPageCheckboxes.length) {
                        $('#selectAll').prop('checked', true).prop('indeterminate', false);
                    } else if (currentPageChecked.length > 0) {
                        $('#selectAll').prop('checked', false).prop('indeterminate', true);
                    } else {
                        $('#selectAll').prop('checked', false).prop('indeterminate', false);
                    }
                }

                // Enhanced Select All checkbox functionality
                $('#selectAll').off('click').on('click', function () {
                    var isChecked = $(this).is(':checked');

                    if (isChecked) {
                        dataTable.rows({ search: 'applied' }).every(function () {
                            var row = this.node();
                            var checkbox = $(row).find('.offer-checkbox');
                            var offerCode = checkbox.val();
                            selectedRows.add(offerCode);
                            checkbox.prop('checked', true);
                            $(row).addClass('selected-row');
                        });
                    } else {
                        dataTable.rows({ search: 'applied' }).every(function () {
                            var row = this.node();
                            var checkbox = $(row).find('.offer-checkbox');
                            var offerCode = checkbox.val();
                            selectedRows.delete(offerCode);
                            checkbox.prop('checked', false);
                            $(row).removeClass('selected-row');
                        });
                    }
                    updateSelectAllState();
                });

                // Individual checkbox functionality
                $('#offerTable tbody').off('change', '.offer-checkbox').on('change', '.offer-checkbox', function () {
                    var row = $(this).closest('tr');
                    var offerCode = $(this).val();
                    var isChecked = $(this).is(':checked');

                    if (isChecked) {
                        selectedRows.add(offerCode);
                    } else {
                        selectedRows.delete(offerCode);
                    }

                    row.toggleClass('selected-row', isChecked);
                    updateSelectAllState();
                });

                // Export functionality functions
                function getSelectedRowsData() {
                    var selectedData = [];
                    var serialNo = 1;

                    dataTable.rows().every(function () {
                        var row = this.node();
                        var checkbox = $(row).find('.offer-checkbox');
                        var offerCode = checkbox.val();

                        if (selectedRows.has(offerCode)) {
                            var rowData = [];
                            rowData.push(serialNo.toString());

                            $(row).find('td').each(function (index) {
                                if (index > 1 && index < 11) {
                                    rowData.push($(this).text().trim());
                                }
                            });

                            selectedData.push(rowData);
                            serialNo++;
                        }
                    });

                    return selectedData;
                }

                function getTableHeaders() {
                    var headers = ['Sr No'];
                    $('#offerTable thead th').each(function (index) {
                        if (index > 1 && index < 11) {
                            headers.push($(this).text().trim());
                        }
                    });
                    return headers;
                }


                // Copy functionality
                $('#copyBtn').off('click').on('click', function () {
                    var selectedData = getSelectedRowsData();
                    if (selectedData.length === 0) {
                        showErrorToast('Please select at least one row to export.');
                        return;
                    }

                    var headers = getTableHeaders();
                    var copyText = headers.join('\t') + '\n';
                    selectedData.forEach(function (row) {
                        copyText += row.join('\t') + '\n';
                    });

                    // Copy to clipboard
                    navigator.clipboard.writeText(copyText).then(function () {
                        alert('Offer data copied to clipboard! (' + selectedData.length + ' rows)');
                    }).catch(function () {
                        alert('Copy failed. Please try again.');
                    });
                });

                // Export button handlers
                $('#csvBtn').off('click').on('click', function () {
                    var selectedData = getSelectedRowsData();
                    if (selectedData.length === 0) {
                        showErrorToast('Please select at least one row to export.');
                        return;
                    }

                    var headers = getTableHeaders();
                    var csvContent = headers.join(',') + '\n';
                    selectedData.forEach(function (row) {
                        csvContent += row.map(function (cell) {
                            return '"' + cell.replace(/"/g, '""') + '"';
                        }).join(',') + '\n';
                    });

                    var blob = new Blob([csvContent], { type: 'text/csv' });
                    var url = window.URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'offer_list_' + new Date().getTime() + '.csv';
                    a.click();
                    window.URL.revokeObjectURL(url);
                });

                $('#excelBtn').off('click').on('click', function () {
                    var selectedData = getSelectedRowsData();
                    if (selectedData.length === 0) {
                        showErrorToast('Please select at least one row to export.');
                        return;
                    }

                    var headers = getTableHeaders();
                    var excelContent = '<table border="1"><thead><tr>';
                    headers.forEach(function (header) {
                        excelContent += '<th>' + header + '</th>';
                    });
                    excelContent += '</tr></thead><tbody>';

                    selectedData.forEach(function (row) {
                        excelContent += '<tr>';
                        row.forEach(function (cell) {
                            excelContent += '<td>' + cell + '</td>';
                        });
                        excelContent += '</tr>';
                    });
                    excelContent += '</tbody></table>';

                    var blob = new Blob([excelContent], { type: 'application/vnd.ms-excel' });
                    var url = window.URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'offer_list_' + new Date().getTime() + '.xls';
                    a.click();
                    window.URL.revokeObjectURL(url);
                });

                //$('#pdfBtn').off('click').on('click', function () {
                //    var selectedData = getSelectedRowsData();
                //    if (selectedData.length === 0) {
                //        showErrorToast('Please select at least one row to export.');
                //        return;
                //    }

                //    var headers = getTableHeaders();
                //    const { jsPDF } = window.jspdf;
                //    const doc = new jsPDF('landscape');

                //    doc.setFontSize(16);
                //    doc.text("Offer List Report", 14, 15);
                //    doc.setFontSize(10);
                //    doc.text("Generated on: " + new Date().toLocaleString(), 14, 22);
                //    doc.text("Total Records: " + selectedData.length, 14, 28);

                //    doc.autoTable({
                //        head: [headers],
                //        body: selectedData,
                //        startY: 35,
                //        styles: { fontSize: 8, cellPadding: 2 },
                //        headStyles: { fillColor: [51, 122, 183], textColor: 255, fontStyle: 'bold', halign: 'center' },
                //        alternateRowStyles: { fillColor: [248, 249, 250] }
                //    });

                //    doc.save('offer_list_' + new Date().getTime() + '.pdf');
                //});



                // Replace your existing PDF export function with this updated version
                $('#pdfBtn').off('click').on('click', function () {
                    var selectedData = getSelectedRowsData();
                    if (selectedData.length === 0) {
                        showErrorToast('Please select at least one row to export.');
                        return;
                    }

                    // Check if jsPDF is available
                    if (typeof window.jspdf === 'undefined') {
                        showErrorToast('jsPDF library is not loaded');
                        return;
                    }

                    var headers = getTableHeaders();

                    try {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF({
                            orientation: 'landscape',
                            unit: 'pt',
                            format: 'a4'
                        });

                        // === HEADER ===
                        doc.setFont("helvetica");
                        doc.setFontSize(22);
                        doc.setTextColor(0, 0, 0);

                        var pageWidth = doc.internal.pageSize.getWidth();
                        var rahishopTitle = "RahiShop";
                        var titleWidth = doc.getTextWidth(rahishopTitle);
                        var centerX = pageWidth / 2 - titleWidth / 2;
                        doc.text(rahishopTitle, centerX, 40); // Centered main title

                        // Subtitle
                        doc.setFontSize(18);
                        var exportTitle = "Offer List";
                        var exportWidth = doc.getTextWidth(exportTitle);
                        var exportCenterX = pageWidth / 2 - exportWidth / 2;
                        doc.text(exportTitle, exportCenterX, 65); // Centered subtitle

                        // === METADATA (Right Aligned) ===
                        var now = new Date();
                        doc.setFontSize(11);
                        doc.setTextColor(100, 100, 100);
                        var rightMargin = 40;

                        doc.text("Generated on: " + now.toLocaleDateString() + " at " + now.toLocaleTimeString(),
                            pageWidth - rightMargin, 65, { align: 'right' });

                        doc.text("Total Records: " + selectedData.length,
                            pageWidth - rightMargin, 80, { align: 'right' });

                        // === FORMAT PRICE COLUMNS ===
                        var formattedData = selectedData.map(function (row) {
                            var newRow = [...row];
                            // Assuming column indexes for prices
                            // (update if your table columns differ)
                            if (newRow[5]) newRow[5] = formatIndianCurrency(newRow[5]); // MRP
                            if (newRow[6]) newRow[6] = formatIndianCurrency(newRow[6]); // Actual Price
                            return newRow;
                        });

                        // === TABLE ===
                        if (typeof doc.autoTable === 'function') {
                            var marginLeft = 30;
                            var marginRight = 30;
                            var availableWidth = pageWidth - marginLeft - marginRight;

                            doc.autoTable({
                                head: [headers],
                                body: formattedData,
                                startY: 100,
                                tableWidth: availableWidth,
                                margin: { left: marginLeft, right: marginRight },
                                styles: {
                                    fontSize: 9,
                                    cellPadding: 4,
                                    valign: 'middle',
                                    overflow: 'linebreak'
                                },
                                headStyles: {
                                    fillColor: '#007bff',
                                    textColor: 255,
                                    fontSize: 10,
                                    fontStyle: 'bold',
                                    halign: 'center'
                                },
                                alternateRowStyles: {
                                    fillColor: [248, 249, 250]
                                },
                                bodyStyles: {
                                    fillColor: [255, 255, 255]
                                },
                                columnStyles: {
                                    0: { halign: 'center', cellWidth: 35 },  // Sr No
                                    1: { cellWidth: 100, halign: 'center' }, // Product Name
                                    2: { cellWidth: 80, halign: 'center' },  // Main Category
                                    3: { cellWidth: 85, halign: 'center' },  // Manufacturer
                                    4: { cellWidth: 70, halign: 'center' },  // Register Date
                                    5: { halign: 'center', cellWidth: 60 },  // MRP ₹
                                    6: { halign: 'center', cellWidth: 100 },  // Actual Price ₹
                                    7: { halign: 'center', cellWidth: 130 }   // Stock
                                },
                                tableLineColor: [200, 200, 200],
                                tableLineWidth: 0.5
                            });
                        }

                        // === SAVE PDF ===
                        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '').replace('T', '_');
                        const filename = 'Offer_Export_' + timestamp + '.pdf';
                        doc.save(filename);

                    } catch (error) {
                        console.error('PDF Generation Error:', error);
                        showErrorToast('Error generating PDF: ' + error.message);
                    }
                });

                // Helper: Format currency in Indian style
                function formatIndianCurrency(value) {
                    if (!value) return '';
                    const number = parseFloat(value.toString().replace(/[^\d.-]/g, ''));
                    if (isNaN(number)) return value;
                    return '₹' + number.toLocaleString('en-IN', { minimumFractionDigits: 2 });
                }


                $('#printBtn').off('click').on('click', function () {
                    var selectedData = getSelectedRowsData();
                    if (selectedData.length === 0) {
                        showErrorToast('Please select at least one row to export.');
                        return;
                    }

                    var headers = getTableHeaders();
                    var printContent = '<html><head><title>Offer List Report</title>';
                    printContent += '<style>table{border-collapse:collapse;width:100%;font-size:12px;}th,td{border:1px solid #ddd;padding:8px;text-align:left;}th{background-color:#f2f2f2;}@@media print{body{margin:0;}}</style>';
                    printContent += '</head><body>';
                    printContent += '<h2>Offer List Report - ' + new Date().toLocaleDateString() + '</h2>';
                    printContent += '<table><thead><tr>';

                    headers.forEach(function (header) {
                        printContent += '<th>' + header + '</th>';
                    });
                    printContent += '</tr></thead><tbody>';

                    selectedData.forEach(function (row) {
                        printContent += '<tr>';
                        row.forEach(function (cell) {
                            printContent += '<td>' + cell + '</td>';
                        });
                        printContent += '</tr>';
                    });
                    printContent += '</tbody></table></body></html>';

                    var printWindow = window.open('', '_blank');
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    printWindow.print();
                    printWindow.close();
                });

            }, 100);
        });

        // Existing modal and form functions
        $(document).on('click', '.view-offer-btn', function (e) {
            e.preventDefault();
            var offerCode = $(this).data('offercode');

            $('#offerDetailsBody').html('<div class="text-center p-4">Loading...</div>');

            $.ajax({
                url: '/Admin/GetOfferDetailsPartialPK',
                type: 'GET',
                data: { offerCode: offerCode },
                success: function (data) {
                    $('#offerDetailsBody').html(data);
                    var modal = new bootstrap.Modal(document.getElementById('offerDetailsModal'));
                    modal.show();
                },
                error: function () {
                    $('#offerDetailsBody').html('<div class="text-danger p-3">Failed to load offer details.</div>');
                }
            });
        });

        @*$(document).on('click', '#addOfferBtn', function () {
            $.ajax({
                url: '@Url.Action("AddOfferPartialPK", "Admin")',
                type: 'GET',
                success: function (data) {
                    if (data.startsWith("ERROR")) {
                        alert(data);
                        return;
                    }

                    $('#addOfferModalContent').html(data);
                    var modal = new bootstrap.Modal(document.getElementById('addOfferModal'));
                    modal.show();
                },
                error: function (xhr) {
                    console.error("AJAX Error:", xhr.responseText);
                    alert("Failed to load Add Offer form.");
                }
            });
        });

        $(document).on('submit', '#addOfferForm', function (e) {
            e.preventDefault();

            const mainCat = $('#MainCategoryDropdown').val();
            const subCat = $('#SubCategoryDropdown').val();
            const prod = $('#ProductDropdown').val();

            if (!mainCat && !subCat && !prod) {
                alert("Please select either Main Category, Sub Category, or Product.");
                return;
            }

            $.ajax({
                url: $(this).attr("action"),
                type: "POST",
                data: $(this).serialize(),
                success: function (res) {
                    if (res.success) {
                        alert("Offer added successfully.");
                        location.reload();
                    } else {
                    //    alert(res.message || "Failed to add offer.");
                    }
                },
                error: function () {
                    alert("Error occurred.");
                }
            });
        });*@


        // Load Add Offer form
$(document).on('click', '#addOfferBtn', function () {
    $.ajax({
        url: '@Url.Action("AddOfferPartialPK", "Admin")',
        type: 'GET',
        success: function (data) {
            if (data.startsWith("ERROR")) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data,
                    confirmButtonColor: '#d33'
                });
                return;
            }

            $('#addOfferModalContent').html(data);
            var modal = new bootstrap.Modal(document.getElementById('addOfferModal'));
            modal.show();
        },
        error: function (xhr) {
            console.error("AJAX Error:", xhr.responseText);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: "Failed to load Add Offer form.",
                confirmButtonColor: '#d33'
            });
        }
    });
});

// Submit Add Offer form
$(document).on('submit', '#addOfferForm', function (e) {
    e.preventDefault();

    const mainCat = $('#MainCategoryDropdown').val();
    const subCat = $('#SubCategoryDropdown').val();
    const prod = $('#ProductDropdown').val();

    if (!mainCat && !subCat && !prod) {
        Swal.fire({
            icon: 'warning',
            title: 'Oops!',
            text: "Please select either Main Category, Sub Category, or Product.",
            confirmButtonColor: '#3085d6'
        });
        return;
    }

    $.ajax({
        url: $(this).attr("action"),
        type: "POST",
        data: $(this).serialize(),
        success: function (res) {
            if (res.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: 'Offer added successfully!',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true
                }).then(() => {
                    location.reload(); // Reload page after success
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: res.message || 'Failed to add offer.',
                    confirmButtonColor: '#d33'
                });
            }
        },
        error: function () {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: "Error occurred.",
                confirmButtonColor: '#d33'
            });
        }
    });
});



        $(document).on('change', '#MainCategoryDropdown', function () {
            if ($(this).val()) {
                $('#SubCategoryDropdown').val('');
                $('#ProductDropdown').val('');
            }
        });

        $(document).on('change', '#SubCategoryDropdown', function () {
            if ($(this).val()) {
                $('#MainCategoryDropdown').val('');
                $('#ProductDropdown').val('');
            }
        });

        $(document).on('change', '#ProductDropdown', function () {
            if ($(this).val()) {
                $('#MainCategoryDropdown').val('');
                $('#SubCategoryDropdown').val('');
            }
        });

        $(document).on('click', '.edit-offer-btn', function (e) {
            e.preventDefault();
            var offerCode = $(this).data('offercode');

            $('#updateOfferModalContent').html('<div class="text-center p-4">Loading...</div>');

            $.ajax({
                url: '/Admin/EditOfferPK',
                type: 'GET',
                data: { offerCode: offerCode },
                success: function (data) {
                    $('#updateOfferModalContent').html(data);
                    var modal = new bootstrap.Modal(document.getElementById('updateOfferModal'));
                    modal.show();
                },
                error: function () {
                    $('#updateOfferModalContent').html('<div class="text-danger p-3">Failed to load offer edit form.</div>');
                }
            });
        });

    </script>
}