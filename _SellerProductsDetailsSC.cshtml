@model List<GSTECommerceLibrary.Admin.Admin>

<link href="@Url.Content("~/Content/Document/CSS/SellerProductDetailsSC.css")" rel="stylesheet" />

<div class="card-body">
    <div class="controls-container mb-3">
        <!-- ✅ Total product count -->
        <div>
            <span class="fw-bold">Total Products: </span>
            <span id="totalProductsCount">@Model.Count</span>
        </div>
        <div>
            <span id="selectedCountPartial" class="selected-count"></span>
        </div>
    </div>

    <div class="row mb-3 d-flex justify-content-between align-items-center">
        <!-- Category Filter -->
        <div class="col-md-3 d-flex align-items-center">
            <label for="categoryFilter" class="me-2 fw-bold">Category:</label>
            <select id="categoryFilter" class="form-select">
                <option value="">All Categories</option>
                @foreach (var cat in Model.Select(x => x.MainCategoryName).Distinct())
                {
                    <option value="@cat">@cat</option>
                }
            </select>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped  align-middle" id="ProductTablePartial1">
            <thead class="table-light">
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" class="select-checkbox" id="selectAllCheckboxProducts">
                    </th>
                    <th style="width: 60px;">Sr No</th>
                    <th>Product Name</th>
                    <th>Category</th>
                    <th>Price(₹)</th>
                    <th>Commission(%)</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>
                            <input type="checkbox" class="select-checkbox row-checkbox-partial">
                        </td>
                        <td></td> <!-- Empty cell for DataTables to populate -->
                        <td class="text-start">@item.ProductName</td>
                        <td class="text-center">@item.MainCategoryName</td>
                        <td class="text-center">@item.ActualProductPrice.ToString("N2")</td>
                        <td class="text-center">@item.AdminCommission.ToString("N2")</td>
                        <td class="text-start">
                            <span class="d-inline-block text-truncate" style="max-width: 200px;"
                                  title="@item.ProductDescription">
                                @(string.IsNullOrEmpty(item.ProductDescription) ? "No description" : item.ProductDescription)
                            </span>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>


    <script>
        // Toast notification functions
        function showErrorToast(message) {
            $('#toastMessage').text(message);
            $('#liveToast').removeClass('bg-success').addClass('bg-danger');
            var toastEl = document.getElementById('liveToast');
            var toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        function showSuccessToast(message) {
            $('#toastMessage').text(message);
            $('#liveToast').removeClass('bg-danger').addClass('bg-success');
            var toastEl = document.getElementById('liveToast');
            var toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        let partialTable;
        let selectedRowsPartial = new Set();

        // Function to update selected count
        function updateSelectedCountPartial() {
            $('#selectedCount').text(""); // always empty

        }

        // Global function to initialize DataTable - accessible from AJAX success
        window.initializePartialDataTable = function () {
            console.log("Initializing DataTable for partial view");

            // Wait for modal to be fully visible
            if (!$('#ProductTablePartial1').is(':visible')) {
                console.log("Table not visible yet, retrying...");
                setTimeout(window.initializePartialDataTable, 50);
                return;
            }

            // Clear previous event handlers to prevent duplication
            $(document).off('change', '.row-checkbox-partial');
            $('#selectAllCheckboxProducts').off('change');

            // Reset selection state
            selectedRowsPartial.clear();
            updateSelectedCountPartial();

            // Check if DataTable already exists and destroy it
            if ($.fn.dataTable.isDataTable('#ProductTablePartial1')) {
                $('#ProductTablePartial1').DataTable().clear().destroy();
                console.log("Destroyed existing DataTable");
            }
            // Move category filter next to export buttons
            $('.categoryFilterWrapper').html($('#categoryFilter').parent());
            $('#categoryFilter').removeClass('col-md-3'); // remove Bootstrap column spacing

            // Initialize fresh DataTable instance
            partialTable = $('#ProductTablePartial1').DataTable({
                responsive: true,
                searching: true,
                paging: true,
                ordering: false,
                info: true,
                lengthChange: false,
                pageLength: 10,
                destroy: true,

                autoWidth: false,
                scrollX: false,
                lengthMenu: [5, 10, 25, 50, 100],
                language: {
                    search: "Search:",
                    searchPlaceholder: "Type to search"
                },
                "dom": `
                                                            <"top d-flex justify-content-between"
                                                                <"float-start"l>
                                                                <"d-flex flex-column align-items-end"
                                                                    <"mb-2"B>
                                                                    f
                                                                >
                                                            >
                                                            rt
                                                            <"bottom d-flex justify-content-between"ip>
                                                        `,
                "columnDefs": [
                    {
                        "targets": 0, // Checkbox column
                        "orderable": false,
                        "searchable": false
                    },
                    {
                        "targets": 1, // Sr No column
                        "orderable": false,
                        "searchable": false,
                        "render": function (data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    {
                        "targets": 2, // Product Name column
                        "render": function (data, type, row) {
                            return data;
                        }
                    },
                    {
                        "targets": 6, // Description column
                        "orderable": true,
                        "searchable": true
                    }
                ],
                "buttons": [
                    {
                        extend: 'copy',
                        text: '<img src="/Content/Document/Image/Copy.png" style="width:16px; height:16px;" />',
                        attr: { title: 'Copy to clipboard' },
                        // className: 'buttons-copy',
                        action: function (e, dt, button, config) {
                            if ($('.row-checkbox-partial:checked').length === 0) {
                                showErrorToast('Please select at least one row to export.');
                                return;
                            }
                            $.fn.dataTable.ext.buttons.copyHtml5.action.call(this, e, dt, button, config);
                            //  showSuccessToast('Data copied to clipboard');
                        },
                        exportOptions: {
                            columns: [1, 2, 3, 4, 5, 6],
                            rows: function (idx, data, node) {
                                return $(node).find('.row-checkbox-partial').is(':checked');
                            },
                            format: {
                                body: function (data, row, column, node) {
                                    var checkedRows = [];
                                    $('#ProductTablePartial1 tbody tr').each(function (index) {
                                        if ($(this).find('.row-checkbox-partial').is(':checked')) {
                                            checkedRows.push(index);
                                        }
                                    });

                                    if (column === 0) {
                                        var currentRowIndex = $(node).closest('tr').index();
                                        var serialNumber = checkedRows.indexOf(currentRowIndex) + 1;
                                        return serialNumber;
                                    }

                                    if (column === 4) {
                                        return data.replace(/₹|,/g, '');
                                    }

                                    if (column === 5) {
                                        return $('<div>').html(data).text().trim();
                                    }

                                    return data;
                                }
                            }
                        }
                    },
                    {
                        extend: 'csv',
                        text: '<img src="/Content/Document/Image/CSV.png" style="width:16px; height:16px;" />',
                        attr: { title: 'Export as CSV file' },
                        //  className: 'buttons-csv',
                        action: function (e, dt, button, config) {
                            if ($('.row-checkbox-partial:checked').length === 0) {
                                showErrorToast('Please select at least one row to export to export.');
                                return;
                            }
                            $.fn.dataTable.ext.buttons.csvHtml5.action.call(this, e, dt, button, config);
                            // showSuccessToast('CSV export started');
                        },
                        filename: 'Seller_Products_' + new Date().toISOString().slice(0, 10),
                        exportOptions: {
                            columns: [1, 2, 3, 4, 5, 6],
                            rows: function (idx, data, node) {
                                return $(node).find('.row-checkbox-partial').is(':checked');
                            },
                            format: {
                                body: function (data, row, column, node) {
                                    var checkedRows = [];
                                    $('#ProductTablePartial1 tbody tr').each(function (index) {
                                        if ($(this).find('.row-checkbox-partial').is(':checked')) {
                                            checkedRows.push(index);
                                        }
                                    });

                                    if (column === 0) {
                                        var currentRowIndex = $(node).closest('tr').index();
                                        var serialNumber = checkedRows.indexOf(currentRowIndex) + 1;
                                        return serialNumber;
                                    }

                                    if (column === 4) {
                                        return data.replace(/₹|,/g, '');
                                    }

                                    if (column === 5) {
                                        return $('<div>').html(data).text().trim();
                                    }
                                    return data;
                                }
                            }
                        }
                    },
                    {
                        extend: 'excel',
                        text: '<img src="/Content/Document/Image/XLS.png" style="width:16px; height:16px;" />',
                        attr: { title: 'Export as Excel file' },
                        //  className: 'buttons-excel',
                        action: function (e, dt, button, config) {
                            if ($('.row-checkbox-partial:checked').length === 0) {
                                showErrorToast('Please select at least one row to export to export.');
                                return;
                            }
                            $.fn.dataTable.ext.buttons.excelHtml5.action.call(this, e, dt, button, config);
                            // showSuccessToast('Excel export started');
                        },
                        filename: 'Seller_Products_' + new Date().toISOString().slice(0, 10),
                        title: 'Seller Products',
                        exportOptions: {
                            columns: [1, 2, 3, 4, 5, 6],
                            rows: function (idx, data, node) {
                                return $(node).find('.row-checkbox-partial').is(':checked');
                            },
                            format: {
                                body: function (data, row, column, node) {
                                    var checkedRows = [];
                                    $('#ProductTablePartial1 tbody tr').each(function (index) {
                                        if ($(this).find('.row-checkbox-partial').is(':checked')) {
                                            checkedRows.push(index);
                                        }
                                    });

                                    if (column === 0) {
                                        var currentRowIndex = $(node).closest('tr').index();
                                        var serialNumber = checkedRows.indexOf(currentRowIndex) + 1;
                                        return serialNumber;
                                    }

                                    if (column === 4) {
                                        return data.replace(/₹|,/g, '');
                                    }

                                    if (column === 5) {
                                        return $('<div>').html(data).text().trim();
                                    }

                                    return data;
                                }
                            }
                        }
                    },
                    {
                        extend: 'pdf',
                        text: '<img src="/Content/Document/Image/PDFicon.png" style="width:16px; height:16px;" />',
                        attr: { title: 'Export as PDF' },
                        //  className: 'buttons-pdf',
                        action: function (e, dt, button, config) {
                            if ($('.row-checkbox-partial:checked').length === 0) {
                                showErrorToast('Please select at least one row to export to export.');
                                return;
                            }
                            $.fn.dataTable.ext.buttons.pdfHtml5.action.call(this, e, dt, button, config);
                            //showSuccessToast('PDF export started');
                        },
                        filename: 'Seller_Products_' + new Date().toISOString().slice(0, 10),
                        title: 'Seller Products Report',
                        orientation: 'landscape',
                        pageSize: 'A4',
                        exportOptions: {
                            columns: [1, 2, 3, 4, 5, 6],
                            rows: function (idx, data, node) {
                                return $(node).find('.row-checkbox-partial').is(':checked');
                            },
                            format: {
                                body: function (data, row, column, node) {
                                    var checkedRows = [];
                                    $('#ProductTablePartial1 tbody tr').each(function (index) {
                                        if ($(this).find('.row-checkbox-partial').is(':checked') || $(this).find('.row-checkbox-partial').length === 0) {
                                            checkedRows.push(index);
                                        }
                                    });

                                    if (column === 0) {
                                        var currentRowIndex = $(node).closest('tr').index();
                                        var serialNumber = checkedRows.indexOf(currentRowIndex) + 1;
                                        return serialNumber;
                                    }

                                    if (column === 4) {
                                        return data.replace(/₹|,/g, '');
                                    }

                                    if (column === 5) {
                                        return $('<div>').html(data).text().trim();
                                    }
                                    return data;
                                }
                            }
                        },
                        customize: function (doc, config) {
                            doc.content.splice(0, 1);

                            var dt = $('#ProductTablePartial1').DataTable();

                            let now = new Date();
                            let dateStr = now.getFullYear() + '-' +
                                String(now.getMonth() + 1).padStart(2, '0') + '-' +
                                String(now.getDate()).padStart(2, '0') + ' ' +
                                String(now.getHours()).padStart(2, '0') + ':' +
                                String(now.getMinutes()).padStart(2, '0') + ':' +
                                String(now.getSeconds()).padStart(2, '0');

                            let totalRecords = dt.rows().nodes().to$()
                                .find('.row-checkbox-partial:checked').length;

                            doc.content.unshift({
                                margin: [0, 0, 0, 12],
                                stack: [
                                    {
                                        text: 'Rahishop',
                                        fontSize: 16,
                                        bold: true,
                                        alignment: 'center',
                                        margin: [0, 0, 0, 4]
                                    },
                                    {
                                        text: 'Seller Product List',
                                        fontSize: 12,
                                        bold: true,
                                        alignment: 'center',
                                        margin: [0, 0, 0, 6]
                                    },
                                    {
                                        columns: [
                                            { text: '', border: [false, false, false, false] },
                                            {
                                                stack: [
                                                    { text: 'Generated On: ' + dateStr, fontSize: 8, alignment: 'right' },
                                                    { text: 'Total Records: ' + totalRecords, fontSize: 8, alignment: 'right' }
                                                ],
                                                border: [false, false, false, false]
                                            }
                                        ]
                                    }
                                ]
                            });

                            let tableNode = doc.content.find(node => node.table);
                            if (tableNode) {
                                let serialCounter = 1;
                                tableNode.table.body.forEach(function (row, index) {
                                    if (index > 0) {
                                        row[0] = serialCounter++;
                                    }
                                });

                                tableNode.table.widths = ['8%', '25%', '15%', '15%', '12%', '25%'];
                            }

                            doc.styles.tableHeader = {
                                fillColor: '#007bff',
                                color: 'white',
                                alignment: 'center',
                                fontSize: 10,
                                bold: true
                            };

                            doc.defaultStyle.fontSize = 8;
                            doc.pageMargins = [20, 20, 20, 20];
                        }
                    },
                    {
                        extend: 'print',
                        text: '<img src="/Content/Document/Image/Print.png" style="width:16px; height:16px;" />',
                        attr: { title: 'Print' },
                        //  className: 'buttons-print',
                        action: function (e, dt, button, config) {
                            if ($('.row-checkbox-partial:checked').length === 0) {
                                showErrorToast('Please select at least one row to export.');
                                return;
                            }
                            $.fn.dataTable.ext.buttons.print.action.call(this, e, dt, button, config);
                            // showSuccessToast('Print dialog opened');
                        },
                        title: 'Seller Products',
                        exportOptions: {
                            columns: [1, 2, 3, 4, 5, 6],
                            rows: function (idx, data, node) {
                                return $(node).find('.row-checkbox-partial').is(':checked');
                            },
                            format: {
                                body: function (data, row, column, node) {
                                    var checkedRows = [];
                                    $('#ProductTablePartial1 tbody tr').each(function (index) {
                                        if ($(this).find('.row-checkbox-partial').is(':checked')) {
                                            checkedRows.push(index);
                                        }
                                    });

                                    if (column === 0) {
                                        var currentRowIndex = $(node).closest('tr').index();
                                        var serialNumber = checkedRows.indexOf(currentRowIndex) + 1;
                                        return serialNumber;
                                    }

                                    if (column === 4) {
                                        return data.replace(/₹/g, 'Rs. ');
                                    }

                                    if (column === 6) {
                                        var $span = $(node).find('span');
                                        return $span.attr('title') || data;
                                    }

                                    return data;
                                }
                            }
                        },
                        customize: function (win) {
                            $(win.document.body)
                                .css('font-size', '10pt')
                                .prepend(
                                    '<div style="text-align:center; margin-bottom: 20px;"><h2>Seller Products Report</h2><p>Generated on: ' + new Date().toLocaleDateString() + '</p></div>'
                                );

                            var $table = $(win.document.body).find('table')
                                .addClass('compact')
                                .css('font-size', '9pt');

                            var serialNumber = 1;
                            $table.find('tbody tr').each(function () {
                                $(this).find('td:first').text(serialNumber++);
                            });

                            $table.find('th').css({
                                'background-color': '#f8f9fa',
                                'font-weight': 'bold',
                                'border': '1px solid #dee2e6'
                            });

                            $table.find('td').css({
                                'border': '1px solid #dee2e6',
                                'padding': '8px'
                            });
                        }
                    }
                ],
                initComplete: function () {
                    console.log("DataTable initialized successfully");
                    setupEventHandlers();
                    forceTransparentButtons();
                }
            });
            // Custom Category Filter
            $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                if (settings.nTable.id !== 'ProductTablePartial1') return true; // Only apply to this table

                var selectedCategory = $('#categoryFilter').val();
                var rowCategory = data[3]; // Category column index (0-based)

                if (selectedCategory === "" || rowCategory === selectedCategory) {
                    return true;
                }
                return false;
            });

            // Dropdown change event
            $('#categoryFilter').on('change', function () {
                partialTable.draw(); // ✅ Use partialTable, not table
            });
            partialTable.on('draw.dt', function () {
                partialTable.column(1, { search: 'applied', order: 'applied' }).nodes().each(function (cell, i) {
                    cell.innerHTML = i + 1;
                });
            });


            table.buttons().container().appendTo('#exportButtons');
            // Force transparent buttons styling with blue border + radius + spacing
            function forceTransparentButtons() {
                $('#ProductTablePartial1_wrapper .dt-buttons button, #ProductTablePartial1_wrapper .dt-buttons a').each(function () {
                    $(this).removeClass('btn-secondary btn-primary btn-success btn-info btn-warning btn-danger');

                    this.style.setProperty('background', 'transparent', 'important');
                    this.style.setProperty('background-color', 'transparent', 'important');
                    this.style.setProperty('background-image', 'none', 'important');

                    // 🔵 Blue border (instead of gray)
                    this.style.setProperty('border', '1px solid #007bff', 'important');

                    // Keep text black
                    this.style.setProperty('color', '#212529', 'important');

                    // No shadow
                    this.style.setProperty('box-shadow', 'none', 'important');

                    // ➡ Spacing between buttons
                    this.style.setProperty('margin-right', '8px', 'important');

                    // 🔄 Rounded corners
                    this.style.setProperty('border-radius', '6px', 'important');
                });
            }


            // Apply button styling with delays to ensure it takes effect
            setTimeout(forceTransparentButtons, 100);
            setTimeout(forceTransparentButtons, 500);
            setTimeout(forceTransparentButtons, 1000);

            // Update serial numbers when filtering/sorting
            partialTable.on('draw.dt', function () {
                partialTable.column(1, { search: 'applied', order: 'applied' }).nodes().each(function (cell, i) {
                    cell.innerHTML = i + 1;
                });
            });
        };

        // Separate function for event handlers
        function setupEventHandlers() {
            // Select All checkbox functionality for partial table
            $('#selectAllCheckboxProducts').on('change', function () {
                const isChecked = $(this).is(':checked');
                partialTable.$('.row-checkbox-partial').prop('checked', isChecked);

                if (isChecked) {
                    partialTable.rows().every(function () {
                        const node = this.node();
                        selectedRowsPartial.add(node);
                    });
                } else {
                    selectedRowsPartial.clear();
                }

                updateSelectedCountPartial();
            });

            // Row checkbox functionality for partial table - using delegated events
            $(document).on('change', '.row-checkbox-partial', function () {
                const $row = $(this).closest('tr');

                if ($(this).is(':checked')) {
                    selectedRowsPartial.add($row[0]);
                } else {
                    selectedRowsPartial.delete($row[0]);
                }

                updateSelectAllCheckboxPartial();
                updateSelectedCountPartial();
            });
        }

        // Update Select All checkbox state for partial table
        function updateSelectAllCheckboxPartial() {
            const totalRows = partialTable.rows().count();
            const selectedCount = selectedRowsPartial.size;

            if (selectedCount === 0) {
                $('#selectAllCheckboxProducts').prop('indeterminate', false).prop('checked', false);
            } else if (selectedCount === totalRows) {
                $('#selectAllCheckboxProducts').prop('indeterminate', false).prop('checked', true);
            } else {
                $('#selectAllCheckboxProducts').prop('indeterminate', true);
            }
        }

        // Listen for custom initialization event as fallback
        $(document).on('initializeDataTable', function () {
            window.initializePartialDataTable();
        });

        // Don't auto-initialize on document ready since we're in AJAX-loaded content
    </script>
</div>
<link href="~/Content/Document/CSS/SellerProductDetailsSC.css" rel="stylesheet" />