@{
    var dt = ViewBag.OrderData as System.Data.DataSet;
}

<link href="~/Content/Document/CSS/OrderListPartial.css" rel="stylesheet" />

<section class="section">
    @*<div class="card">
        <div class="card-header">
            Orders - @ViewBag.TabName
        </div>*@
    <!--<div class="card-body">-->
    <!-- Export Options Above Search Bar - Right Corner -->
    <!--<div class="row mb-3">
        <div class="col-md-12 d-flex justify-content-end">
            <div class="export-controls d-flex align-items-center gap-2">
                <span class="me-2"></span>
                <button type="button" class="btn btn-outline-primary btn-sm export-btn" data-format="copy" title="Copy to Clipboard">
                    <img src="~/Content/Document/Image/Copy.png" alt="Copy" class="export-icon" />
                </button>
                <button type="button" class="btn btn-outline-info btn-sm export-btn" data-format="csv" title="Export to CSV">
                    <img src="~/Content/Document/Image/CSV.png" alt="CSV" class="export-icon" />
                </button>
                <button type="button" class="btn btn-outline-success btn-sm export-btn" data-format="excel" title="Export to Excel">
                    <img src="~/Content/Document/Image/XLS.png" alt="Excel" class="export-icon" />
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm export-btn" data-format="pdf" title="Export to PDF">
                    <img src="~/Content/Document/Image/PDFicon.png" alt="PDF" class="export-icon" />
                </button>

                <button type="button" class="btn btn-outline-secondary btn-sm export-btn" data-format="print" title="Print">
                    <img src="~/Content/Document/Image/Print.png" alt="Print" class="export-icon" />
                </button>

            </div>
        </div>
    </div>-->
    <!-- Friend's Toast Notification HTML - Positioned slightly below -->
    <div class="position-fixed end-0 p-3" style="top: 60px; right: 20px; z-index: 9999;">
        <div id="liveToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <span id="toastMessage"></span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <table class="table table-striped table-bordered dataTable" id="table1">
        <thead class="table-borderless">
            <tr>
                <th>
                    <input type="checkbox" id="selectAll" class="form-check-input">
                    <label for="selectAll" class="form-check-label ms-1"></label>
                </th>
                <th>Sr No</th>
                <th>Business Name</th>
                <th class="Customer-col">Customer Name</th>
                <th class="Order-col">Order Code</th>
                <th class=" orderdate">Order Date</th>
                <th class="shipping-col">Product<br /><small>Name</small></th>
                <th class="status-col @(ViewBag.TabName != "All" ? "d-none" : "")">Status</th>
                <th class="text-center">
                    Shipping<br /><small>Charges(₹)</small>
                </th>
                <th class="shipping-col">Comm. Amt(₹)</th>
                <th class="shipping-col">Total Amount(₹)</th>
                @*<th>Action</th>*@
                <th class="no-export">Action</th>
                @*<th>Invoice</th>*@
            </tr>
        </thead>
        <tbody>
            @if (dt != null && dt.Tables.Count > 0 && dt.Tables[0].Rows.Count > 0)
            {
                int serialNumber = 1;
                foreach (System.Data.DataRow row in dt.Tables[0].Rows)
                {
                    string orderCode = row["OrderCode"].ToString();
                    string productCode = row["ProductCode"].ToString();
                    string customerCode = row["CustomerCode"].ToString();
                    string clientCode = row["ClientCode"].ToString();
                    <tr data-product-code="@productCode"
                        data-customer-code="@customerCode"
                        data-client-code="@clientCode"
                        data-order-code="@orderCode"
                        data-serial="@serialNumber">
                        <td>
                            <input type="checkbox" class="form-check-input row-checkbox" value="@orderCode" data-order-code="@orderCode">
                        </td>
                        <td>@serialNumber</td>
                        <td>@row["BusinessName"]</td>
                        <td>@customerCode</td>
                        <td>@orderCode</td>
                        <td>@Convert.ToDateTime(row["OrderDate"]).ToString("dd-MM-yyyy")</td>
                        <td class="product-name" data-full-name="@row["ProductName"]">
                            <span class="product-text"
                                  data-bs-toggle="tooltip"
                                  data-bs-placement="top"
                                  title="@row["ProductName"]">
                                @{
                                    var fullName = row["ProductName"].ToString();
                                    var shortName = fullName.Length > 20 ? fullName.Substring(0, 10) + "…" : fullName;
                                }
                                @shortName
                            </span>
                        </td>

                        <td class="status-col @(ViewBag.TabName != "All" ? "d-none" : "")">@row["OrderStatus"]</td>
                        <td>@row["ShippingCharges"]</td>
                        <td>@row["CommissionAmount"]</td>
                        <td>@row["TotalAmount"]</td>
                        <td>
                            <a class="btn btn-sm view-details" data-order="@orderCode"
                               title="View Details">
                                <i class="bi bi-eye fs-7"></i>
                            </a>

                            <a class="btn btn-sm view-invoice" data-order="@orderCode" data-product="@productCode" data-client="@clientCode"
                               title="View Invoice">
                                <i class="bi bi-receipt fs-7"></i>
                            </a>
                        </td>

                        @*<td>
                                <a class="btn btn-sm btn-primary view-invoice" data-order="@orderCode" data-product="@productCode" data-client="@clientCode">Invoice</a>
                            </td>*@
                    </tr>
                    serialNumber++;
                }
            }
            else
            {
                <tr><td colspan="13" class="text-center">No orders found.</td></tr>
            }
        </tbody>
    </table>
    @*</div>*@
    @*</div>*@
</section>

<!-- CDN versions -->
<script src="~/Scripts/jspdf.umd.min.js"></script>
<script src="~/Scripts/jspdf.plugin.autotable.min.js"></script>

<script>
    $(document).ready(function () {
        var table;
        var selectedRows = new Set(); // Global variable to store selected rows across all pages

        // Initialize DataTable if available
        if ($.fn.DataTable) {
            table = $('#table1').DataTable({
                "columnDefs": [
                    { "orderable": false, "targets": [0, 1, 11] }
                ],
                "drawCallback": function () {
                    restoreCheckboxStates();
                    updateSelectAllState();
                    updateSerialNumbers();
                }
            });
        }

        // Friend's Simple Toast Function
        function showToast(message, type = 'danger') {
            $('#toastMessage').text(message);
            var toastEl = document.getElementById('liveToast');
            var toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        // Function to format Indian currency properly for PDF display
        function formatIndianCurrency(value) {
            if (value == null || value === '' || isNaN(value)) return 'Rs. 0.00';

            var number = parseFloat(value);
            var formattedNumber = number.toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            return 'Rs. ' + formattedNumber;
        }

        // Function to restore checkbox states on page change
        function restoreCheckboxStates() {
            $('.row-checkbox').each(function () {
                var orderCode = $(this).attr('data-order-code') || $(this).val();
                var isSelected = selectedRows.has(orderCode);
                $(this).prop('checked', isSelected);
                $(this).closest('tr').toggleClass('selected-row', isSelected);
            });
        }

        // Function to update serial numbers
        function updateSerialNumbers() {
            if (table) {
                table.rows({ page: 'current' }).every(function (rowIdx, tableLoop, rowLoop) {
                    var row = this.node();
                    $(row).find('td:eq(1)').text(rowLoop + 1);
                });
            } else {
                $('#table1 tbody tr').each(function (index) {
                    if ($(this).find('td').length > 1) {
                        $(this).find('td:eq(1)').text(index + 1);
                    }
                });
            }
        }

        // Function to update Select All checkbox state
        function updateSelectAllState() {
            var currentPageCheckboxes = $('.row-checkbox:visible');
            var currentPageChecked = currentPageCheckboxes.filter(':checked');
            if (currentPageCheckboxes.length === 0) {
                $('#selectAll').prop('checked', false).prop('indeterminate', false);
            } else if (currentPageChecked.length === currentPageCheckboxes.length) {
                $('#selectAll').prop('checked', true).prop('indeterminate', false);
            } else if (currentPageChecked.length > 0) {
                $('#selectAll').prop('checked', false).prop('indeterminate', true);
            } else {
                $('#selectAll').prop('checked', false).prop('indeterminate', false);
            }
        }

        // Enhanced Select All functionality - works across all pages
        $('#selectAll').off('change').on('change', function () {
            var isChecked = $(this).is(':checked');
            if (isChecked) {
                // Select ALL rows across all pages
                if (table) {
                    table.rows({ search: 'applied' }).every(function () {
                        var $row = $(this.node());
                        var $checkbox = $row.find('.row-checkbox');
                        var orderCode = $checkbox.attr('data-order-code') || $checkbox.val();
                        selectedRows.add(orderCode);
                        $checkbox.prop('checked', true);
                        $row.addClass('selected-row');
                    });
                } else {
                    $('.row-checkbox').each(function () {
                        var orderCode = $(this).attr('data-order-code') || $(this).val();
                        selectedRows.add(orderCode);
                        $(this).prop('checked', true);
                        $(this).closest('tr').addClass('selected-row');
                    });
                }
            } else {
                // Deselect ALL rows across all pages
                if (table) {
                    table.rows({ search: 'applied' }).every(function () {
                        var $row = $(this.node());
                        var $checkbox = $row.find('.row-checkbox');
                        var orderCode = $checkbox.attr('data-order-code') || $checkbox.val();
                        selectedRows.delete(orderCode);
                        $checkbox.prop('checked', false);
                        $row.removeClass('selected-row');
                    });
                } else {
                    $('.row-checkbox').each(function () {
                        var orderCode = $(this).attr('data-order-code') || $(this).val();
                        selectedRows.delete(orderCode);
                        $(this).prop('checked', false);
                        $(this).closest('tr').removeClass('selected-row');
                    });
                }
            }
            updateSelectAllState();
        });

        // Individual checkbox change
        $(document).off('change', '.row-checkbox').on('change', '.row-checkbox', function () {
            var $row = $(this).closest('tr');
            var orderCode = $(this).attr('data-order-code') || $(this).val();
            var isChecked = $(this).is(':checked');
            if (isChecked) {
                selectedRows.add(orderCode);
            } else {
                selectedRows.delete(orderCode);
            }
            $row.toggleClass('selected-row', isChecked);
            updateSelectAllState();
        });

        // Function to get selected rows data
        function getSelectedRowsData() {
            var selectedData = [];
            var serialNo = 1;

            try {
                if (table && $.fn.DataTable.isDataTable('#table1')) {
                    table.rows().every(function () {
                        var row = this.node();
                        if (!row) return;

                        var checkbox = $(row).find('.row-checkbox');
                        if (checkbox.length === 0) return;

                        var orderCode = checkbox.val();
                        if (selectedRows.has(orderCode)) {
                            var cells = $(row).find('td');
                            if (cells.length >= 11) {
                                var rowData = [];
                                rowData.push(serialNo.toString());
                                rowData.push(cells.eq(2).text().trim() || ''); // Business Name
                                rowData.push(cells.eq(3).text().trim() || ''); // Customer Code
                                rowData.push(cells.eq(4).text().trim() || ''); // Order Code
                                rowData.push(cells.eq(5).text().trim() || ''); // Order Date

                                // FIX: Get full product name from data attribute instead of truncated text
                                var fullProductName = cells.eq(6).attr('data-full-name') || cells.eq(6).text().trim() || '';
                                rowData.push(fullProductName); // Full Product Name for PDF

                                rowData.push(cells.eq(7).text().trim() || ''); // Status
                                rowData.push(cells.eq(8).text().trim() || ''); // Shipping Charges
                                rowData.push(cells.eq(9).text().trim() || ''); // Comm. Amt
                                rowData.push(cells.eq(10).text().trim() || ''); // Total Amount
                                selectedData.push(rowData);
                                serialNo++;
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error extracting selected rows data:', error);
            }

            return selectedData;
        }


        // Function to get headers for export
        function getExportHeaders() {
            return ['Sr. No', 'Business Name', 'Customer Code', 'Order Code', 'Order Date', 'Product Name', 'Status', 'Shipping Charges', 'Comm. Amt', 'Total Amount'];
        }

        // Export functionality - Uses friend's toast
        $('.export-btn').off('click').on('click', function () {
            var format = $(this).data('format');
            var selectedData = getSelectedRowsData();
            if (selectedData.length === 0) {
                showToast('Please select at least one row to export');
                return;
            }
            switch (format) {
                case 'pdf':
                    exportToPDF(selectedData);
                    break;
                case 'excel':
                    exportToExcel(selectedData);
                    break;
                case 'csv':
                    exportToCSV(selectedData);
                    break;
                case 'print':
                    printData(selectedData);
                    break;
                case 'copy':
                    copyToClipboard(selectedData);
                    break;
            }
        });

        // PDF Export functionality (silent - no alert)
        //function exportToPDF(selectedData) {
        //    if (typeof window.jspdf === 'undefined') {
        //        showToast('jsPDF library is not loaded');
        //        return;
        //    }
        //    var headers = getExportHeaders();
        //    try {
        //        const { jsPDF } = window.jspdf;
        //        const doc = new jsPDF({
        //            orientation: 'landscape',
        //            unit: 'pt',
        //            format: 'a4'
        //        });
        //        doc.setFont("helvetica");
        //        doc.setFontSize(18);
        //        doc.setTextColor(51, 122, 183);
        //        doc.text("Orders Export Report", 40, 40);
        //        var now = new Date();
        //        doc.setFontSize(12);
        //        doc.setTextColor(100, 100, 100);
        //        doc.text("Generated on: " + now.toLocaleDateString() + ' at ' + now.toLocaleTimeString(), 40, 65);
        //        doc.text("Total Records: " + selectedData.length, 40, 85);
        //        var tableData = selectedData.map(function (row) {
        //            var formattedRow = [...row];
        //            formattedRow[7] = formatIndianCurrency(row[7]);
        //            formattedRow[8] = formatIndianCurrency(row[8]);
        //            formattedRow[9] = formatIndianCurrency(row[9]);
        //            return formattedRow;
        //        });
        //        if (typeof doc.autoTable === 'function') {
        //            var pageWidth = doc.internal.pageSize.getWidth();
        //            var marginLeft = 30;
        //            var marginRight = 30;
        //            var availableWidth = pageWidth - marginLeft - marginRight;
        //            doc.autoTable({
        //                head: [headers],
        //                body: tableData,
        //                startY: 110,
        //                tableWidth: availableWidth,
        //                margin: { left: marginLeft, right: marginRight },
        //                styles: {
        //                    fontSize: 9,
        //                    cellPadding: 4,
        //                    valign: 'middle',
        //                    overflow: 'linebreak'
        //                },
        //                headStyles: {
        //                    fillColor: [51, 122, 183],
        //                    textColor: 255,
        //                    fontSize: 10,
        //                    fontStyle: 'bold',
        //                    halign: 'center'
        //                },
        //                columnStyles: {
        //                    0: { halign: 'center', cellWidth: 35 },
        //                    1: { cellWidth: 85, halign: 'left' },
        //                    2: { cellWidth: 65, halign: 'center' },
        //                    3: { cellWidth: 70, halign: 'center' },
        //                    4: { cellWidth: 60, halign: 'center' },
        //                    5: { cellWidth: 95, halign: 'left' },
        //                    6: { halign: 'center', cellWidth: 50 },
        //                    7: { halign: 'Center', cellWidth: 75  },
        //                    8: { halign: 'Center', cellWidth: 100  },
        //                    9: { halign: 'right', cellWidth: 150 }


        //                },
        //                alternateRowStyles: {
        //                    fillColor: [248, 249, 250]
        //                },
        //                tableLineColor: [200, 200, 200],
        //                tableLineWidth: 0.5
        //            });
        //        }
        //        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '').replace('T', '_');
        //        const filename = 'Orders_Export_' + timestamp + '.pdf';
        //        doc.save(filename);
        //        // NO ALERT - Silent download
        //    } catch (error) {
        //        console.error('PDF Generation Error:', error);
        //        showToast('Error generating PDF: ' + error.message);
        //    }
        //}

        //function exportToPDF(selectedData) {
        //    if (typeof window.jspdf === 'undefined') {
        //        showToast('jsPDF library is not loaded');
        //        return;
        //    }
        //    var headers = getExportHeaders();
        //    try {
        //        const { jsPDF } = window.jspdf;
        //        const doc = new jsPDF({
        //            orientation: 'landscape',
        //            unit: 'pt',
        //            format: 'a4'
        //        });
        //        doc.setFont("helvetica");
        //        doc.setFontSize(22)// Larger font for main title
        //        doc.setTextColor(0, 0, 0); // Black header for Rahishop

        //        // Calculate center X for Rahishop
        //        var pageWidth = doc.internal.pageSize.getWidth();
        //        var rahishopTitle = "Rahishop";
        //        var titleWidth = doc.getTextWidth(rahishopTitle);
        //        var centerX = pageWidth / 2 - titleWidth / 2;
        //        doc.text(rahishopTitle, centerX, 40); // Centered at y=40

        //        // Add Orders Export Report subtitle (below Rahishop)
        //        doc.setFontSize(18);
        //        doc.setTextColor(0, 0, 0);
        //        var exportTitle = "Orders Management"
        //        var exportWidth = doc.getTextWidth(exportTitle);
        //        var exportCenterX = pageWidth / 2 - exportWidth / 2;
        //        doc.text(exportTitle, exportCenterX, 65); // Centered at y=65

        //        // Meta info below
        //        //var now = new Date();
        //        //doc.setFontSize(12);
        //        //doc.setTextColor(100, 100, 100);
        //        //doc.text("Generated on: " + now.toLocaleDateString() + ' at ' + now.toLocaleTimeString(), 40, 90);
        //        //doc.text("Total Records: " + selectedData.length, 40, 110);

        //        var now = new Date();
        //        doc.setFontSize(12);
        //        doc.setTextColor(100, 100, 100);

        //        // Get page width for right alignment
        //        var pageWidth = doc.internal.pageSize.getWidth();
        //        var rightMargin = 40; // Distance from right edge

        //        // Right-aligned text
        //        doc.text("Generated on: " + now.toLocaleDateString() + ' at ' + now.toLocaleTimeString(), pageWidth - rightMargin, 90, { align: 'right' });
        //        doc.text("Total Records: " + selectedData.length, pageWidth - rightMargin, 110, { align: 'right' });


        //        var tableData = selectedData.map(function (row) {
        //            var formattedRow = [...row];
        //            formattedRow[7] = formatIndianCurrency(row[7]);
        //            formattedRow[8] = formatIndianCurrency(row[8]);
        //            formattedRow[9] = formatIndianCurrency(row[9]);
        //            return formattedRow;
        //        });

        //        if (typeof doc.autoTable === 'function') {
        //            var marginLeft = 30;
        //            var marginRight = 30;
        //            var availableWidth = pageWidth - marginLeft - marginRight;
        //            doc.autoTable({
        //                head: [headers],
        //                body: tableData,
        //                startY: 135,
        //                tableWidth: availableWidth,
        //                margin: { left: marginLeft, right: marginRight },
        //                styles: {
        //                    fontSize: 9,
        //                    cellPadding: 4,
        //                    valign: 'middle',
        //                    overflow: 'linebreak'
        //                },
        //                headStyles: {
        //                    fillColor: [51, 122, 183],
        //                    textColor: 255,
        //                    fontSize: 10,
        //                    fontStyle: 'bold',
        //                    halign: 'center'
        //                },
        //                columnStyles: {
        //                    0: { halign: 'center', cellWidth: 35 },
        //                    1: { cellWidth: 85, halign: 'Center' },
        //                    2: { cellWidth: 65, halign: 'center' },
        //                    3: { cellWidth: 70, halign: 'center' },
        //                    4: { cellWidth: 60, halign: 'center' },
        //                    5: { cellWidth: 95, halign: 'Center' },
        //                    6: { halign: 'center', cellWidth: 70 },
        //                    7: { halign: 'Center', cellWidth: 75 },
        //                    8: { halign: 'Center', cellWidth: 100 },
        //                    9: { halign: 'Center', cellWidth: 130 }
        //                },
        //                alternateRowStyles: {
        //                    fillColor: [248, 249, 250]
        //                },
        //                tableLineColor: [200, 200, 200],
        //                tableLineWidth: 0.5
        //            });
        //        }
        //        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '').replace('T', '_');
        //        const filename = 'Orders_Export_' + timestamp + '.pdf';
        //        doc.save(filename);
        //        // NO ALERT - Silent download
        //    } catch (error) {
        //        console.error('PDF Generation Error:', error);
        //        showToast('Error generating PDF: ' + error.message);
        //    }
        //}

        function exportToPDF(selectedData) {
            if (typeof window.jspdf === 'undefined') {
                showToast('jsPDF library is not loaded');
                return;
            }
            var headers = getExportHeaders();
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'pt',
                    format: 'a4'
                });

                doc.setFont("helvetica");
                doc.setFontSize(22); // Larger font for main title
                doc.setTextColor(0, 0, 0); // Black header for Rahishop

                // Calculate center X for Rahishop
                var pageWidth = doc.internal.pageSize.getWidth();
                var rahishopTitle = "RahiShop";
                var titleWidth = doc.getTextWidth(rahishopTitle);
                var centerX = pageWidth / 2 - titleWidth / 2;
                doc.text(rahishopTitle, centerX, 40); // Centered at y=40

                // Add Orders Management subtitle (below RahiShop)
                doc.setFontSize(18);
                doc.setTextColor(0, 0, 0);
                var exportTitle = "Orders Management";
                var exportWidth = doc.getTextWidth(exportTitle);
                var exportCenterX = pageWidth / 2 - exportWidth / 2;
                doc.text(exportTitle, exportCenterX, 65); // Centered at y=65

                // === METADATA AT EXACT SAME LEVEL AS SUBTITLE (y=65) ===
                var now = new Date();
                doc.setFontSize(11); // Smaller font for metadata
                doc.setTextColor(100, 100, 100); // Gray color

                var rightMargin = 40; // Distance from right edge

                // Generated on - at EXACT same Y level as subtitle (65)
                doc.text("Generated on: " + now.toLocaleDateString() + " at " + now.toLocaleTimeString(),
                    pageWidth - rightMargin, 65, { align: 'right' });

                // Total Records - at same Y level but create a second line by adding line break
                doc.text("Total Records: " + selectedData.length,
                    pageWidth - rightMargin, 80, { align: 'right' });

                var tableData = selectedData.map(function (row) {
                    var formattedRow = [...row];
                    formattedRow[7] = formatIndianCurrency(row[7]);
                    formattedRow[8] = formatIndianCurrency(row[8]);
                    formattedRow[9] = formatIndianCurrency(row[9]);
                    return formattedRow;
                });

                if (typeof doc.autoTable === 'function') {
                    var marginLeft = 30;
                    var marginRight = 30;
                    var availableWidth = pageWidth - marginLeft - marginRight;
                    doc.autoTable({
                        head: [headers],
                        body: tableData,
                        startY: 100, // Start table after subtitle and metadata
                        tableWidth: availableWidth,
                        margin: { left: marginLeft, right: marginRight },
                        styles: {
                            fontSize: 9,
                            cellPadding: 4,
                            valign: 'middle',
                            overflow: 'linebreak'
                        },
                        headStyles: {
                            fillColor: [51, 122, 183],
                            textColor: 255,
                            fontSize: 10,
                            fontStyle: 'bold',
                            halign: 'center'
                        },
                        alternateRowStyles: {
                            fillColor: [248, 249, 250] // Light gray for alternate rows
                        },
                        bodyStyles: {
                            fillColor: [255, 255, 255] // Pure white for main rows
                        },
                        columnStyles: {
                            0: { halign: 'center', cellWidth: 35 },
                            1: { cellWidth: 85, halign: 'Center' },
                            2: { cellWidth: 65, halign: 'center' },
                            3: { cellWidth: 70, halign: 'center' },
                            4: { cellWidth: 60, halign: 'center' },
                            5: { cellWidth: 95, halign: 'Center' },
                            6: { halign: 'center', cellWidth: 70 },
                            7: { halign: 'Center', cellWidth: 75 },
                            8: { halign: 'Center', cellWidth: 100 },
                            9: { halign: 'Center', cellWidth: 160 }
                        },
                        alternateRowStyles: {
                            fillColor: [248, 249, 250]
                        },

                    });
                }

                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '').replace('T', '_');
                const filename = 'Orders_Export_' + timestamp + '.pdf';
                doc.save(filename);

            } catch (error) {
                console.error('PDF Generation Error:', error);
                showToast('Error generating PDF: ' + error.message);
            }
        }


        // Excel Export (silent - no alert)
        function exportToExcel(selectedData) {
            try {
                var headers = getExportHeaders();
                var excelContent = '<table border="1"><thead><tr>';
                headers.forEach(function (header) {
                    excelContent += '<th>' + header + '</th>';
                });
                excelContent += '</tr></thead><tbody>';
                selectedData.forEach(function (row) {
                    excelContent += '<tr>';
                    row.forEach(function (cell, index) {
                        if (index >= 7 && index <= 9) {
                            excelContent += '<td>' + formatIndianCurrency(cell) + '</td>';
                        } else {
                            excelContent += '<td>' + cell + '</td>';
                        }
                    });
                    excelContent += '</tr>';
                });
                excelContent += '</tbody></table>';
                var blob = new Blob([excelContent], { type: 'application/vnd.ms-excel' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'orders_export_' + new Date().getTime() + '.xls';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                // NO ALERT - Silent download
            } catch (error) {
                console.error('Excel Export Error:', error);
                showToast('Error exporting Excel file');
            }
        }

        // CSV Export (silent - no alert)
        function exportToCSV(selectedData) {
            try {
                var headers = getExportHeaders();
                var csvContent = headers.join(',') + '\n';
                selectedData.forEach(function (row) {
                    csvContent += row.map(function (cell, index) {
                        var formattedCell = (index >= 7 && index <= 9) ? formatIndianCurrency(cell) : cell;
                        return '"' + String(formattedCell).replace(/"/g, '""') + '"';
                    }).join(',') + '\n';
                });
                var blob = new Blob([csvContent], { type: 'text/csv' });
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'orders_export_' + new Date().getTime() + '.csv';
                a.click();
                window.URL.revokeObjectURL(url);
                // NO ALERT - Silent download
            } catch (error) {
                console.error('CSV Export Error:', error);
                showToast('Error exporting CSV file');
            }
        }

        // Print functionality (silent - no alert)
        function printData(selectedData) {
            try {
                var headers = getExportHeaders();
                var printContent = '<html><head><title>Orders Report</title>';
                printContent += '<style>';
                printContent += 'table{border-collapse:collapse;width:100%;margin-top:20px;}';
                printContent += 'th,td{border:1px solid #ddd;padding:8px;text-align:left;}';
                printContent += 'th{background-color:#f2f2f2;font-weight:bold;text-align:center;}';
                printContent += 'td:first-child{text-align:center;}';
                printContent += '.amount{text-align:right;font-weight:bold;color:grey;}';
                printContent += '@@media print{body{margin:0;}}';
                printContent += '</style>';
                printContent += '</head><body>';
                printContent += '<h2>Orders Report</h2>';
                printContent += '<p>Generated on: ' + new Date().toLocaleDateString() + ' | Total Records: ' + selectedData.length + '</p>';
                printContent += '<table><thead><tr>';
                headers.forEach(function (header) {
                    printContent += '<th>' + header + '</th>';
                });
                printContent += '</tr></thead><tbody>';
                selectedData.forEach(function (row) {
                    printContent += '<tr>';
                    row.forEach(function (cell, index) {
                        var className = (index >= 7) ? ' class="amount"' : '';
                        var formattedCell = (index >= 7) ? /*formatIndianCurrency*/(cell) : cell;
                        printContent += '<td' + className + '>' + formattedCell + '</td>';
                    });
                    printContent += '</tr>';
                });
                printContent += '</tbody></table></body></html>';
                var printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.print();
                printWindow.close();
                // NO ALERT - Silent print
            } catch (error) {
                console.error('Print Error:', error);
                showToast('Error opening print dialog');
            }
        }

        // Copy to clipboard (with alert as requested)
        function copyToClipboard(selectedData) {
            var headers = getExportHeaders();
            var copyText = headers.join('\t') + '\n';
            selectedData.forEach(function (row) {
                copyText += row.map(function (cell, index) {
                    return (index >= 7 && index <= 9) ? formatIndianCurrency(cell) : cell;
                }).join('\t') + '\n';
            });
            navigator.clipboard.writeText(copyText).then(function () {
                // KEEP ALERT FOR COPY ONLY
                alert('Data copied to clipboard! (' + selectedData.length + ' rows)');
            }).catch(function () {
                showToast('Copy failed. Please try again.');
            });
        }
    });

    // ===== Product name popover (no row resize) =====
    (function () {
        const SHORT_WORDS = 3; // 2 words हवे असतील तर 2 करा
        let $currentCell = null;

        // Single popover element appended to body
        const $popover = $('<div id="product-popover" class="product-popover"></div>').appendTo('body');

        function makeShort(text) {
            const parts = String(text).trim().split(/\s+/);
            return parts.length > SHORT_WORDS ? parts.slice(0, SHORT_WORDS).join(' ') + '…' : text;
        }

        function positionPopover($cell) {
            const off = $cell.offset();
            const top = off.top + $cell.outerHeight() + 6; // below cell
            const left = off.left;                         // align to cell left
            const width = $cell.outerWidth();          // cell width
            $popover.css({
                top,
                left,
                minWidth: width + 'px'  // popover किमान cell इतकं रुंद
            });
        }

        function showPopover($cell) {
            const full = $cell.data('full');
            $popover.text(full).show();
            positionPopover($cell);
            $cell.addClass('expanded').find('.product-toggle').text('-').attr('aria-expanded', 'true');
            $currentCell = $cell;
        }

        function hidePopover() {
            $popover.hide().text('');
            if ($currentCell) {
                const full = $currentCell.data('full');
                $currentCell.removeClass('expanded')
                    .find('.product-text').text(makeShort(full));
                $currentCell.find('.product-toggle').text('+').attr('aria-expanded', 'false');
            }
            $currentCell = null;
        }

        // Toggle via +/-
        $(document).on('click', '.product-toggle', function (e) {
            e.stopPropagation();
            const $cell = $(this).closest('.product-name');

            // If already open -> close
            if ($cell.is($currentCell)) { hidePopover(); return; }

            // Close any open one and open the new one
            hidePopover();
            // Keep cell text clamped; popover shows full text so row height stays same
            const full = $cell.data('full');
            $cell.find('.product-text').text(makeShort(full));
            showPopover($cell);
        });

        // Click anywhere outside => collapse
        $(document).on('click', function (e) {
            if (!$(e.target).closest('.product-popover, .product-name').length) hidePopover();
        });

        // Reposition on scroll/resize
        $(window).on('scroll resize', function () {
            if ($currentCell) positionPopover($currentCell);
        });

        // If you use DataTables, close popover on draw/page/search
        if ($.fn.DataTable) {
            $('#table1').on('draw.dt', function () { hidePopover(); });
        }
    })();
    $(function () {
        $('[data-bs-toggle="tooltip"]').tooltip();
    });

    //$(tr).find("td:not(.no-export)").each(function (tdIndex, td) {
    //    row.push($(td).text().trim());
    //});


    $(document).ready(function () {
        // Initialize tooltips for all elements
        function initTooltips() {
            $('[data-bs-toggle="tooltip"]').tooltip('dispose').tooltip();
        }

        // Initial tooltip setup
        initTooltips();

        // Reinitialize after DataTable operations
        if ($.fn.DataTable && $.fn.DataTable.isDataTable('#table1')) {
            $('#table1').on('draw.dt', function () {
                initTooltips();
            });
        }
    });

</script>

<style>
    .shipping-col {
        width: 25px !important; /* Try 60px, 80px, or 100px */
        text-align: center;
        white-space: nowrap; /* Prevent wrapping */
    }
    /* Make checkbox border black */
    #table1 input.form-check-input {
        border: 1px solid #000 !important; /* always black border */
        width: 14px; /* adjust size as needed */
        height: 14px; /* adjust size as needed */
        border-radius: 2px !important;
        margin: auto; /* horizontal center inside th */
        display: block;
    }

    #table1 th {
        justify-content: center; /* horizontal center */
        align-items: center; /* vertical center */
    }

    .orderdate {
        width: 70px !important; /* Try 60px, 80px, or 100px */
        text-align: center;
        white-space: nowrap; /* Prevent wrapping */
    }

    .status-col {
        width: 70px !important;
    }

    .Customer-col {
        width: 70px !important; /* Try 60px, 80px, or 100px */
    }

    table1 thead th {
        background-color: #2C3E50; /* Solid Navy */
        color: #FFFFFF; /* White text */
        font-weight: 600;
        text-align: center !important;
        padding: 5px;
        border-bottom: 2px solid #ddd;
        font-size: 14px; /* smaller text */
        height: 8px !important; /* fixed header height */
        font-family: 'Poppins', sans-serif; /* Added font */
        vertical-align: middle;
    }
    .Order-col {
        width: 70px !important;
    }

    .status-col {
        width: 70px !important; /* Try 60px, 80px, or 100px */
        text-align: center;
        white-space: nowrap;
    }





    /* Reduce header height */


    /* Reduce body row height */
    #table1 tbody td {
        padding: 2px 5px !important;
        height: 5px !important;
        line-height: 1;
        font-size: 13px;
        text-align: center;
        font-family: 'Poppins', sans-serif; /* Added font */
        vertical-align: middle;
    }


    /* Hover effect for action buttons - dark grey version */
    /*.view-details:hover, .view-invoice:hover {
        transform: scale(1.1);*/ /* Slight zoom */
    /*transition: all 0.2s ease;
        background-color: #333333;*/ /* Dark grey background */
    /*color: #ffffff;*/ /* White icon/text */
    /*}

    .view-details i, .view-invoice i {
        transition: all 0.2s ease;
        color: inherit;*/ /* Inherits the white color from parent on hover */
    /*}*/


</style>

@*<style>
        /* .export-controls {
         background-color: white;
         padding: 10px;
         border-radius: 5px;
         border: 1px solid #dee2e6;
     }*/
        .export-btn {
            min-width: 40px;
            height: 35px;
        }

        .export-icon {
            width: 16px;
            height: 16px;
            object-fit: contain;
        }

        /* Remove sort arrows from checkbox column header */
        table.dataTable thead th:first-child::after,
        table.dataTable thead th:first-child::before {
            display: none !important;
        }

        /* Make checkbox column header not show hover cursor for sorting */
        table.dataTable thead th:first-child {
            cursor: default !important;
        }

        #selectAll:indeterminate {
            opacity: 0.5;
        }

        .selected-row {
            background-color: #d1ecf1 !important;
        }
        /* Toast CSS - Positioned 60px below top */
        .toast {
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            border-radius: 8px !important;
        }

        .toast-body {
            font-weight: 500;
            padding: 12px 16px;
        }
        /* Product column clamp */
        .product-name {
            max-width: 220px; /* table spread थांबवायला */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .product-text {
            vertical-align: middle;
        }

        .product-toggle {
            margin-left: 6px;
            padding: 0 6px;
            border: none;
            background: transparent;
            font-weight: 700;
            cursor: pointer;


            line-height: 1;
            color: #198754; /* green-ish */
        }
        /* Floating popover (outside table, row height बदलत नाही) */
        .product-popover {
            position: absolute;
            z-index: 1080;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: .375rem;
            padding: 8px 10px;
            max-width: 60vw; /* मोठं नाव wrap होईल */
            box-shadow: 0 6px 16px rgba(0,0,0,.12);
            white-space: normal;
            display: none;
        }
        /* Product Name column fix */
        table.dataTable td.product-name {
            max-width: 160px; /* तुझ्या table साठी 120–160px try कर */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>*@



