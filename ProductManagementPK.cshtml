@{
    ViewBag.Title = "Product Management";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Breadcrumb {
    
    <li class="breadcrumb-item">
        <a href="#">Product Management</a>
    </li>
    <li class="breadcrumb-item active" aria-current="page" id="dynamicBreadcrumb">
        All Products
    </li>
}



<div class="main-content">
    <section class="section">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <!-- Tabs -->
                    <ul class="nav nav-pills nav-justified mb-3" id="productTabs">
                        <li class="nav-item">
                            <a id="all-products-tab" href="#navpills-1" class="nav-link active" data-bs-toggle="tab">All Products</a>
                        </li>
                        <li class="nav-item">
                            <a id="rejected-products-tab" href="#navpills-2" class="nav-link" data-bs-toggle="tab">Rejected Products</a>
                        </li>
                    </ul>

                    <!-- Dynamic Content -->
                    <div id="productTabContent" class="mt-3">
                        <div class="text-center mt-5">
                            <strong>Loading...</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

@section Styles {
    <link href="~/Content/Document/CSS/TabletheadProduct.css" rel="stylesheet" />
    <!-- DataTables Bootstrap 5 CSS -->
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
    <!-- Daterangepicker CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker@3.1/daterangepicker.css" />
    <!-- Custom CSS -->
    <link href="~/Content/Document/CSS/PDFPK.css" rel="stylesheet" />
}

@*<style>
        .custom-modal-height {
            max-height: 300px !important;
        }

        #productDetailsModal .modal-body {
            padding: 3px !important;
            font-size: 0.6rem !important;
        }
    </style>*@

<!-- Product Details Modal -->
<div class="modal fade" id="productDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header text-white" style="background: #2C3E50;">
                <h5 class="modal-title" id="productDetailsLabel"> Product Details </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" id="productDetailsBody">
                Partial view will load here
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/min/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker@3.1/daterangepicker.min.js"></script>
    <script src="~/Content/Document/CustomJS/jspdf.umd.min.js"></script>
    <script src="~/Content/Document/CustomJS/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Global variable for DataTable
        var productDataTable;

        // Improved date parsing function
        function parseDate(dateStr) {
            if (!dateStr) return null;

            var dateFormats = [
                'DD-MM-YYYY',
                'DD/MM/YYYY',
                'MM-DD-YYYY',
                'MM/DD/YYYY',
                'YYYY-MM-DD'
            ];

            for (var i = 0; i < dateFormats.length; i++) {
                var date = moment(dateStr, dateFormats[i], true);
                if (date.isValid()) {
                    return date.toDate();
                }
            }

            return null;
        }

        // Custom date range filtering function for DataTables
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                var tableId = settings.nTable.id;
                if (!tableId || tableId !== 'productTable') {
                    return true;
                }

                var dateRange = $('#dateRangeFilter').val();
                if (!dateRange) {
                    return true;
                }

                var dates = dateRange.split(' - ');
                if (dates.length !== 2) {
                    return true;
                }

                var startDate = moment(dates[0], 'DD/MM/YYYY').startOf('day').toDate();
                var endDate = moment(dates[1], 'DD/MM/YYYY').endOf('day').toDate();

                var dateColumnIndex = 6;
                var rowDateStr = data[dateColumnIndex];
                var rowDate = parseDate(rowDateStr.trim());

                if (!rowDate) {
                    return false;
                }

                return (rowDate >= startDate && rowDate <= endDate);
            }
        );

        $(document).ready(function () {
            // Load initial tab
            loadTab("AllProducts");

            $("#all-products-tab").click(function (e) {
                e.preventDefault();
                loadTab("AllProducts");
                $(".nav-link").removeClass("active");
                $(this).addClass("active");
            });

            $("#rejected-products-tab").click(function (e) {
                e.preventDefault();
                loadTab("RejectedProducts");
                $(".nav-link").removeClass("active");
                $(this).addClass("active");
            });

            function loadTab(tab) {
                $("#productTabContent").html('<div class="text-center mt-5"><strong>Loading...</strong></div>');
                let url = "";

                if (tab === "AllProducts") {
                    url = '@Url.Action("LoadAllProductsPK", "Admin")';
                } else if (tab === "RejectedProducts") {
                    url = '@Url.Action("LoadRejectedProductsPK", "Admin")';
                }

                $.get(url, function (data) {
                    $("#productTabContent").html(data);
                    setTimeout(function () {
                        if ($.fn.DataTable.isDataTable('#productTable')) {
                            $('#productTable').DataTable().destroy();
                        }

                        productDataTable = $('#productTable').DataTable({
                            responsive: true,
                            searching: true,
                            paging: true,
                            ordering: false,
                            info: true,
                            lengthChange: true,
                            pageLength: 10,
                            destroy: true
                        });

                        // Initialize date range picker only if it exists (Rejected Products tab)
                        if ($('#dateRangeFilter').length) {
                            $('#dateRangeFilter').daterangepicker({
                                opens: 'right',
                                locale: {
                                    format: 'DD/MM/YYYY',
                                    separator: ' - ',
                                    applyLabel: 'Apply',
                                    cancelLabel: 'Clear',
                                    daysOfWeek: ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'],
                                    monthNames: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
                                },
                                autoUpdateInput: false,
                                showDropdowns: true,
                                minYear: 2020,
                                maxYear: parseInt(moment().format('YYYY')) + 1
                            });

                            $('#dateRangeFilter').on('apply.daterangepicker', function(ev, picker) {
                                $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
                                if (productDataTable) {
                                    productDataTable.draw();
                                }
                            });

                            $('#dateRangeFilter').on('cancel.daterangepicker', function(ev, picker) {
                                $(this).val('');
                                if (productDataTable) {
                                    productDataTable.draw();
                                }
                            });
                        }
                    }, 100);
                });
            }
        });

        // Approve product function
        $(document).on("click", ".approve-product", function () {
            var productCode = $(this).data("productcode");
            var $button = $(this);
            var $row = $button.closest("tr");

            Swal.fire({
                title: "Approve Product?",
                text: "Do you want to approve this product?",
                icon: "question",
                showCancelButton: true,
                confirmButtonColor: "#198754",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, approve it!"
            }).then((result) => {
                if (result.isConfirmed) {
                    $row.fadeOut(500, function () {
                        $(this).remove();
                        if ($("#productTable tbody tr").length === 0) {
                            $("#productTable tbody").html('<tr><td colspan="100%" class="text-center">No products found</td></tr>');
                        }
                    });

                    $.ajax({
                        url: '/Admin/ApproveProductPK',
                        type: 'POST',
                        data: { productCode: productCode },
                        success: function (response) {},
                        error: function (xhr, status, error) {}
                    });
                }
            });
        });

        // Show product details function
        function showDetails(productCode) {
            $('#productDetailsBody').html('<div class="text-center p-4"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading product details...</p></div>');
            $('#productDetailsModal').modal('show');

            $.ajax({
                url: '/Admin/GetProductDetailsPartialPK',
                type: 'GET',
                data: { productCode: productCode },
                timeout: 10000,
                success: function (html) {
                    $('#productDetailsBody').html(html);
                },
                error: function (xhr, status, error) {
                    var errorHtml = '<div class="alert alert-danger text-center">' +
                        '<i class="fas fa-exclamation-triangle fa-2x mb-3"></i>' +
                        '<h5>Unable to Load Product Details</h5>' +
                        '<p>Product Code: <strong>' + productCode + '</strong></p>' +
                        '<p class="mb-0">Please try again or contact support if the problem persists.</p>' +
                        '</div>';
                    $('#productDetailsBody').html(errorHtml);
                }
            });
        }

        // Delete product function
        @*$(document).on("click", ".delete-product", function () {
            var productCode = $(this).data("productcode");
            var $button = $(this);
            var $row = $button.closest("tr");

            Swal.fire({
                title: "Are you sure?",
                text: "This product will be permanently deleted!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#d33",
                cancelButtonColor: "#3085d6",
                confirmButtonText: "Yes, delete it!"
            }).then((result) => {
                if (result.isConfirmed) {
                    $row.fadeOut(500, function () {
                        $(this).remove();
                        if ($("#productTable tbody tr").length === 0) {
                            $("#productTable tbody").html('<tr><td colspan="100%" class="text-center">No products found</td></tr>');
                        }
                    });

                    $.ajax({
                        url: '@Url.Action("DeleteProductByCodePK", "Admin")',
                        type: "POST",
                        data: { productCode: productCode },
                        success: function (response) {},
                        error: function () {}
                    });
                }
            });
        });*@


        // ✅ Dynamic breadcrumb updater
        $(document).ready(function () {
            $('#productTabs a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
                var targetId = $(e.target).attr('id');
                var breadcrumbText = '';

                if (targetId === 'all-products-tab') {
                    breadcrumbText = 'All Products';
                } else if (targetId === 'rejected-products-tab') {
                    breadcrumbText = 'Rejected Products';
                }

                $('#dynamicBreadcrumb').text(breadcrumbText);

                // Optional smooth scroll to tab top
                $('html, body').animate({
                    scrollTop: $("#productTabs").offset().top - 80
                }, 300);
            });
        });

    </script>
}