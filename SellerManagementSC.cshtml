@model List<GSTECommerceLibrary.Admin.Admin>

@{
    ViewBag.Title = "SellerManagementSC";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


@section Breadcrumb {
    <li class="breadcrumb-item active" aria-current="page">
        Seller Management
    </li>
}
<section class="section">
    @*<div class="card">*@
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- DataTables Buttons CSS -->
    <link href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.bootstrap5.min.css" rel="stylesheet" />
    <!-- DataTables CSS (Bootstrap 5 style) -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />



    <link href="~/Content/Document/CSS/SellermanagementMainSc.css" rel="stylesheet" />


    <link href="~/Content/Document/CSS/SellerDetailsPartialSC.css" rel="stylesheet" />

    @{
        var summary = (GSTECommerceLibrary.Admin.Admin)ViewBag.Summary;
    }

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5>Total Seller</h5>
                    <h3>@summary.TotalSeller</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5>Active Seller</h5>
                    <h3>@summary.ActiveSeller</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5>InActive Seller</h5>
                    <h3>@summary.InactiveSeller</h3>
                </div>
            </div>
        </div>
    </div>

    @*<div class="card-header">
            Seller Management
        </div>*@

    @*<div class="card-body">
        <div class="controls-container mb-3">
            <div>
                <span id="selectedCount" class="selected-count"></span>
            </div>
        </div>*@

    <div class="row mb-3 d-flex justify-content-between align-items-center">
        <!-- Left side: Status Filter -->
        <div class="col-md-3">
            <select id="statusFilter" class="form-select">
                <option value="">Total Sellers</option>
                <option value="1">Active</option>
                <option value="2">Inactive</option>
            </select>
        </div>

        <!-- Right side: Export Buttons will be injected here -->
        <div class="col-md-6 d-flex justify-content-end gap-2 mt-3" id="exportButtons"></div>
    </div>


    <table class="table table-striped table-bordered" id="table1">
        <thead>
            <tr>
                <th><input type="checkbox" class="select-checkbox" id="selectAllCheckbox"></th>
                <th>Sr No</th>
                <th>Seller Name</th>
                <th>Email</th>
                <th>Business Name</th>
                <th>Mobile No</th>
                <th>GSTIN</th>
                <th>Action</th>
                <th style="display:none;">StatusId</th> <!-- ✅ hidden -->
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {

                <tr>
                    <td><input type="checkbox" class="select-checkbox row-checkbox"></td>
                    <td></td>
                    <td>@item.SellerName</td>
                    <td>@item.Email</td>
                    <td>@item.BusinessName</td>
                    <td>@($"+91 {item.MobileNo}")</td>
                    <td>@item.GSTIN</td>
                    <td>
                        <div class="d-flex justify-content-center align-items-center gap-3">
                            <a href="javascript:void(0);"
                               style="font-size: 1.2rem; color: black;"
                               onclick="loadSellerDetails('@item.Email')"
                               title="View Seller Details">
                                <i class="bi bi-eye"></i>
                            </a>

                            @*<span class="badge bg-secondary" style="display: none;">@item.ClientCode</span>*@
                            <a href="javascript:void(0);"
                               onclick="loadSellerProducts('@item.ClientCode')"
                               title="View Products"
                               style="font-size: 1.2rem; color: black; text-decoration: none; cursor: pointer;">
                                <i class="fa-solid fa-cart-shopping"></i>
                            </a>


                            @*<a href="@Url.Action("DeleteSellerSC", "Admin", new { email = item.Email })"
                                style="font-size: 1.2rem;"

                                  onclick="return confirmDeleteSeller('@item.Email');">
                                <i class="bi bi-trash"></i>
                                  </a>*@
                        </div>


                    </td>
                    <td style="display:none;">@item.StatusId</td>
                </tr>
            }
        </tbody>
    </table>



    <div class="position-fixed end-0 p-3" style="z-index: 11; top: 80px;">
        <div id="liveToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <span id="toastMessage"></span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="sellerDetailModal" tabindex="-1" role="dialog" aria-labelledby="sellerDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header text-white" style="background: #2C3E50;">
                    <h5 class="modal-title">Seller Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body" id="sellerDetailContent"></div>
            </div>
        </div>
    </div>

    <!-- Product Details Modal -->
    <div class="modal fade" id="productDetailModal" tabindex="-1" role="dialog" aria-labelledby="productDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header text-white" style="background: #2C3E50;">
                    <h5 class="modal-title"> Seller Product List</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="productDetailContent"></div>
            </div>
        </div>
    </div>
    @*</div>*@
    @*</div>*@
</section>


@section Scripts {
    <!-- jQuery (required by DataTables) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <!-- DataTables Buttons JS -->
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.bootstrap5.min.js"></script>

    <!-- Downloaded CDN  -->
    <script src="~/Content/Document/CustomJS/buttons.html5.min.js"></script>
    <script src="~/Content/Document/CustomJS/buttons.print.min.js"></script>
    <script src="~/Content/Document/CustomJS/jszip.min.js"></script>
    <script src="~/Content/Document/CustomJS/pdfmake.min.js"></script>
    <script src="~/Content/Document/CustomJS/vfs_fonts.js"></script>



    <script>

        // Toast notification functions
        function showErrorToast(message) {
            $('#toastMessage').text(message);
            $('#liveToast').removeClass('bg-success').addClass('bg-danger');
            var toastEl = document.getElementById('liveToast');
            var toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        ////function showSuccessToast(message) {
        ////    $('#toastMessage').text(message);
        ////    $('#liveToast').removeClass('bg-danger').addClass('bg-success');
        ////    var toastEl = document.getElementById('liveToast');
        ////    var toast = new bootstrap.Toast(toastEl);
        ////    toast.show();
        ////}

        // Custom delete confirmation with toast
        $(document).on("click", ".delete-seller", function () {
    var email = $(this).data("email");

    // SweetAlert2 confirmation
    Swal.fire({
        title: 'Are you sure?',
        text: "Do you really want to delete this seller?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            // Call AJAX if confirmed
            $.ajax({
                url: '/Admin/DeleteSellerSC',
                type: 'POST',
                data: { email: email },
                success: function (res) {
                    if (res.success) {
                        // ✅ Success Toast
                        Swal.fire({
                            icon: 'success',
                            title: 'Deleted!',
                            text: res.message,
                            timer: 2000,
                            showConfirmButton: false
                        });

                        // Reload page after toast
                        setTimeout(function () {
                            location.reload();
                        }, 2000);
                    } else {
                        // ❌ Fail Toast
                        Swal.fire({
                            icon: 'error',
                            title: 'Failed',
                            text: res.message
                        });
                    }
                },
                error: function () {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Something went wrong while deleting seller.'
                    });
                }
            });
        }
    });
});

        let table;
        let selectedRows = new Set();

        $(document).ready(function () {
            table = $('#table1').DataTable({
                responsive: true,
                searching: true,
                paging: true,
                ordering: false,
                info: true,
                lengthChange: false,
                pageLength: 10,
                destroy: true,
                autoWidth: false,
                scrollX: false,
                lengthMenu: [5, 10, 25, 50, 100],
                language: {
                    search: "Search:",
                    searchPlaceholder: "Type to search"
                },
                "dom": `
    <"top d-flex justify-content-between"
        <"float-start"l>
        <"d-flex flex-column align-items-end"
            <"mb-2"B>
            f
        >
    >
     rt
    <"bottom d-flex justify-content-between"
        i
        <"d-flex justify-content-end"p>
    >
`,
                "columnDefs": [
                    {
                        "targets": 0, // Checkbox column
                        "orderable": false,
                        "searchable": false
                    },
                    {
                        "targets": 1, // Sr No column
                        "orderable": false,
                        "searchable": false,
                        "render": function (data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    {
                        "targets": 2, // SellerName column
                        "render": function (data, type, row) {
                            return data; // Always return the actual name
                        }
                    },
                    {
                        "targets": 7, // Action column
                        "orderable": false,
                        "searchable": false
                    },
                    {
                        "targets": 8, // StatusId column
                        "visible": false,
                        "searchable": true
                    }

                ],
                "buttons": [
                    {
                        extend: 'copy',
                        text: '<img src="/Content/Document/Image/Copy.png" style="width:16px; height:16px;" />',
                        attr: { title: 'Copy to clipboard' },
                        /* className: 'buttons-copy',*/
                        action: function (e, dt, button, config) {
                            if ($('.row-checkbox:checked').length === 0) {
                                showErrorToast('Please select at least one row to export.');
                                return;
                            }
                            $.fn.dataTable.ext.buttons.copyHtml5.action.call(this, e, dt, button, config);
                            // showSuccessToast('Data copied to clipboard');
                        },
                        exportOptions: {
                            columns: function (idx, data, node) {
                                return ![0, 7, 8].includes(idx); // unwanted columns exclude
                            },
                            rows: function (idx, data, node) {
                                return $(node).find('.row-checkbox').is(':checked'); // only selected rows
                            },
                            format: {
                                body: (function () {
                                    let srNoCounter = 0; // counter reset for each copy action
                                    return function (data, row, column, node) {
                                        if (column === 0) {
                                            srNoCounter++;
                                            return srNoCounter; // always sequential 1,2,3...
                                        }
                                        return data; // return other column values as-is
                                    };
                                })()
                            }
                        }
                    },
                    
                    {
                        extend: 'csv',
                        text: '<img src="/Content/Document/Image/CSV.png" style="width:16px; height:16px;" />',
                        attr: { title: 'Export as CSV file' },
                        /*className: 'buttons-csv',*/
                        action: function (e, dt, button, config) {
                            if ($('.row-checkbox:checked').length === 0) {
                                showErrorToast('Please select at least one row to export.');
                                return;
                            }
                            $.fn.dataTable.ext.buttons.csvHtml5.action.call(this, e, dt, button, config);
                           // showSuccessToast('CSV export started');
                        },
                        filename: 'Seller_Management_' + new Date().toISOString().slice(0, 10),
                        exportOptions: {
                            columns: function (idx, data, node) {
                                return ![0, 7, 8].includes(idx); // exclude unwanted columns
                            },
                            rows: function (idx, data, node) {
                                return $(node).find('.row-checkbox').is(':checked'); // only selected rows
                            },
                            format: {
                                body: (function () {
                                    // CSV export sequence counter
                                    let srNoCounter = 0;
                                    return function (data, row, column, node) {
                                        if (column === 0) {
                                            srNoCounter++;
                                            return srNoCounter; // Always 1,2,3… for selected rows
                                        }
                                        return data;
                                    };
                                })()
                            }
                        }
                    },

                    {
                        extend: 'excel',
                        text: '<img src="/Content/Document/Image/XLS.png" style="width:16px; height:16px;" />',
                        attr: { title: 'Export as Excel file' },
                        /*className: 'buttons-excel',*/
                        action: function (e, dt, button, config) {
                            if ($('.row-checkbox:checked').length === 0) {
                                showErrorToast('Please select at least one row to export.');
                                return;
                            }
                            $.fn.dataTable.ext.buttons.excelHtml5.action.call(this, e, dt, button, config);
                            //showSuccessToast('Excel export started');
                        },
                        filename: 'Seller_Management_' + new Date().toISOString().slice(0, 10),
                        title: 'Seller Management',
                        exportOptions: {
                            columns: function (idx, data, node) {
                                return ![0, 7, 8].includes(idx); // exclude unwanted columns
                            },
                            rows: function (idx, data, node) {
                                return $(node).find('.row-checkbox').is(':checked'); // only selected rows
                            },
                            format: {
                                body: (function () {
                                    // Create a map for Sr. No. sequence
                                    let srNoCounter = 0;
                                    return function (data, row, column, node) {
                                        if (column === 0) {
                                            // Increment only when exporting
                                            srNoCounter++;
                                            return srNoCounter;
                                        }
                                        return data;
                                    };
                                })()
                            }
                        }
                    },


                    {
                        extend: 'pdf',
                        text: '<img src="/Content/Document/Image/PDFicon.png" style="width:16px; height:16px;" />',
                        attr: { title: 'Export as PDF' },
                       /* className: 'buttons-pdf',*/
                        action: function (e, dt, button, config) {
                            if ($('.row-checkbox:checked').length === 0) {
                                showErrorToast('Please select at least one row to export.');
                                return;
                            }
                            $.fn.dataTable.ext.buttons.pdfHtml5.action.call(this, e, dt, button, config);
                           // showSuccessToast('PDF export started');
                        },
                        filename: 'Seller_Management_' + new Date().toISOString().slice(0, 10),
                        title: 'Seller Management Report',
                        orientation: 'landscape',
                        pageSize: 'A4',
                        exportOptions: {
                            columns: function (idx, data, node) {
                                return ![0, 7, 8].includes(idx);
                            },
                            rows: function (idx, data, node) {
                                return $(node).find('.row-checkbox').is(':checked');
                            },
                            format: {
                                body: function (data, row, column, node) {
                                    if (column === 0) {
                                        const checkedRows = $('#table1 tbody tr').filter(function () {
                                            return $(this).find('.row-checkbox').is(':checked');
                                        });
                                        return checkedRows.index(node.parentNode) + 1;
                                    }
                                    return data;
                                }
                            }

                        },
                        customize: function (doc, config) {
                            // Remove default title
                            doc.content.splice(0, 1);

                            // ✅ Get DataTable reference
                            var dt = $('#table1').DataTable();

                            // ✅ Generated date
                            let now = new Date();
                            let dateStr = now.getFullYear() + '-' +
                                String(now.getMonth() + 1).padStart(2, '0') + '-' +
                                String(now.getDate()).padStart(2, '0') + ' ' +
                                String(now.getHours()).padStart(2, '0') + ':' +
                                String(now.getMinutes()).padStart(2, '0') + ':' +
                                String(now.getSeconds()).padStart(2, '0');


                            // ✅ Total selected rows across all pages
                            let totalRecords = dt.rows().nodes().to$()
                                .find('.row-checkbox:checked').length;

                            // ✅ Custom header
                            doc.content.unshift({
                                margin: [0, 0, 0, 12],
                                stack: [
                                    {
                                        text: 'Rahishop',
                                        fontSize: 16,
                                        bold: true,
                                        alignment: 'center',
                                        margin: [0, 0, 0, 4]
                                    },
                                    {
                                        columns: [
                                            {
                                                text: 'Seller Management List',
                                                fontSize: 12,
                                                alignment: 'center',   // Center subtitle
                                                margin: [0, 0, 0, 6]
                                            },
                                            {
                                                stack: [
                                                    { text: 'Generated On: ' + dateStr, fontSize: 8, alignment: 'right' },
                                                    { text: 'Total Records: ' + totalRecords, fontSize: 8, alignment: 'right' }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            });

                            // ✅ Find table dynamically & add serial numbers only for selected rows
                            let tableNode = doc.content.find(node => node.table);
                            if (tableNode) {
                                let serialNumber = 1;
                                tableNode.table.body.forEach(function (row, i) {
                                    if (i > 0) row[0] = serialNumber++;
                                });

                                // Column widths
                                tableNode.table.widths = ['10%', '15%', '25%', '15%', '15%', '20%'];
                            }

                            // ✅ Styles
                            doc.styles.tableHeader = {
                                fillColor: '#007bff',
                                color: 'white',
                                alignment: 'center',
                                fontSize: 10,
                                bold: true
                            };
                            doc.defaultStyle.fontSize = 8;
                        }
                    },

                    {
                        extend: 'print',
                        text: '<img src="/Content/Document/Image/Print.png" style="width:16px; height:16px;" />',
                        attr: { title: 'Print' },
                        /*className: 'buttons-print',*/
                        action: function (e, dt, button, config) {
                            if ($('.row-checkbox:checked').length === 0) {
                                showErrorToast('Please select at least one row to export.');
                                return;
                            }
                            $.fn.dataTable.ext.buttons.print.action.call(this, e, dt, button, config);
                            //showSuccessToast('Print dialog opened');
                        },
                        title: 'Seller Management',
                        exportOptions: {
                            columns: function (idx, data, node) {
                                // Exclude checkbox col(0), action col(7), hidden col(8)
                                return ![0, 7, 8].includes(idx);
                            },
                            rows: function (idx, data, node) {
                                return $(node).find('.row-checkbox').is(':checked'); // only selected rows
                            },
                            format: {
                                body: (function () {
                                    let srNoCounter = 0; // reset counter
                                    return function (data, row, column, node) {
                                        if (column === 0) {
                                            srNoCounter++;
                                            return srNoCounter; // Sr. No. always 1,2,3...
                                        }
                                        return data;
                                    };
                                })()
                            }
                        },

                        customize: function (win) {
                            $(win.document.body)
                                .css('font-size', '10pt')
                                .prepend(
                                    '<div style="text-align:center; margin-bottom: 20px;"><h2>Seller Management</h2><p>Generated on: ' + new Date().toLocaleDateString() + '</p></div>'
                                );

                            var $table = $(win.document.body).find('table')
                                .addClass('compact')
                                .css('font-size', '9pt');

                            var serial = 1;
                            $table.find('tbody tr').each(function () {
                                if ($(this).find('.row-checkbox').is(':checked')) {
                                    $(this).find('td:nth-child(2)').text(serial++);
                                }
                            });
                        }
                    }
                ]
            });
            // 🔹 Custom Status Filter
            $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                var selectedStatus = $('#statusFilter').val();
                var rowStatus = data[8]; // StatusId column (hidden)

                if (selectedStatus === "" || rowStatus == selectedStatus) {
                    return true;
                }
                return false;
            });

            // 🔹 Dropdown change event
            $('#statusFilter').on('change', function () {
                table.draw();
            });


            // Update serial numbers when filtering/sorting
            table.on('draw.dt', function () {
                table.column(1, { search: 'applied', order: 'applied' }).nodes().each(function (cell, i) {
                    cell.innerHTML = i + 1;
                });
            });

            table.buttons().container().appendTo('#exportButtons');

            // Force transparent buttons styling with blue border + radius + spacing
            function forceTransparentButtons() {
                $('.dt-buttons button, .dt-buttons a').each(function () {
                    $(this).removeClass('btn-secondary btn-primary btn-success btn-info btn-warning btn-danger');

                    this.style.setProperty('background', 'transparent', 'important');
                    this.style.setProperty('background-color', 'transparent', 'important');
                    this.style.setProperty('background-image', 'none', 'important');

                    // 🔵 Blue border
                    this.style.setProperty('border', '1px solid #007bff', 'important');

                    // Keep text black
                    this.style.setProperty('color', '#212529', 'important');

                    // No shadow
                    this.style.setProperty('box-shadow', 'none', 'important');

                    // ➡️ Add spacing between buttons
                    this.style.setProperty('margin-right', '8px', 'important');

                    // 🔄 Rounded corners
                    this.style.setProperty('border-radius', '6px', 'important');
                });
            }


            forceTransparentButtons();
            setTimeout(forceTransparentButtons, 100);
            setTimeout(forceTransparentButtons, 500);
            setTimeout(forceTransparentButtons, 1000);

            // Select All checkbox functionality
            $('#selectAllCheckbox').on('change', function () {
                const isChecked = $(this).is(':checked');
                table.$('.row-checkbox').prop('checked', isChecked);

                if (isChecked) {
                    table.rows().every(function () {
                        const node = this.node();
                        selectedRows.add(node);
                    });
                } else {
                    selectedRows.clear();
                }

               // updateRowStyles();
             updateSelectedCount();
            });

            // Row checkbox functionality
            $(document).on('change', '.row-checkbox', function () {
                const $row = $(this).closest('tr');

                if ($(this).is(':checked')) {
                    selectedRows.add($row[0]);
                } else {
                    selectedRows.delete($row[0]);
                }

               // updateRowStyles();
                updateSelectAllCheckbox();
              updateSelectedCount();
            });



            function updateSelectAllCheckbox() {
                const totalRows = table.rows().count();
                const selectedCount = selectedRows.size;

                if (selectedCount === 0) {
                    $('#selectAllCheckbox').prop('indeterminate', false).prop('checked', false);
                } else if (selectedCount === totalRows) {
                    $('#selectAllCheckbox').prop('indeterminate', false).prop('checked', true);
                } else {
                    $('#selectAllCheckbox').prop('indeterminate', true);
                }
            }


        });

        function showLoader() { $('#globalLoader').fadeIn(200); }
        function hideLoader() { $('#globalLoader').fadeOut(200); }

        function loadSellerDetails(email) {
            showLoader();
    $.ajax({
        url: '@Url.Action("SellerDetailsPartialSC", "Admin")',
        type: 'GET',
        data: { email: email },
        success: function (data) {
            $("#sellerDetailContent").html(data);
            $("#sellerDetailModal").modal("show");
            hideLoader();
        },
        error: function () {
            console.error("Failed to load seller details.");
            hideLoader();
        }
    });
}



    function loadSellerProducts(clientCode) {
    console.log("Loading products for client:", clientCode);

    if (!clientCode || clientCode.trim() === "") {
        console.error("No seller selected");
        return;
    }

    $("#productDetailContent").html(`
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading products for seller ${clientCode}...</p>
        </div>
    `);

        $("#productDetailModal").modal("show");
        showLoader();

    $.ajax({
        url: '@Url.Action("SellerProductsPartialSC", "Admin")',
        type: 'GET',
        data: { clientCode: clientCode },
        success: function (data) {
            $("#productDetailContent").html(data);

            // Initialize DataTable after content is loaded and modal is shown
            setTimeout(function() {
                if (typeof initializePartialDataTable === 'function') {
                    initializePartialDataTable();
                } else {
                    // Fallback: trigger custom event to initialize DataTable
                    $(document).trigger('initializeDataTable');
                }
            }, 100);
            hideLoader();
        },
        error: function (xhr, status, error) {
            $("#productDetailContent").html(`
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i> Error loading products: ${error}
                    <div class="mt-2">ClientCode: ${clientCode}</div>
                </div>
            `);
            console.error("Error loading products:", { status: status, error: error });
            hideLoader();
        }
    });
}


    </script>
}